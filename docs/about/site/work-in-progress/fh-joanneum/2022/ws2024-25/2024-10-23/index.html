<!DOCTYPE html>

<html lang="en" data-content_root="../../../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>2024-10-23(6): Project: Linux I2C/PWM/SPI &#8212; Jörg Faschingbauer</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/alabaster.css?v=cf071e93" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/jupyter-sphinx.css?v=572af1d6" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/css/jf-alabaster.css?v=70eaaddc" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/css/lightbox.css?v=5c84f910" />
    <script src="../../../../../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../../../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/js/lightbox-plus-jquery.min.js?v=ffc8af2d"></script>
    <script src="../../../../../../../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js?v=12818e64"></script>
    <link rel="canonical" href="https://www.faschingbauer.me/about/site/work-in-progress/fh-joanneum/2022/ws2024-25/2024-10-23/index.html" />
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" />
    <link rel="next" title="Yocto" href="../../../../yocto/index.html" />
    <link rel="prev" title="2024-10-08(6): Project/Peripherals/Cross" href="../2024-10-08/index.html" />

   
  <link rel="stylesheet" href="../../../../../../../_static/custom.css" type="text/css" />
  

  
  


<link
  rel="alternate"
  type="application/atom+xml"
  href="../../../../../../../blog/atom.xml"
  title="Jörg Faschingbauer"
/>


<link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet"/>


  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../../../../../index.html">
    <img class="logo" src="../../../../../../../_static/logo.png" alt="Logo" />
    
  </a>
</p>



<p class="blurb">Programming Linux</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Courses</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../trainings/index.html">Courses Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../trainings/material/soup/index.html">Slide Material</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../trainings/booking.html">How To Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../trainings/log/index.html">Log Of Past Courses</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../../../myself/index.html">Myself: Contact, Impressum, …</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../../index.html">This Site</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../../opentraining/index.html">OpenTraining</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../../index.html">Work in Progress</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../../../index.html">Embedded Computing (FH Joanneum Graz)</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../../../dtle/index.html">Design Tools And Laboratory Engineering (2024)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../2019/index.html">Embedded Computing (STECE-2019)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../2020/index.html">Embedded Computing STECE-2020)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../2021/index.html">Embedded Computing (STECE-2021)</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="../../index.html">Embedded Computing (STECE-2022)</a><ul class="current">
<li class="toctree-l5"><a class="reference internal" href="../../ss2024/index.html">Embedded Computing 1 (STECE-2022): Summer</a></li>
<li class="toctree-l5 current"><a class="reference internal" href="../index.html">Embedded Computing 2 (STECE-2022): Winter</a><ul class="current">
<li class="toctree-l6"><a class="reference internal" href="../syllabus.html">Embedded Computing 2 (STECE-2022): Syllabus</a></li>
<li class="toctree-l6 current"><a class="reference internal" href="../material.html">Embedded Computing 2 (STECE-2022): Material</a><ul class="current">
<li class="toctree-l7"><a class="reference internal" href="../project/index.html">Project Plan (Yay)</a></li>
<li class="toctree-l7"><a class="reference internal" href="../2024-10-08/index.html">2024-10-08(6): Project/Peripherals/Cross</a></li>
<li class="toctree-l7 current"><a class="current reference internal" href="#">2024-10-23(6): Project: Linux I2C/PWM/SPI</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../yocto/index.html">Yocto</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../refactoring-homepage.html">Refactoring The Homepage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../seo.html">SEO</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../playground/index.html">Playground</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../git.html">Git Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../screencast.html">Creating Screencasts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../project-xxx/index.html">I2S Audio for a Kontron SMARC Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../packaging/index.html">Packaging this Site on PyPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../2022-04-13/index.html">Seminar on “Clean Code” (2022-04-13)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../blink/index.html">Pointless Blinking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../donau.html">Kajak Auf Der Donau</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../recipes/index.html">Recipes</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Blog</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../blog/index.html">Posts</a></li>
</ul>


        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
<section id="project-linux-i2c-pwm-spi">
<h1>2024-10-23(6): Project: Linux I2C/PWM/SPI<a class="headerlink" href="#project-linux-i2c-pwm-spi" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#i2c" id="id1">I2C</a></p></li>
<li><p><a class="reference internal" href="#pwm" id="id2">PWM</a></p></li>
<li><p><a class="reference internal" href="#spi" id="id3">SPI?</a></p></li>
</ul>
</nav>
<section id="i2c">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">I2C</a><a class="headerlink" href="#i2c" title="Link to this heading">¶</a></h2>
<p>Our project has two I2C devices that need to be programmed from
userspace (we want to create prototypes that can be used in other
contexts, and therefore cannot use Linux kernel drivers).</p>
<p>These devices are:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../project/proximity-vl53l1x.html"><span class="doc">Proximity Sensor: VL53L1X</span></a></p></li>
<li><p><a class="reference internal" href="../project/gyroscope-bno055.html"><span class="doc">Gyroscope (BNO055)</span></a></p></li>
</ul>
<p>Go over Linux userspace I2C:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../../../../../../trainings/material/soup/linux/hardware/i2c/topic.html"><span class="doc">Linux and I2C (using LM73 Temperature Sensor as Slave)</span></a></p></li>
</ul>
<p>Explain difference between userspace I2C, and a kernel driver - coincidentally using a driver for a PWM device:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../../../../../../trainings/material/soup/linux/hardware/pwm/topic.html"><span class="doc">PWM Userspace Interface (using PCA9685)</span></a></p></li>
</ul>
</section>
<section id="pwm">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">PWM</a><a class="headerlink" href="#pwm" title="Link to this heading">¶</a></h2>
<ul>
<li><p><a class="reference internal" href="../project/motor-control-btn9960lv.html"><span class="doc">Motor Control: BTN9960LV</span></a></p>
<p>That device is controlled via two PWM channels. The Raspberry has
only one (pin 18 has an alternative setting), so we use a PCA9685
which is connected over I2C.</p>
<p>⟶
<a class="reference internal" href="../../../../../../../trainings/material/soup/linux/hardware/pwm/topic.html"><span class="doc">PWM Userspace Interface (using PCA9685)</span></a></p>
</li>
<li><p><a class="reference internal" href="../project/servo-motor.html"><span class="doc">Motor Control: Servo Motor</span></a></p>
<p>Could work over PWM. I suspect not. Read on for SPI.</p>
</li>
</ul>
</section>
<section id="spi">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">SPI?</a><a class="headerlink" href="#spi" title="Link to this heading">¶</a></h2>
<p>In case PWM does not work for the servos, then chances are that it is
PPM (<a class="reference external" href="https://en.wikipedia.org/wiki/Pulse-position_modulation">Wikipedia</a>)</p>
<ul>
<li><p><a class="reference external" href="https://github.com/jfasch/ws2812-spi">ws2812-spi on Github</a>. Look into <a class="reference external" href="https://github.com/jfasch/ws2812-spi/blob/main/ws2812/spi.cpp">ws2812/spi.cpp</a>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">spi_ioc_transfer</span><span class="w"> </span><span class="n">tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">tx_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">xfer_bytes</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">xfer_size</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">speed_hz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">profile</span><span class="p">().</span><span class="n">frequency_hz</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ioctl</span><span class="p">(</span><span class="n">_fd</span><span class="p">,</span><span class="w"> </span><span class="n">SPI_IOC_MESSAGE</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tr</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><a class="reference external" href="https://datasheets.raspberrypi.com/bcm2711/bcm2711-peripherals.pdf">https://datasheets.raspberrypi.com/bcm2711/bcm2711-peripherals.pdf</a></p>
<p>Things to take into accout when you use SPI to clock out multi-byte
waveforms. Take care of “2.3.1. SPI implementation details”, where
they say that there is a garanteed gap between two bytes. During
that time the MOSI signal is also low (alas it’s SPI).</p>
</li>
</ul>
</section>
</section>

<div class="section ablog__blog_comments">
  
  
</div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2019-2024 (GPLv3), Jörg Faschingbauer.
      
      |
      <a href="../../../../../../../_sources/about/site/work-in-progress/fh-joanneum/2022/ws2024-25/2024-10-23/index.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>