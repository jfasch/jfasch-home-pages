

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Patching and Building the Fedora Kernel &mdash; Jörg Faschingbauer 0.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  
  <link rel="alternate" type="application/atom+xml"  href="../../../blog/atom.xml" title="Jörg Faschingbauer">
  
  
  <link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet">
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Jörg Faschingbauer
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption"><span class="caption-text">Content</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../courses/index.html">Schulungen</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/010-linux-basics.html">Linux Basics: Eine Einführung Anhand von Beispielen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/020-sysprog-basics.html">Systemprogrammierung: Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/050-sysprog-network.html">Systemprogrammierung: Netzwerk</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/060-sysprog-multithreading.html">Systemprogrammierung: Multithreading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/070-sysprog-fortgeschrittenes.html">Systemprogrammierung: Virtuelles Memory, IPC, Shared Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/080-sysprog-embedded.html">Systemprogrammierung: Embedded/Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/200-raspi-hands-on.html">Eine Woche mit dem Raspberry Pi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/700-kettner-lfs-descr.html">Linux from Scratch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/10-C.html">C: Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/12-C-Refresher.html">C: Auffrischung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/15-C-Advanced.html">C für Fortgeschrittene</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/20-CXX.html">C++: Eine Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/30-Python-Basics.html">Python Grundlagen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/35-Python-Advanced.html">Python für Fortgeschrittene</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-misc/010-bash.html">Shell Scripting mit der Bourne Again Shell (Bash)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-misc/020-make.html">GNU-Make: Eine Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-misc/030-svn.html">Subversion: Eine Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/records/index.html">Bisher Gehaltene</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../courses/records/2020-01-10/index.html">10.1.2020 Graz: IPC in Linux</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../courses/records/2020-01-10/Proposal.html">Proposal</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../courses/records/2020-01-10/Screenplay.html">Screenplay</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../about/index.html">Über mich</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../about/cv-de.html">Ein formaleres Curriculum Vitae</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about/skills-de.html">Eine Liste meiner technischen Fähigkeiten</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about/projects-de.html">Eine Liste meiner bisherigen Projekte</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../TODO.html">To Do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../STACKS.html">Stacks (Hanging)</a></li>
</ul>
<p class="caption"><span class="caption-text">Unterlagen</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../training-material/signals-screenplay.html">Signals: Live Hacking Screenplay</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../training-material/signals-screenplay.html#barebones-naive-program">Barebones Naive Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../training-material/signals-screenplay.html#signal-handler">Signal Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../training-material/signals-screenplay.html#alarm">Alarm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../training-material/signals-screenplay.html#multithreading">Multithreading</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../training-material/signals-screenplay.html#innocent-multithreaded-program">Innocent Multithreaded Program</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../training-material/signals-screenplay.html#add-sigalrm">Add <code class="docutils literal notranslate"><span class="pre">SIGALRM</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../training-material/ipc-screenplay.html">POSIX IPC: Live Hacking Screenplay</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#virtual-memory-mmap">Virtual Memory, <code class="docutils literal notranslate"><span class="pre">mmap()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#posix-shared-memory">POSIX Shared Memory</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#create-shared-memory-segment">Create Shared Memory Segment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#produce-into-shared-memory">Produce into Shared Memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#consume-from-shared-memory">Consume from Shared Memory</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#posix-semaphores">POSIX Semaphores</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#create-semaphore">Create Semaphore</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#wait">Wait</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#post">Post</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#posix-message-queues">POSIX Message Queues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#create">Create</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#produce">Produce</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../training-material/ipc-screenplay.html#consume">Consume</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Blog</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Posts</a></li>
</ul>

            
          

    <ul>
      <li class="toctree-l1">
	<a href="http://feeds.feedburner.com/JoergFaschingbauer" rel="alternate" type="application/rss+xml">
	  <img src="http://feedburner.google.com/fb/images/pub/feed-icon16x16.png" alt="" />&nbsp;Subscribe
	</a>
      </li>

    </ul>


        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Jörg Faschingbauer</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
      <li>Patching and Building the Fedora Kernel</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/blog/2020/02/fedora-kernel-build.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="patching-and-building-the-fedora-kernel">
<h1>Patching and Building the Fedora Kernel<a class="headerlink" href="#patching-and-building-the-fedora-kernel" title="Permalink to this headline">¶</a></h1>
<p>It’s not easy to get up to date information on how to create a custom
kernel on Fedora. There’s plenty of information out there, but most of
it is outdated and only halfway true.</p>
<p>Here’s what I was able to find out by combining non-outdated
information into a working procedure. It goes as follows.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#why" id="id5">Why?</a></p></li>
<li><p><a class="reference internal" href="#find-kernel-source-git-fix-it-and-create-patch" id="id6">Find Kernel Source (Git), Fix It, and Create Patch</a></p></li>
<li><p><a class="reference internal" href="#prepare-the-rpm-build" id="id7">Prepare the RPM Build</a></p></li>
<li><p><a class="reference internal" href="#download-and-install-source-rpm-for-crashing-kernel" id="id8">Download and Install Source RPM For Crashing Kernel</a></p></li>
<li><p><a class="reference internal" href="#apply-the-patch" id="id9">Apply the Patch</a></p></li>
<li><p><a class="reference internal" href="#build-the-kernel-rpms" id="id10">Build the Kernel RPMs</a></p></li>
<li><p><a class="reference internal" href="#install-kernel" id="id11">Install Kernel</a></p></li>
</ul>
</div>
<div class="section" id="why">
<h2><a class="toc-backref" href="#id5">Why?</a><a class="headerlink" href="#why" title="Permalink to this headline">¶</a></h2>
<p>Tracking down a bug on my new USB-C/Thunderbolt-only laptop where an
external HDMI monitor is plugged via an adapter.</p>
<ul class="simple">
<li><p>Plug external monitor</p></li>
<li><p>Unplug external monitor</p></li>
<li><p>Wait a few seconds</p></li>
<li><p>Watch kernel go up in flames</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">The Oops</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Feb 26 13:58:08 zen kernel: BUG: kernel NULL pointer dereference, address: 0000000000000080
Feb 26 13:58:08 zen kernel: #PF: supervisor read access in kernel mode
Feb 26 13:58:08 zen kernel: #PF: error_code(0x0000) - not-present page
Feb 26 13:58:08 zen kernel: PGD 0 P4D 0
Feb 26 13:58:08 zen kernel: Oops: 0000 [#1] SMP PTI
Feb 26 13:58:08 zen kernel: CPU: 0 PID: 281 Comm: kworker/0:2 Not tainted 5.4.13-201.fc31.x86_64 #1
Feb 26 13:58:08 zen kernel: Hardware name: ASUSTeK COMPUTER INC. ZenBook S UX391UA/UX391UA, BIOS UX391UA.204 05/18/2018
Feb 26 13:58:08 zen kernel: Workqueue: events ucsi_connector_change [typec_ucsi]
Feb 26 13:58:08 zen kernel: RIP: 0010:ucsi_displayport_remove_partner+0xa/0x20 [typec_ucsi]
Feb 26 13:58:08 zen kernel: Code: 38 00 c7 43 28 00 00 00 00 48 83 c7 10 5b e9 6d f3 3d fb 66 66 2e 0f 1f 84 00 00 00 00 00 66 90 0f 1f 44 00 00 48 85 ff 74 0f &lt;48&gt; 8b 47 78 48 c7 00 00 00 00 00 c6 40 3d 00 c3 66 0f 1f 44 00 00
Feb 26 13:58:08 zen kernel: RSP: 0018:ffff9daa002d3df8 EFLAGS: 00010202
Feb 26 13:58:08 zen kernel: RAX: 0000000000000008 RBX: ffff901f4ce35710 RCX: 0000000000003c7d
Feb 26 13:58:08 zen kernel: RDX: 0000000000003c7c RSI: 0000000000000001 RDI: 0000000000000008
Feb 26 13:58:08 zen kernel: RBP: 0000000000000000 R08: ffffffffbc7dbe60 R09: ffff9daa002d3cf0
Feb 26 13:58:08 zen kernel: R10: ffff901f54951a18 R11: ffff901f56a68a78 R12: ffff901f4ce35710
Feb 26 13:58:08 zen kernel: R13: 0000000000000001 R14: ffff901f4ce35860 R15: ffff901f4ce355d8
Feb 26 13:58:08 zen kernel: FS:  0000000000000000(0000) GS:ffff901f56a00000(0000) knlGS:0000000000000000
Feb 26 13:58:08 zen kernel: CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
Feb 26 13:58:08 zen kernel: CR2: 0000000000000080 CR3: 000000028fbbc003 CR4: 00000000003606f0
Feb 26 13:58:08 zen kernel: Call Trace:
Feb 26 13:58:08 zen kernel:  ucsi_unregister_altmodes+0x77/0x90 [typec_ucsi]
Feb 26 13:58:08 zen kernel:  ucsi_unregister_partner.part.0+0x13/0x30 [typec_ucsi]
Feb 26 13:58:08 zen kernel:  ucsi_connector_change+0x247/0x340 [typec_ucsi]
Feb 26 13:58:08 zen kernel:  process_one_work+0x1b5/0x360
Feb 26 13:58:08 zen kernel:  worker_thread+0x50/0x3c0
Feb 26 13:58:08 zen kernel:  kthread+0xf9/0x130
Feb 26 13:58:08 zen kernel:  ? process_one_work+0x360/0x360
Feb 26 13:58:08 zen kernel:  ? kthread_park+0x90/0x90
Feb 26 13:58:08 zen kernel:  ret_from_fork+0x35/0x40
Feb 26 13:58:08 zen kernel: Modules linked in: cdc_ether usbnet r8152 mii rc_cec typec_displayport thunderbolt uinput rfcomm ccm xt_CHECKSUM xt_MASQUERADE nf_nat_tftp nf_conntrack_tftp tun bridge stp llc nf_conntrack_netbios_ns nf_conntrack_broadcast xt_CT ip6t_REJECT nf_reject_ipv6 ip6t_rpfilter ipt_REJECT nf_reject_ipv4 xt_conntrack ebtable_nat ebtable_broute ip6table_nat ip6table_mangle ip6table_raw ip6table_security iptable_nat nf_nat iptable_mangle iptable_raw iptable_security nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 libcrc32c ip_set nfnetlink ebtable_filter ebtables ip6table_filter ip6_tables iptable_filter cmac bnep sunrpc vfat fat snd_hda_codec_hdmi snd_soc_skl snd_soc_sst_ipc snd_soc_sst_dsp snd_hda_ext_core x86_pkg_temp_thermal intel_powerclamp snd_soc_acpi_intel_match coretemp snd_soc_acpi kvm_intel snd_soc_core snd_hda_codec_realtek snd_hda_codec_generic snd_compress ledtrig_audio ac97_bus kvm snd_pcm_dmaengine iwlmvm snd_hda_intel snd_intel_dspcfg irqbypass snd_hda_codec uvcvideo mac80211
Feb 26 13:58:08 zen kernel:  btusb iTCO_wdt btrtl crct10dif_pclmul videobuf2_vmalloc iTCO_vendor_support videobuf2_memops mei_hdcp btbcm btintel crc32_pclmul intel_rapl_msr snd_hda_core videobuf2_v4l2 libarc4 ghash_clmulni_intel videobuf2_common snd_hwdep intel_cstate bluetooth snd_seq asus_nb_wmi iwlwifi videodev snd_seq_device intel_uncore asus_wmi snd_pcm intel_rapl_perf mc cdc_acm sparse_keymap wmi_bmof ecdh_generic cfg80211 intel_wmi_thunderbolt ecc pcspkr snd_timer snd i2c_i801 soundcore joydev idma64 intel_xhci_usb_role_switch mei_me ucsi_acpi processor_thermal_device typec_ucsi intel_rapl_common mei roles intel_soc_dts_iosf intel_pch_thermal typec int3403_thermal int340x_thermal_zone int3400_thermal acpi_thermal_rel acpi_pad binfmt_misc ip_tables rfkill i915 i2c_algo_bit drm_kms_helper hid_multitouch drm nvme crc32c_intel nvme_core serio_raw wmi i2c_hid video fuse
Feb 26 13:58:08 zen kernel: CR2: 0000000000000080
Feb 26 13:58:08 zen kernel: ---[ end trace 76d248e576fee192 ]---
Feb 26 13:58:08 zen kernel: RIP: 0010:ucsi_displayport_remove_partner+0xa/0x20 [typec_ucsi]
Feb 26 13:58:08 zen kernel: Code: 38 00 c7 43 28 00 00 00 00 48 83 c7 10 5b e9 6d f3 3d fb 66 66 2e 0f 1f 84 00 00 00 00 00 66 90 0f 1f 44 00 00 48 85 ff 74 0f &lt;48&gt; 8b 47 78 48 c7 00 00 00 00 00 c6 40 3d 00 c3 66 0f 1f 44 00 00
Feb 26 13:58:08 zen kernel: RSP: 0018:ffff9daa002d3df8 EFLAGS: 00010202
Feb 26 13:58:08 zen kernel: RAX: 0000000000000008 RBX: ffff901f4ce35710 RCX: 0000000000003c7d
Feb 26 13:58:08 zen kernel: RDX: 0000000000003c7c RSI: 0000000000000001 RDI: 0000000000000008
Feb 26 13:58:08 zen kernel: RBP: 0000000000000000 R08: ffffffffbc7dbe60 R09: ffff9daa002d3cf0
Feb 26 13:58:08 zen kernel: R10: ffff901f54951a18 R11: ffff901f56a68a78 R12: ffff901f4ce35710
Feb 26 13:58:08 zen kernel: R13: 0000000000000001 R14: ffff901f4ce35860 R15: ffff901f4ce355d8
Feb 26 13:58:08 zen kernel: FS:  0000000000000000(0000) GS:ffff901f56a00000(0000) knlGS:0000000000000000
Feb 26 13:58:08 zen kernel: CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
Feb 26 13:58:08 zen kernel: CR2: 0000000000000080 CR3: 000000028fbbc003 CR4: 00000000003606f0
</pre></div>
</div>
</div>
<p>Looking at the cause, we see that the crash is a NULL pointer that is
deferenced in <code class="docutils literal notranslate"><span class="pre">ucsi_displayport_remove_partner()</span></code>,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Feb</span> <span class="mi">26</span> <span class="mi">13</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">08</span> <span class="n">zen</span> <span class="n">kernel</span><span class="p">:</span> <span class="n">BUG</span><span class="p">:</span> <span class="n">kernel</span> <span class="n">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="mi">0000000000000080</span>
<span class="o">...</span> <span class="p">(</span><span class="n">blah</span><span class="p">)</span> <span class="o">...</span>
<span class="n">Feb</span> <span class="mi">26</span> <span class="mi">13</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">08</span> <span class="n">zen</span> <span class="n">kernel</span><span class="p">:</span> <span class="n">RIP</span><span class="p">:</span> <span class="mi">0010</span><span class="p">:</span><span class="n">ucsi_displayport_remove_partner</span><span class="o">+</span><span class="mh">0xa</span><span class="o">/</span><span class="mh">0x20</span> <span class="p">[</span><span class="n">typec_ucsi</span><span class="p">]</span>
</pre></div>
</div>
<p>A look at the offending source code shows that the fix must be
easy. The only pointer that is being accessed is <code class="docutils literal notranslate"><span class="pre">dp</span></code>, and that
pointer is not checked for NULL-ness.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">drivers/usb/typec/ucsi/displayport.c (taken from Linus
<code class="docutils literal notranslate"><span class="pre">master</span></code>)</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">ucsi_displayport_remove_partner</span><span class="p">(</span><span class="k">struct</span> <span class="n">typec_altmode</span> <span class="o">*</span><span class="n">alt</span><span class="p">)</span>
<span class="p">{</span>
     <span class="k">struct</span> <span class="n">ucsi_dp</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>

     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alt</span><span class="p">)</span>
             <span class="k">return</span><span class="p">;</span>

<span class="hll">     <span class="n">dp</span> <span class="o">=</span> <span class="n">typec_altmode_get_drvdata</span><span class="p">(</span><span class="n">alt</span><span class="p">);</span>
</span><span class="hll">     <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span>     <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">dp</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>The fix is really easy,</p>
<div class="highlight-udiff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- /home/jfasch/work/homepage/blog/2020/02/displayport.c.orig</span>
<span class="gi">+++ /home/jfasch/work/homepage/blog/2020/02/displayport.c</span>
<span class="gu">@@ -271,6 +271,8 @@</span>
 		return;
 
 	dp = typec_altmode_get_drvdata(alt);
<span class="gi">+    if (!dp)</span>
<span class="gi">+		return;</span>
 	dp-&gt;data.conf = 0;
 	dp-&gt;data.status = 0;
 	dp-&gt;initialized = false;
</pre></div>
</div>
<p>The bug is tracked as <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1785972">Red Hat Bugzilla – Bug 1785972</a>, and upstream
is already involved. John Stebbins and I provided testing, but
roundtrips are rather long. What makes things worse is that there
appear to be multiple issues, not just one.</p>
<p>I’ll focus on mine: patch, build, report, and help with
testing. First, see how kernels are built in Fedora.</p>
</div>
<div class="section" id="find-kernel-source-git-fix-it-and-create-patch">
<h2><a class="toc-backref" href="#id6">Find Kernel Source (Git), Fix It, and Create Patch</a><a class="headerlink" href="#find-kernel-source-git-fix-it-and-create-patch" title="Permalink to this headline">¶</a></h2>
<div class="sidebar">
<p class="sidebar-title">Link</p>
<p><a class="reference external" href="https://fedoraproject.org/wiki/Building_a_custom_kernel#Building_a_kernel_from_the_exploded_git_trees">Fedora Wiki: “Exploded Git Trees”</a></p>
</div>
<p>Fedora has a Git repository at <code class="docutils literal notranslate"><span class="pre">kernel.org</span></code> where they apply their
own patches on top of the vanilla kernel. Clone that, and create a
development branch. (I am on Fedora 31, so I’m basing the branch on
that.)</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ git clone git://git.kernel.org/pub/scm/linux/kernel/git/jwboyer/fedora.git
$ git checkout -b jfasch-fix remotes/origin/f31
</pre></div>
</div>
<p>Fix <code class="docutils literal notranslate"><span class="pre">drivers/usb/typec/ucsi/displayport.c</span></code> as sketched above, and
commit.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ git commit -am <span class="s1">&#39;fix RIP:ucsi_displayport_remove_partner()&#39;</span>
</pre></div>
</div>
<p>The remainder of the procedure will build the kernel RPM. A kernel RPM
build works by applying a set of patches on top of the base vanilla
kernel <a class="footnote-reference brackets" href="#exploded-tree" id="id1">1</a>, so we create a patch for later use.</p>
<p>I made only one commit for which I want to create a patch. Find out
the revision that this patch is based upon; it is one revision before
the <code class="docutils literal notranslate"><span class="pre">HEAD</span></code>.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ git show --quiet HEAD~1
commit 4382f76bc8ef9fce5e7e96d4cdb0c073564ad249 <span class="o">(</span>tag: kernel-5.5.6-201.fc31, origin/f31<span class="o">)</span>
Author: Josh Boyer &lt;jwboyer@fedoraproject.org&gt;
Date:   Mon Feb <span class="m">24</span> <span class="m">23</span>:09:20 <span class="m">2020</span> +0000

    kernel-5.5.6-201.fc31 configs
</pre></div>
</div>
<p>Create the patch which we will pick up later,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ git format-patch -o /tmp 4382f76bc8ef9fce5e7e96d4cdb0c073564ad249
/tmp/0001-fix-RIP-ucsi_displayport_remove_partner.patch
</pre></div>
</div>
</div>
<div class="section" id="prepare-the-rpm-build">
<h2><a class="toc-backref" href="#id7">Prepare the RPM Build</a><a class="headerlink" href="#prepare-the-rpm-build" title="Permalink to this headline">¶</a></h2>
<div class="sidebar">
<p class="sidebar-title">Link</p>
<p><a class="reference external" href="https://fedoraproject.org/wiki/Building_a_custom_kernel/Source_RPM#Prepare_Build_Files">Building a custom kernel/Source RPM</a></p>
</div>
<div class="contents local topic" id="id2">
<ul class="simple">
<li><p><a class="reference internal" href="#install-prerequisites" id="id12">Install Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#setup-rpmbuild-directory" id="id13">Setup <code class="docutils literal notranslate"><span class="pre">rpmbuild</span></code> Directory</a></p></li>
</ul>
</div>
<div class="section" id="install-prerequisites">
<h3><a class="toc-backref" href="#id12">Install Prerequisites</a><a class="headerlink" href="#install-prerequisites" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ sudo dnf install rpmdevtools koji
</pre></div>
</div>
</div>
<div class="section" id="setup-rpmbuild-directory">
<h3><a class="toc-backref" href="#id13">Setup <code class="docutils literal notranslate"><span class="pre">rpmbuild</span></code> Directory</a><a class="headerlink" href="#setup-rpmbuild-directory" title="Permalink to this headline">¶</a></h3>
<p>Setup an empty RPM tree. This will simply create a directory
<code class="docutils literal notranslate"><span class="pre">rpmbuild</span></code> skeleton tree in the home directory.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ rpmdev-setuptree
$ tree ~/rpmbuild/
/home/jfasch/rpmbuild/
├── BUILD
├── RPMS
├── SOURCES
├── SPECS
└── SRPMS
</pre></div>
</div>
</div>
</div>
<div class="section" id="download-and-install-source-rpm-for-crashing-kernel">
<h2><a class="toc-backref" href="#id8">Download and Install Source RPM For Crashing Kernel</a><a class="headerlink" href="#download-and-install-source-rpm-for-crashing-kernel" title="Permalink to this headline">¶</a></h2>
<p>Find out the version of the crashing kernel (the one that is currently
running),</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ uname -r
<span class="m">5</span>.4.13-201.local.fc31.x86_64
</pre></div>
</div>
<p>Download the corresponding source RPM from their build engine,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ koji download-build --arch<span class="o">=</span>src kernel-5.4.13-201.fc31
$ ls -l *.rpm
kernel-5.4.13-201.fc31.src.rpm
</pre></div>
</div>
<p>Install the RPM. This will fill the <code class="docutils literal notranslate"><span class="pre">~/rpmbuild/</span></code> skeleton with the
kenrel build instructions.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ rpm -ivh kernel-5.4.13-201.fc31.src.rpm
$ tree ~/rpmbuild/
/home/jfasch/rpmbuild/
├── BUILD
├── RPMS
├── SOURCES
│   ├── <span class="m">0001</span>-crypto-ccp-Release-all-allocated-memory-if-sha-type-.patch
│   ├── <span class="m">0001</span>-Drop-that-for-now.patch
... <span class="o">(</span>blah<span class="o">)</span> ...
├── SPECS
│   └── kernel.spec
└── SRPMS
</pre></div>
</div>
</div>
<div class="section" id="apply-the-patch">
<h2><a class="toc-backref" href="#id9">Apply the Patch</a><a class="headerlink" href="#apply-the-patch" title="Permalink to this headline">¶</a></h2>
<p>Copy the patch from above into the build tree, where the other patches
are,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ cp /tmp/0001-fix-RIP-ucsi_displayport_remove_partner.patch <span class="se">\</span>
    ~/rpmbuild/SOURCES/RIP-ucsi_displayport_remove_partner.patch
</pre></div>
</div>
<p>Edit the build specification, <code class="docutils literal notranslate"><span class="pre">~/rpmbuild/SPECS/kernel.spec</span></code>, to</p>
<ul class="simple">
<li><p>contain a descriptive version</p></li>
<li><p>apply the patch</p></li>
</ul>
<div class="highlight-udiff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- /home/jfasch/work/homepage/blog/2020/02/kernel.spec.orig</span>
<span class="gi">+++ /home/jfasch/work/homepage/blog/2020/02/kernel.spec</span>
<span class="gu">@@ -53,7 +53,7 @@</span>
 %global zipsed -e &#39;s/\.ko$/\.ko.xz/&#39;
 %endif
 
<span class="gd">-# define buildid .local</span>
<span class="gi">+%define buildid .jfasch</span>
 
 %if 0%{?fedora}
 %define primary_target fedora
<span class="gu">@@ -825,6 +825,7 @@</span>
 
 # ALSA code from v5.6 (Intel ASoC Sound Open Firmware driver support)
 Patch601: alsa-5.6.patch
<span class="gi">+Patch999: RIP-ucsi_displayport_remove_partner.patch</span>
 
 # END OF PATCH DEFINITIONS
 
</pre></div>
</div>
</div>
<div class="section" id="build-the-kernel-rpms">
<h2><a class="toc-backref" href="#id10">Build the Kernel RPMs</a><a class="headerlink" href="#build-the-kernel-rpms" title="Permalink to this headline">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/rpmbuild/SPECS/
$ rpmbuild -bb --target<span class="o">=</span>x86_64 kernel.spec
... roedel ...
</pre></div>
</div>
<p>Before doing this, make sure the following is available:</p>
<ul class="simple">
<li><p>Enough RAM</p></li>
<li><p>Enough disk</p></li>
<li><p>Patience, coffee, or something else to do</p></li>
</ul>
</div>
<div class="section" id="install-kernel">
<h2><a class="toc-backref" href="#id11">Install Kernel</a><a class="headerlink" href="#install-kernel" title="Permalink to this headline">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ sudo rpm -ivh --oldpackage <span class="se">\</span>
   ~/rpmbuild/RPMS/x86_64/kernel-core-5.4.13-201.jfasch.fc31.x86_64.rpm <span class="se">\</span>
   ~/rpmbuild/RPMS/x86_64/kernel-modules-5.4.13-201.jfasch.fc31.x86_64.rpm
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The kernel is not signed, obviously, so you might have to disable
Secure Boot in your UEFI.</p>
</div>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="exploded-tree"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Yes, the patches are created from the Git
repository we are working with.</p>
</dd>
</dl>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  
  <a href="../../2012/04/Why-ps-sucks.html">
    <i class="fa fa-arrow-circle-left"></i>
    “Why ps Sucks” or “Counting Memory Consumption”
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  </span>
</div>

  
  
  </div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Jörg Faschingbauer

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>