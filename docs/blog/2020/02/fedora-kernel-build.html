

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Patching and Building the Fedora Kernel &mdash; Jörg Faschingbauer 0.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Jörg Faschingbauer
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../courses/index.html">Schulungen</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/010-linux-basics.html">Linux Basics: Eine Einführung Anhand von Beispielen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/020-sysprog-basics.html">Systemprogrammierung: Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/050-sysprog-network.html">Systemprogrammierung: Netzwerk</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/060-sysprog-multithreading.html">Systemprogrammierung: Multithreading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/070-sysprog-fortgeschrittenes.html">Systemprogrammierung: Virtuelles Memory, IPC, Shared Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/080-sysprog-embedded.html">Systemprogrammierung: Embedded/Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/200-raspi-hands-on.html">Eine Woche mit dem Raspberry Pi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/700-kettner-lfs-descr.html">Linux from Scratch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/10-C.html">C: Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/12-C-Refresher.html">C: Auffrischung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/15-C-Advanced.html">C für Fortgeschrittene</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/20-CXX.html">C++: Eine Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/30-Python-Basics.html">Python Grundlagen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/35-Python-Advanced.html">Python für Fortgeschrittene</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-misc/010-bash.html">Shell Scripting mit der Bourne Again Shell (Bash)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-misc/020-make.html">GNU-Make: Eine Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-misc/030-svn.html">Subversion: Eine Einführung</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../about/index.html">Über mich</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../about/cv-de.html">Ein formaleres Curriculum Vitae</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about/skills-de.html">Eine Liste meiner technischen Fähigkeiten</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about/projects-de.html">Eine Liste meiner bisherigen Projekte</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Blog Posts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../TODO.html">To Do</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Jörg Faschingbauer</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
      <li>Patching and Building the Fedora Kernel</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/blog/2020/02/fedora-kernel-build.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="patching-and-building-the-fedora-kernel">
<h1><a class="toc-backref" href="#id3">Patching and Building the Fedora Kernel</a><a class="headerlink" href="#patching-and-building-the-fedora-kernel" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#patching-and-building-the-fedora-kernel" id="id3">Patching and Building the Fedora Kernel</a></p>
<ul>
<li><p><a class="reference internal" href="#why" id="id4">Why?</a></p></li>
<li><p><a class="reference internal" href="#building-a-fedora-kernel" id="id5">Building a Fedora Kernel</a></p></li>
<li><p><a class="reference internal" href="#try-42" id="id6">Try 42</a></p></li>
<li><p><a class="reference internal" href="#try-43" id="id7">Try 43</a></p>
<ul>
<li><p><a class="reference internal" href="#kernel-rpm-spec" id="id8">kernel rpm/spec</a></p></li>
<li><p><a class="reference internal" href="#make-patch" id="id9">make patch</a></p></li>
<li><p><a class="reference internal" href="#apply-patch" id="id10">apply patch</a></p></li>
<li><p><a class="reference internal" href="#build" id="id11">build</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#certificate-things-gosh" id="id12">Certificate Things Gosh</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="why">
<h2><a class="toc-backref" href="#id4">Why?</a><a class="headerlink" href="#why" title="Permalink to this headline">¶</a></h2>
<p>Tracking down a bug on my new USB-C/Thunderbolt-only laptop where an
external HDMI monitor is plugged via an adapter.</p>
<ul class="simple">
<li><p>Plug external monitor</p></li>
<li><p>Unplug external monitor</p></li>
<li><p>Wait a few seconds</p></li>
<li><p>Watch kernel go up in flames</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">The Oops</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Feb 26 13:58:08 zen kernel: BUG: kernel NULL pointer dereference, address: 0000000000000080
Feb 26 13:58:08 zen kernel: #PF: supervisor read access in kernel mode
Feb 26 13:58:08 zen kernel: #PF: error_code(0x0000) - not-present page
Feb 26 13:58:08 zen kernel: PGD 0 P4D 0
Feb 26 13:58:08 zen kernel: Oops: 0000 [#1] SMP PTI
Feb 26 13:58:08 zen kernel: CPU: 0 PID: 281 Comm: kworker/0:2 Not tainted 5.4.13-201.fc31.x86_64 #1
Feb 26 13:58:08 zen kernel: Hardware name: ASUSTeK COMPUTER INC. ZenBook S UX391UA/UX391UA, BIOS UX391UA.204 05/18/2018
Feb 26 13:58:08 zen kernel: Workqueue: events ucsi_connector_change [typec_ucsi]
Feb 26 13:58:08 zen kernel: RIP: 0010:ucsi_displayport_remove_partner+0xa/0x20 [typec_ucsi]
Feb 26 13:58:08 zen kernel: Code: 38 00 c7 43 28 00 00 00 00 48 83 c7 10 5b e9 6d f3 3d fb 66 66 2e 0f 1f 84 00 00 00 00 00 66 90 0f 1f 44 00 00 48 85 ff 74 0f &lt;48&gt; 8b 47 78 48 c7 00 00 00 00 00 c6 40 3d 00 c3 66 0f 1f 44 00 00
Feb 26 13:58:08 zen kernel: RSP: 0018:ffff9daa002d3df8 EFLAGS: 00010202
Feb 26 13:58:08 zen kernel: RAX: 0000000000000008 RBX: ffff901f4ce35710 RCX: 0000000000003c7d
Feb 26 13:58:08 zen kernel: RDX: 0000000000003c7c RSI: 0000000000000001 RDI: 0000000000000008
Feb 26 13:58:08 zen kernel: RBP: 0000000000000000 R08: ffffffffbc7dbe60 R09: ffff9daa002d3cf0
Feb 26 13:58:08 zen kernel: R10: ffff901f54951a18 R11: ffff901f56a68a78 R12: ffff901f4ce35710
Feb 26 13:58:08 zen kernel: R13: 0000000000000001 R14: ffff901f4ce35860 R15: ffff901f4ce355d8
Feb 26 13:58:08 zen kernel: FS:  0000000000000000(0000) GS:ffff901f56a00000(0000) knlGS:0000000000000000
Feb 26 13:58:08 zen kernel: CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
Feb 26 13:58:08 zen kernel: CR2: 0000000000000080 CR3: 000000028fbbc003 CR4: 00000000003606f0
Feb 26 13:58:08 zen kernel: Call Trace:
Feb 26 13:58:08 zen kernel:  ucsi_unregister_altmodes+0x77/0x90 [typec_ucsi]
Feb 26 13:58:08 zen kernel:  ucsi_unregister_partner.part.0+0x13/0x30 [typec_ucsi]
Feb 26 13:58:08 zen kernel:  ucsi_connector_change+0x247/0x340 [typec_ucsi]
Feb 26 13:58:08 zen kernel:  process_one_work+0x1b5/0x360
Feb 26 13:58:08 zen kernel:  worker_thread+0x50/0x3c0
Feb 26 13:58:08 zen kernel:  kthread+0xf9/0x130
Feb 26 13:58:08 zen kernel:  ? process_one_work+0x360/0x360
Feb 26 13:58:08 zen kernel:  ? kthread_park+0x90/0x90
Feb 26 13:58:08 zen kernel:  ret_from_fork+0x35/0x40
Feb 26 13:58:08 zen kernel: Modules linked in: cdc_ether usbnet r8152 mii rc_cec typec_displayport thunderbolt uinput rfcomm ccm xt_CHECKSUM xt_MASQUERADE nf_nat_tftp nf_conntrack_tftp tun bridge stp llc nf_conntrack_netbios_ns nf_conntrack_broadcast xt_CT ip6t_REJECT nf_reject_ipv6 ip6t_rpfilter ipt_REJECT nf_reject_ipv4 xt_conntrack ebtable_nat ebtable_broute ip6table_nat ip6table_mangle ip6table_raw ip6table_security iptable_nat nf_nat iptable_mangle iptable_raw iptable_security nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 libcrc32c ip_set nfnetlink ebtable_filter ebtables ip6table_filter ip6_tables iptable_filter cmac bnep sunrpc vfat fat snd_hda_codec_hdmi snd_soc_skl snd_soc_sst_ipc snd_soc_sst_dsp snd_hda_ext_core x86_pkg_temp_thermal intel_powerclamp snd_soc_acpi_intel_match coretemp snd_soc_acpi kvm_intel snd_soc_core snd_hda_codec_realtek snd_hda_codec_generic snd_compress ledtrig_audio ac97_bus kvm snd_pcm_dmaengine iwlmvm snd_hda_intel snd_intel_dspcfg irqbypass snd_hda_codec uvcvideo mac80211
Feb 26 13:58:08 zen kernel:  btusb iTCO_wdt btrtl crct10dif_pclmul videobuf2_vmalloc iTCO_vendor_support videobuf2_memops mei_hdcp btbcm btintel crc32_pclmul intel_rapl_msr snd_hda_core videobuf2_v4l2 libarc4 ghash_clmulni_intel videobuf2_common snd_hwdep intel_cstate bluetooth snd_seq asus_nb_wmi iwlwifi videodev snd_seq_device intel_uncore asus_wmi snd_pcm intel_rapl_perf mc cdc_acm sparse_keymap wmi_bmof ecdh_generic cfg80211 intel_wmi_thunderbolt ecc pcspkr snd_timer snd i2c_i801 soundcore joydev idma64 intel_xhci_usb_role_switch mei_me ucsi_acpi processor_thermal_device typec_ucsi intel_rapl_common mei roles intel_soc_dts_iosf intel_pch_thermal typec int3403_thermal int340x_thermal_zone int3400_thermal acpi_thermal_rel acpi_pad binfmt_misc ip_tables rfkill i915 i2c_algo_bit drm_kms_helper hid_multitouch drm nvme crc32c_intel nvme_core serio_raw wmi i2c_hid video fuse
Feb 26 13:58:08 zen kernel: CR2: 0000000000000080
Feb 26 13:58:08 zen kernel: ---[ end trace 76d248e576fee192 ]---
Feb 26 13:58:08 zen kernel: RIP: 0010:ucsi_displayport_remove_partner+0xa/0x20 [typec_ucsi]
Feb 26 13:58:08 zen kernel: Code: 38 00 c7 43 28 00 00 00 00 48 83 c7 10 5b e9 6d f3 3d fb 66 66 2e 0f 1f 84 00 00 00 00 00 66 90 0f 1f 44 00 00 48 85 ff 74 0f &lt;48&gt; 8b 47 78 48 c7 00 00 00 00 00 c6 40 3d 00 c3 66 0f 1f 44 00 00
Feb 26 13:58:08 zen kernel: RSP: 0018:ffff9daa002d3df8 EFLAGS: 00010202
Feb 26 13:58:08 zen kernel: RAX: 0000000000000008 RBX: ffff901f4ce35710 RCX: 0000000000003c7d
Feb 26 13:58:08 zen kernel: RDX: 0000000000003c7c RSI: 0000000000000001 RDI: 0000000000000008
Feb 26 13:58:08 zen kernel: RBP: 0000000000000000 R08: ffffffffbc7dbe60 R09: ffff9daa002d3cf0
Feb 26 13:58:08 zen kernel: R10: ffff901f54951a18 R11: ffff901f56a68a78 R12: ffff901f4ce35710
Feb 26 13:58:08 zen kernel: R13: 0000000000000001 R14: ffff901f4ce35860 R15: ffff901f4ce355d8
Feb 26 13:58:08 zen kernel: FS:  0000000000000000(0000) GS:ffff901f56a00000(0000) knlGS:0000000000000000
Feb 26 13:58:08 zen kernel: CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
Feb 26 13:58:08 zen kernel: CR2: 0000000000000080 CR3: 000000028fbbc003 CR4: 00000000003606f0
</pre></div>
</div>
</div>
<p>Looking at the cause, we see that the crash is a NULL pointer that is
deferenced in <code class="docutils literal notranslate"><span class="pre">ucsi_displayport_remove_partner()</span></code>,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Feb</span> <span class="mi">26</span> <span class="mi">13</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">08</span> <span class="n">zen</span> <span class="n">kernel</span><span class="p">:</span> <span class="n">BUG</span><span class="p">:</span> <span class="n">kernel</span> <span class="n">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="mi">0000000000000080</span>
<span class="o">...</span> <span class="p">(</span><span class="n">blah</span><span class="p">)</span> <span class="o">...</span>
<span class="n">Feb</span> <span class="mi">26</span> <span class="mi">13</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">08</span> <span class="n">zen</span> <span class="n">kernel</span><span class="p">:</span> <span class="n">RIP</span><span class="p">:</span> <span class="mi">0010</span><span class="p">:</span><span class="n">ucsi_displayport_remove_partner</span><span class="o">+</span><span class="mh">0xa</span><span class="o">/</span><span class="mh">0x20</span> <span class="p">[</span><span class="n">typec_ucsi</span><span class="p">]</span>
</pre></div>
</div>
<p>A look at the offending source code shows that the fix must be
easy. The only pointer that is being accessed is <code class="docutils literal notranslate"><span class="pre">dp</span></code>, and that
pointer is not checked for NULL-ness.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">drivers/usb/typec/ucsi/displayport.c (taken from Linus
<code class="docutils literal notranslate"><span class="pre">master</span></code>)</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">ucsi_displayport_remove_partner</span><span class="p">(</span><span class="k">struct</span> <span class="n">typec_altmode</span> <span class="o">*</span><span class="n">alt</span><span class="p">)</span>
<span class="p">{</span>
     <span class="k">struct</span> <span class="n">ucsi_dp</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>

     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alt</span><span class="p">)</span>
             <span class="k">return</span><span class="p">;</span>

<span class="hll">     <span class="n">dp</span> <span class="o">=</span> <span class="n">typec_altmode_get_drvdata</span><span class="p">(</span><span class="n">alt</span><span class="p">);</span>
</span><span class="hll">     <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span>     <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">dp</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>The fix is really easy,</p>
<div class="highlight-udiff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- /home/jfasch/work/homepage/blog/2020/02/displayport.c.orig</span>
<span class="gi">+++ /home/jfasch/work/homepage/blog/2020/02/displayport.c</span>
<span class="gu">@@ -271,6 +271,8 @@</span>
 		return;
 
 	dp = typec_altmode_get_drvdata(alt);
<span class="gi">+    if (!dp)</span>
<span class="gi">+		return;</span>
 	dp-&gt;data.conf = 0;
 	dp-&gt;data.status = 0;
 	dp-&gt;initialized = false;
</pre></div>
</div>
<p>The bug is tracked as <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1785972">Red Hat Bugzilla – Bug 1785972</a>, and upstream
is already involved. John Stebbins and I provided testing, but
roundtrips are rather long. What makes things worse is that there
appear to be multiple issues, not just one.</p>
<p>I’ll focus on mine: patch, build, report, and help with
testing. First, see how kernels are built in Fedora.</p>
</div>
<div class="section" id="building-a-fedora-kernel">
<h2><a class="toc-backref" href="#id5">Building a Fedora Kernel</a><a class="headerlink" href="#building-a-fedora-kernel" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>(<a class="reference external" href="https://fedoraproject.org/wiki/Building_a_custom_kernel">https://fedoraproject.org/wiki/Building_a_custom_kernel</a>)</p></li>
<li><p>better this one?
<a class="reference external" href="https://docs.fedoraproject.org/en-US/quick-docs/kernel/build-custom-kernel/">https://docs.fedoraproject.org/en-US/quick-docs/kernel/build-custom-kernel/</a></p></li>
</ul>
</div>
<div class="section" id="try-42">
<h2><a class="toc-backref" href="#id6">Try 42</a><a class="headerlink" href="#try-42" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt>or better yet, this one? (Laura Abbott)</dt><dd><p><a class="reference external" href="https://fedoramagazine.org/building-fedora-kernel/">https://fedoramagazine.org/building-fedora-kernel/</a></p>
</dd>
</dl>
<p>$ fedpkg clone -a kernel</p>
<p>fatal: the remote end hung up unexpectedly27 MiB | 1.09 MiB/s</p>
<p>retried, worked</p>
<p>being at 31,</p>
<p>$ cd kernel/
$ git checkout origin/f31</p>
<p>fedpkg local</p>
<p>coffee</p>
<p>done -&gt; pollution …</p>
<p>$ ls -l ./kernel-5.5.fc33/
total 305616
-rw-r–r–.  1 jfasch jfasch        31 Feb 27 08:00 debugfiles.list
-rw-r–r–.  1 jfasch jfasch    174194 Feb 27 08:00 debugfiles.list.dirs.sed
-rw-r–r–.  1 jfasch jfasch         0 Feb 27 08:00 debuginfodebug.list
-rw-r–r–.  1 jfasch jfasch    449975 Feb 27 08:00 debuginfo.list
-rw-r–r–.  1 jfasch jfasch         0 Feb 27 07:55 debuglinks.list
-rw-r–r–.  1 jfasch jfasch 311626830 Feb 27 07:59 debugsources.list
-rw-r–r–.  1 jfasch jfasch    307123 Feb 27 07:59 elfbins.list
-rw-r–r–.  1 jfasch jfasch         0 Feb 27 08:00 ignored-debuginfo.list
-rw-r–r–.  1 jfasch jfasch    208992 Feb 27 07:55 kernel-core.list
-rw-r–r–.  1 jfasch jfasch        16 Feb 27 07:51 kernel-ldsoconf.list
-rw-r–r–.  1 jfasch jfasch    154089 Feb 27 07:55 kernel-modules.list
drwxr-xr-x. 26 jfasch jfasch      4096 Feb 27 07:51 linux-5.6.0-0.rc3.git1.1.fc33.x86_64
drwxr-xr-x. 24 jfasch jfasch      4096 Jan 27 01:23 vanilla-5.5
drwxr-xr-x. 25 jfasch jfasch      4096 Feb 27 05:58 vanilla-5.6-rc3-git1</p>
<p>$ ls -l ./kernel-5.5.fc33/linux-5.6.0-0.rc3.git1.1.fc33.x86_64/</p>
<p>looks even more polluted, guess that is where kernel build took place
(in-source). copy away, to produce patch/diff.</p>
<p>cp -r ./kernel-5.5.fc33/linux-5.6.0-0.rc3.git1.1.fc33.x86_64/ /somewhere/else/</p>
<p>fix as above (jjj local ref):</p>
<p>emacs /somewhere/else/linux-5.6.0-0.rc3.git1.1.fc33.x86_64/drivers/usb/typec/ucsi/displayport.c</p>
<p>patch …</p>
<p><a class="reference external" href="https://fedoraproject.org/wiki/Kernel/Spec#Individual_patches">https://fedoraproject.org/wiki/Kernel/Spec#Individual_patches</a></p>
<p>jjjj</p>
<p>diff -ur ./kernel-5.5.fc33/linux-5.6.0-0.rc3.git1.1.fc33.x86_64 /somewhere/else/linux-5.6.0-0.rc3.git1.1.fc33.x86_64/ &gt; ./RIP-ucsi_displayport_remove_partner.patch</p>
<p>add to patch list in kernel.spec</p>
<p>rebuild:</p>
<p>fedpkg local</p>
<p>-&gt; error failed apply patch</p>
</div>
<div class="section" id="try-43">
<h2><a class="toc-backref" href="#id7">Try 43</a><a class="headerlink" href="#try-43" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://fedoraproject.org/wiki/Building_a_custom_kernel/Source_RPM">https://fedoraproject.org/wiki/Building_a_custom_kernel/Source_RPM</a></p>
<p>$ rpmdev-setuptree</p>
<p>effect: empty structure</p>
<p>$ tree ~/rpmbuild/
/home/jfasch/rpmbuild/
├── BUILD
├── RPMS
├── SOURCES
├── SPECS
└── SRPMS</p>
<div class="section" id="kernel-rpm-spec">
<h3><a class="toc-backref" href="#id8">kernel rpm/spec</a><a class="headerlink" href="#kernel-rpm-spec" title="Permalink to this headline">¶</a></h3>
<p>which? -&gt; ls -l /boot -&gt; vmlinuz-5.4.13-201.fc31.x86_64 -&gt; 5.4.13-201.fc31</p>
<p>$ koji download-build –arch=src kernel-5.4.13-201.fc31</p>
<p>-&gt; kernel-5.4.13-201.fc31.src.rpm</p>
<p>$ rpm -Uvh kernel-5.4.13-201.fc31.src.rpm</p>
<p>effect: source rpm placed into ~/rpmbuild</p>
<p>$ tree ~/rpmbuild/
/home/jfasch/rpmbuild/
├── BUILD
├── RPMS
├── SOURCES
│   ├── 0001-crypto-ccp-Release-all-allocated-memory-if-sha-type-.patch
│   ├── 0001-Drop-that-for-now.patch
… (blah) …
├── SPECS
│   └── kernel.spec
└── SRPMS</p>
</div>
<div class="section" id="make-patch">
<h3><a class="toc-backref" href="#id9">make patch</a><a class="headerlink" href="#make-patch" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://fedoraproject.org/wiki/Building_a_custom_kernel#Building_a_kernel_from_the_exploded_git_trees">https://fedoraproject.org/wiki/Building_a_custom_kernel#Building_a_kernel_from_the_exploded_git_trees</a></p>
<p>$ git clone git://git.kernel.org/pub/scm/linux/kernel/git/jwboyer/fedora.git
$ git checkout -b jfasch-fix remotes/origin/f31</p>
<p>fix drivers/usb/typec/ucsi/displayport.c</p>
<p>$ git commit -am ‘fix RIP:ucsi_displayport_remove_partner()’</p>
<p>use git log to find out the previous revision -&gt;
4382f76bc8ef9fce5e7e96d4cdb0c073564ad249</p>
<p>$ git format-patch -o /tmp 4382f76bc8ef9fce5e7e96d4cdb0c073564ad249
/tmp/0001-fix-RIP-ucsi_displayport_remove_partner.patch</p>
</div>
<div class="section" id="apply-patch">
<h3><a class="toc-backref" href="#id10">apply patch</a><a class="headerlink" href="#apply-patch" title="Permalink to this headline">¶</a></h3>
<p>$ cp /tmp/0001-fix-RIP-ucsi_displayport_remove_partner.patch ~/rpmbuild/SOURCES/RIP-ucsi_displayport_remove_partner.patch</p>
<p>$ cd ~/rpmbuild/SPECS/</p>
<ul class="simple">
<li><p>uncomment buildid</p></li>
<li><p>add patch</p></li>
</ul>
<p>literalinclude spec diff</p>
</div>
<div class="section" id="build">
<h3><a class="toc-backref" href="#id11">build</a><a class="headerlink" href="#build" title="Permalink to this headline">¶</a></h3>
<p>$ rpmbuild -bb –target=x86_64 kernel.spec</p>
</div>
</div>
<div class="section" id="certificate-things-gosh">
<h2><a class="toc-backref" href="#id12">Certificate Things Gosh</a><a class="headerlink" href="#certificate-things-gosh" title="Permalink to this headline">¶</a></h2>
<p># echo jfasch &gt;&gt; /etc/pesign/users
# /usr/libexec/pesign/pesign-authorize</p>
<dl class="simple">
<dt>$ openssl req -new -x509 -newkey rsa:2048 -keyout “key.pem” </dt><dd><p>-outform DER -out jfasch.der -nodes -days 36500 -subj “/CN=jfasch/”</p>
</dd>
</dl>
<p># mokutil –import jfasch.der
(remember password I had to give)</p>
<p>$ openssl pkcs12 -export -out jfasch.p12 -inkey jfasch.pem -in jfasch.der</p>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  Previous: 
  <a href="../../2012/04/Why-ps-sucks.html">
    
    “Why ps Sucks” or “Counting Memory Consumption”
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  </span>
</div>

  
  
  </div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Jörg Faschingbauer

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>