
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Saving Solid State Disk Life (Gentoo) &#8212; Jörg Faschingbauer 0.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/jf.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  
  <link rel="alternate" type="application/atom+xml"  href="../../../blog/atom.xml" title="Jörg Faschingbauer">
  
  
  <link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet">
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/logo.jpg" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Linux und Open Source</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><h3>Navigation</h3>
<p class="caption"><span class="caption-text">Schulungen</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../courses/index.html">Kursangebot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../courses/booking.html">Buchung, Kursablauf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../courses/material/index.html">Unterlagen &amp; Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../courses/records/index.html">Bisher Gehaltene Schulungen</a></li>
</ul>
<p class="caption"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about/myself/index.html">Über Mich</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about/site/index.html">This Site</a></li>
</ul>
<p class="caption"><span class="caption-text">Blog</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Posts</a></li>
</ul>


        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="saving-solid-state-disk-life-gentoo">
<h1>Saving Solid State Disk Life (Gentoo)<a class="headerlink" href="#saving-solid-state-disk-life-gentoo" title="Permalink to this headline">¶</a></h1>
<div class="sidebar">
<p class="sidebar-title">Contents</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#rant" id="id1">Rant</a></p></li>
<li><p><a class="reference internal" href="#no-swap" id="id2">No Swap</a></p></li>
<li><p><a class="reference internal" href="#tmpfs-instances-here-and-there" id="id3"><code class="docutils literal notranslate"><span class="pre">tmpfs</span></code> instances here and there</a></p></li>
<li><p><a class="reference internal" href="#syslog-var-log-messages" id="id4">Syslog, <code class="docutils literal notranslate"><span class="pre">/var/log/messages</span></code></a></p></li>
<li><p><a class="reference internal" href="#kernel-i-o-scheduler" id="id5">Kernel I/O Scheduler</a></p></li>
<li><p><a class="reference internal" href="#use-ram-for-the-kernel-build" id="id6">Use RAM for the Kernel Build</a></p></li>
<li><p><a class="reference internal" href="#things-that-are-left" id="id7">Things that are left</a></p></li>
</ul>
</div>
</div>
<div class="section" id="rant">
<h2><a class="toc-backref" href="#id1">Rant</a><a class="headerlink" href="#rant" title="Permalink to this headline">¶</a></h2>
<p>Today’s mechanical disks are optimized for writing one Excel sheet a
day it seems. Holding the browser cache significantly decreases
lifetime of a disk. Developing source code and compiling entire trees
multiple times a day, plus updating a Gentoo install once a week is a
recipe to kill a disk.</p>
<p>So I killed three (<em>three</em>) mechanical disks last year.</p>
<p>I pretty much depend on these disks as I don’t like moving back and
forth between the number one and the spare laptop three times in a
row. (I’m self employed, and the volume of such undertakings is
<em>indirectly</em> proportional to the flow of money into my pocket.)</p>
<p>Which is why I decided to purchase a solid state disk. My choice was a
Corsair Force Series 120. It has pretty good reviews on the Internet,
especially for having received a firmware overhaul that reserves less
space for the wear leveling management, thus leaving more of the space
to the user.</p>
<p>I should have known better. Fresh firmware is not cool; it has never
been. During the Gentoo install (no, I compile to RAM now, and <em>not</em>
to disk) there is a point where I reboot to switch away from the
Ubuntu LiveCD boot, into the fresh Gentoo system. That was the time
where the SSD has vanished - it was gone! No mention of it, nowhere.</p>
<p>Support request on the Corsair website, sent disk to their returns
department in the Netherlands. After a few days received an email
saying it would last unusually long as they had to cope with an
unusual volume of returns. Looks like I am not alone. I bet they
themselves write those SSD reviews you find on the Internet.</p>
<p>Anyway - after two more weeks of aggressive spare laptop harddisk
treatment I am now the proud owner of a 120G SSD with even fresher
firmware, and have set it up to a point where I can work with it. I
describe below what I did to extend its life, and what’s still to be
done. If you have recipes that target the same, please let me know.</p>
</div>
<div class="section" id="no-swap">
<h2><a class="toc-backref" href="#id2">No Swap</a><a class="headerlink" href="#no-swap" title="Permalink to this headline">¶</a></h2>
<p>I have plenty of RAM (4G), and I run Linux, so there shouldn’t be any
need to swap. Unfortunately hibernating does not work without swap
(the kernel uses swap to write the state into). I configured one
partition for the purpose of hibernating, which I don’t configure in
<code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>.</p>
<p>I usually suspend to RAM when at home, and when I move to the living
room or board a train to Germany then I hibernate like so,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># sync &amp;&amp; swapon /dev/sda1 &amp;&amp; echo disk &gt; /sys/power/state &amp;&amp; swapoff /dev/sda1</span>
</pre></div>
</div>
</div>
<div class="section" id="tmpfs-instances-here-and-there">
<h2><a class="toc-backref" href="#id3"><code class="docutils literal notranslate"><span class="pre">tmpfs</span></code> instances here and there</a><a class="headerlink" href="#tmpfs-instances-here-and-there" title="Permalink to this headline">¶</a></h2>
<p>The overall rule is, “You can read from a SSD as often as you want,
but don’t write to it.”. With this in mind, I immediately identify two
places where I write continuously, and which can be mitigated easily.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/tmp</span></code> is used by programs to hold small amounts of temporary data
which is perfect for a <code class="docutils literal notranslate"><span class="pre">tmpfs</span></code> instance.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/var/tmp/portage</span></code> is used by portage (Gentoo’s package installer)
to compile the packages before installation. I have plenty of RAM
(4G), so why not use that for compilation. See below for an
openoffice rant.</p></li>
</ul>
<p>All that needs to be done is add two entries to <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>portage-tmpfs /var/tmp/portage tmpfs rw <span class="m">0</span> <span class="m">0</span>
tmp-tmpfs     /tmp             tmpfs rw <span class="m">0</span> <span class="m">0</span>
</pre></div>
</div>
<p>You might want to set <code class="docutils literal notranslate"><span class="pre">TMPDIR=/tmp</span></code> explicitly, to have GCC write
its temporary files there instead of in its current working
directory. Create a dedicated file in <code class="docutils literal notranslate"><span class="pre">/etc/env.d</span></code>, and call
<code class="docutils literal notranslate"><span class="pre">env-update</span></code>.</p>
<p>I could limit the space on these by writing <code class="docutils literal notranslate"><span class="pre">rw,size=500m</span></code> for
example. Anyway, <code class="docutils literal notranslate"><span class="pre">tmpfs</span></code> limits its size to be half the memory as a
default, so in my case this is 2G in each instance.</p>
<p>I hit the limit on the <code class="docutils literal notranslate"><span class="pre">/var/tmp/portage</span></code> instance really soon, when
I tried to install openoffice. That piece of crap requires 6G of disk
space for compilation! Ok, I take it I have to make an exception which
reads like so,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># # (plug my USB throwaway 1TB disk)</span>
<span class="c1"># mount /dev/sdc1 /mnt/disk</span>
<span class="c1"># mkdir /mnt/disk/tmp-portage</span>
<span class="c1"># mount --bind /mnt/disk/tmp-portage /var/tmp/portage</span>
<span class="c1"># emerge openoffice</span>
<span class="c1"># # (wait a day or two)</span>
<span class="c1"># rm -rf /mnt/disk/tmp-portage</span>
<span class="c1"># umount /var/tmp/portage</span>
<span class="c1"># umount /mnt/disk</span>
</pre></div>
</div>
</div>
<div class="section" id="syslog-var-log-messages">
<h2><a class="toc-backref" href="#id4">Syslog, <code class="docutils literal notranslate"><span class="pre">/var/log/messages</span></code></a><a class="headerlink" href="#syslog-var-log-messages" title="Permalink to this headline">¶</a></h2>
<p>I like to watch <code class="docutils literal notranslate"><span class="pre">/var/log/messages</span></code>, and in fact I have <code class="docutils literal notranslate"><span class="pre">tail</span> <span class="pre">-f</span>
<span class="pre">/var/log/messages</span></code> runnung in a dedicated terminal. I usually have no
interest in keeping the logfile; the last time the kernel crashed was
when I had put an offending debug message into <code class="docutils literal notranslate"><span class="pre">i2c-dev.c</span></code> to trap a
userspace error I had made. And that was on the Beagleboard.</p>
<p>So, <code class="docutils literal notranslate"><span class="pre">/var/log/messages</span></code> is another candidate for <code class="docutils literal notranslate"><span class="pre">tmpfs</span></code>. Complications:</p>
<ul class="simple">
<li><p>Restrict the file in size, which is best done by <code class="docutils literal notranslate"><span class="pre">logrotate</span></code>.</p></li>
<li><p>Cannot use <code class="docutils literal notranslate"><span class="pre">/var/log</span></code> as mountpoint for the <code class="docutils literal notranslate"><span class="pre">tmpfs</span></code>, as there’s
more in that directory.</p></li>
</ul>
<div class="section" id="mountpoint-for-messages">
<h3>Mountpoint for messages<a class="headerlink" href="#mountpoint-for-messages" title="Permalink to this headline">¶</a></h3>
<p>I create a dedicated directory as a mountpoint, moving the
<code class="docutils literal notranslate"><span class="pre">messages</span></code> one level deeper,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># rm /var/log/messages</span>
<span class="c1"># mkdir /var/log/messages</span>
</pre></div>
</div>
<p>Mount a <code class="docutils literal notranslate"><span class="pre">tmpfs</span></code> there, using <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>messages-tmp  /var/log/messages tmpfs rw <span class="m">0</span> <span class="m">0</span>
</pre></div>
</div>
<p>At this point you use <code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">-a</span></code> to immediately create the
mount. Next, tell <code class="docutils literal notranslate"><span class="pre">syslog-ng</span></code> about it. In
<code class="docutils literal notranslate"><span class="pre">/etc/syslog-ng/syslog-ng.conf</span></code> write,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
destination messages <span class="o">{</span> file<span class="o">(</span><span class="s2">&quot;/var/log/messages/messages&quot;</span><span class="o">)</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
<span class="c1"># ...</span>
</pre></div>
</div>
</div>
<div class="section" id="logrotate">
<h3>Logrotate<a class="headerlink" href="#logrotate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># emerge app-admin/logrotate</span>
</pre></div>
</div>
<p>Make sure <code class="docutils literal notranslate"><span class="pre">cron</span></code> is running (<code class="docutils literal notranslate"><span class="pre">rc-status|grep</span> <span class="pre">cron</span></code>, he runs <code class="docutils literal notranslate"><span class="pre">logrotate</span></code>). <code class="docutils literal notranslate"><span class="pre">syslog-ng</span></code> already comes with a <code class="docutils literal notranslate"><span class="pre">logrotate</span></code> configuration file, <code class="docutils literal notranslate"><span class="pre">/etc/logrotate.d/syslog-ng</span></code>. Tune this to our needs (rotate the file when its size exceeds 20M, keeping one compressed copy).</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>/var/log/messages/messages <span class="o">{</span>
     compress
     compresscmd /bin/bzip2
     compressoptions -9
     compressext .bz2
     size 20M
     rotate <span class="m">1</span>
     missingok
     sharedscripts
     postrotate
         /etc/init.d/syslog-ng reload &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="o">||</span> <span class="nb">true</span>
     endscript
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="kernel-i-o-scheduler">
<h2><a class="toc-backref" href="#id5">Kernel I/O Scheduler</a><a class="headerlink" href="#kernel-i-o-scheduler" title="Permalink to this headline">¶</a></h2>
<p>The kernel uses an algorithm called an I/O scheduler to optimize disk access. It does this by collecting read and write requests at adjacent disk locations. This is not necessary with SSDs as there are no disks and no heads. I switch off the scheduler for <code class="docutils literal notranslate"><span class="pre">sda</span></code> (which is the SSD), and keep the default scheduler (<code class="docutils literal notranslate"><span class="pre">cfq</span></code>) for USB disks I use to plug on occasion (for example if there’s an openoffice update).&lt;/p&gt;&lt;p&gt;In <code class="docutils literal notranslate"><span class="pre">/etc/conf.d/local.start</span></code> I write,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> noop &gt; /sys/block/sda/queue/scheduler
</pre></div>
</div>
</div>
<div class="section" id="use-ram-for-the-kernel-build">
<h2><a class="toc-backref" href="#id6">Use RAM for the Kernel Build</a><a class="headerlink" href="#use-ram-for-the-kernel-build" title="Permalink to this headline">¶</a></h2>
<p>I am a big believer in out-of-source builds. The kernel build system
is also capable of it, and I use to build the kernel in <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> like
so.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># mkdir /tmp/kernel-build</span>
<span class="c1"># cp /boot/linux-2.6.36-gentoo-r5/.config /tmp/kernel-build</span>
<span class="c1"># make -C /usr/src/linux O=/tmp/kernel-build oldconfig</span>
<span class="c1"># make -C /usr/src/linux O=/tmp/kernel-build menuconfig</span>
<span class="c1"># make -C /usr/src/linux O=/tmp/kernel-build all</span>
<span class="c1"># ...</span>
</pre></div>
</div>
<p>Don’t forget to save away the <code class="docutils literal notranslate"><span class="pre">.config</span></code> file, as it will be gone
after a reboot. I use to store it along with the kernel image in
<code class="docutils literal notranslate"><span class="pre">/boot/linux-2.6.36-gentoo-r5</span></code>.</p>
</div>
<div class="section" id="things-that-are-left">
<h2><a class="toc-backref" href="#id7">Things that are left</a><a class="headerlink" href="#things-that-are-left" title="Permalink to this headline">¶</a></h2>
<p>There are a couple of things that still need work.</p>
<ul class="simple">
<li><p>Xorg appears to have a hardcoded log location; I didn’t find a
config option to have it write its <code class="docutils literal notranslate"><span class="pre">Xorg.0.log</span></code> in a directory
other than <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>.</p></li>
<li><p>There appears to be bug in portage; it does not respect the
<code class="docutils literal notranslate"><span class="pre">EMERGE_LOG_DIR</span></code> variable. Otherwise, I could redirect the files
<code class="docutils literal notranslate"><span class="pre">emerge.log</span></code> and <code class="docutils literal notranslate"><span class="pre">emerge-fetch.log</span></code> out of <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>, just
like I do with <code class="docutils literal notranslate"><span class="pre">/var/log/messages</span></code>.</p></li>
<li><p>The fact remains that I build my own projects on disk. I have to
solve that somehow; I am thinking of using <code class="docutils literal notranslate"><span class="pre">aufs</span></code> or
<code class="docutils literal notranslate"><span class="pre">unionfs-fuse</span></code> to partly persist those. Some scripting around it
maybe, to persist those parts of the build which are currently in
ram. But this is another story, maybe I’ll write about it when I
know what I want.</p></li>
</ul>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  
  <a href="porting-to-linux-there-s-always-a-better-way.html">
    <i class="fa fa-arrow-circle-left"></i>
    Porting to Linux (There’s Always A Better Way)
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  
  <a href="../../2012/04/Why-ps-sucks.html">
    “Why ps Sucks” or “Counting Memory Consumption”
    <i class="fa fa-arrow-circle-right"></i>
  </a>
  
  </span>
</div>

  
  
  </div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2020, Jörg Faschingbauer.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/blog/2011/01/saving-solid-state-disk-life--gentoo.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>