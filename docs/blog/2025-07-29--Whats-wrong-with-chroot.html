
<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Why Use A Container When There Is chroot? &#8212; Jörg Faschingbauer</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css?v=572af1d6" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/css/lightbox.min.css?v=6e7d0de0" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/pointer.css?v=c97663ff" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=128c0548" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/js/lightbox-plus-jquery.min.js?v=f0ca4bb6"></script>
    <script src="../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js?v=12818e64"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'blog/2025-07-29--Whats-wrong-with-chroot';</script>
    <link rel="canonical" href="https://www.faschingbauer.me/blog/2025-07-29--Whats-wrong-with-chroot.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" /> 
<link
  rel="alternate"
  type="application/atom+xml"
  href="index/atom.xml"
  title="Jörg Faschingbauer"
/>
  
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Jörg Faschingbauer - Home"/>
    <img src="../_static/logo.png" class="logo__image only-dark pst-js-only" alt="Jörg Faschingbauer - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../trainings/index.html">
    Training Courses
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about/index.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="postlist.html">
    Blog
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../trainings/index.html">
    Training Courses
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about/index.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="postlist.html">
    Blog
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<div class="ablog-sidebar-item ablog__postcard">
   
  <h2>
     
    <i class="fa fa-calendar"></i>
    
    <span>26 September 2025</span>
    
  </h2>
  <ul>
    <div class="ablog-sidebar-item ablog__postcard2">
   
  <li id="ablog-sidebar-item author ablog__author">
    <span>
      
      <i class="fa-fw fa fa-user"></i>
      
    </span>
     
    <a href="index/author/jorg-faschingbauer.html">Jörg Faschingbauer</a>
      
  </li>
     
  <li id="ablog-sidebar-item category ablog__category">
    <span>
      
      <i class="fa-fw fa fa-folder-open"></i>
      
    </span>
     
    <a href="index/category/linux.html">linux</a>
     ,    
    <a href="index/category/embedded.html">embedded</a>
      
  </li>
    
</div>
  </ul>
</div>
</div>
        <div class="sidebar-primary-item">
<div class="ablog-sidebar-item ablog__recentposts">
  <h3>
    <a href="index.html">Recent Posts</a>
  </h3>
  <ul>
     
    <li>
      <a href="2022-09-23--cross-raspi.html">
        23 September - Building A Cross Toolchain For The Raspberry Pi, Using crosstool-ng
      </a>
    </li>
    
    <li>
      <a href="2021-09-12--xps13-shim-mok-brick.html">
        12 September - How to Brick a €1399 Dell XPS 13
      </a>
    </li>
    
    <li>
      <a href="2021-08-26--grintovec.html">
        26 August - Grintovec (via Planšarsko Jezero, Češka Koča)
      </a>
    </li>
    
    <li>
      <a href="2020-09-07--traunstein.html">
        07 September - Traunstein via Zierlersteig
      </a>
    </li>
    
    <li>
      <a href="2020-04-19--bbb.html">
        19 April - Using BigBlueButton for Online Training
      </a>
    </li>
    
  </ul>
</div>
</div>
        <div class="sidebar-primary-item">
<div class="ablog-sidebar-item ablog__categories">
  <h3>
    <a href="index/category.html">Categories</a>
  </h3>
  <ul>
     
    <li>
      <a href="index/category/embedded.html">embedded (4)</a>
    </li>
      
    <li>
      <a href="index/category/kernel.html">kernel (1)</a>
    </li>
      
    <li>
      <a href="index/category/linux.html">linux (8)</a>
    </li>
      
    <li>
      <a href="index/category/microsoft.html">microsoft (1)</a>
    </li>
      
    <li>
      <a href="index/category/outdoor.html">outdoor (2)</a>
    </li>
      
    <li>
      <a href="index/category/raspberry.html">raspberry (1)</a>
    </li>
      
    <li>
      <a href="index/category/sphinx.html">sphinx (2)</a>
    </li>
      
    <li>
      <a href="index/category/training.html">training (1)</a>
    </li>
     
  </ul>
</div>
</div>
        <div class="sidebar-primary-item">
<div class="ablog-sidebar-item ablog__authors">
  <h3>
    <a href="index/author.html">Authors</a>
  </h3>
  <ul>
     
    <li>
      <a href="index/author/jorg-faschingbauer.html">Jörg Faschingbauer (14)</a>
    </li>
     
  </ul>
</div>
</div>
        <div class="sidebar-primary-item">
<div class="ablog-sidebar-item ablog__archives">
  <h3>
    <a href="index/archive.html">Archives</a>
  </h3>
  <ul>
     
    <li>
      <a href="index/2025.html">2025 (1)</a>
    </li>
      
    <li>
      <a href="index/2022.html">2022 (1)</a>
    </li>
      
    <li>
      <a href="index/2021.html">2021 (2)</a>
    </li>
      
    <li>
      <a href="index/2020.html">2020 (6)</a>
    </li>
      
    <li>
      <a href="index/2012.html">2012 (1)</a>
    </li>
      
    <li>
      <a href="index/2011.html">2011 (2)</a>
    </li>
      
    <li>
      <a href="index/2010.html">2010 (1)</a>
    </li>
     
  </ul>
</div>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Why Use A Container When There Is <code class="docutils literal notranslate"><span class="pre">chroot</span></code>?</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                   <section id="why-use-a-container-when-there-is-chroot">
<h1>Why Use A Container When There Is <code class="docutils literal notranslate"><span class="pre">chroot</span></code>?<a class="headerlink" href="#why-use-a-container-when-there-is-chroot" title="Link to this heading">#</a></h1>
<p>I cannot build <a class="reference external" href="https://docs.yoctoproject.org/migration-guides/migration-5.2.html">Yocto “Walnascar”</a>
natively on my Fedora 42 - it is not supported <a class="footnote-reference brackets" href="#yocto-tried" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>. So I
was looking for a way to “isolate” a supported distribution (Fedora 41
for that matter) inside Fedora 42.</p>
<p>I had done this a number of times before: using a subdirectory on one
OS as the root directory for another OS, combining a few features like
<code class="docutils literal notranslate"><span class="pre">chroot</span></code> and bind mounts. Also, I am always looking for
opportunities to <a class="reference internal" href="../trainings/index.html"><span class="doc">explain people the world</span></a> -
setting up a <code class="docutils literal notranslate"><span class="pre">chroot</span></code> jail in front the audience would not only
explain what <code class="docutils literal notranslate"><span class="pre">chroot</span></code> is, but also what a root directory is.</p>
<p>After a number of attempts to contain myself (speak: <a class="reference external" href="https://www.docker.com/">Docker</a> and <a class="reference external" href="https://www.freedesktop.org/software/systemd/man/latest/systemd-nspawn.html">systemd-nspawn</a>),
I came to the conclusion that a virtual machine, however lightweight,
was still too heavy for my task.</p>
<p>Read on to see how easy it is to setup a “container” without having to
install any additional baggage than the contained OS itself. Jump
directly to <a class="reference internal" href="#blog-chroot-decontainerized-simple"><span class="std std-ref">chroot: De-Containerization (Minimal busybox Root Filesystem)</span></a> to skip my case
against Docker and read the full explanation of everything. Jump to
<a class="reference internal" href="#blog-chroot-short-fedora41"><span class="std std-ref">Repeat, In A Real Distro Jail (Fedora 41)</span></a> if you don’t want any explanation
but only want the pure commandlines for a Fedora 41 <code class="docutils literal notranslate"><span class="pre">chroot</span></code>.</p>
<section id="container-attempts">
<span id="blog-chroot-container-attempts"></span><h2>Container Attempts<a class="headerlink" href="#container-attempts" title="Link to this heading">#</a></h2>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#docker" id="id25">Docker</a></p></li>
<li><p><a class="reference internal" href="#systemd-nspawn" id="id26"><code class="docutils literal notranslate"><span class="pre">systemd-nspawn</span></code></a></p></li>
<li><p><a class="reference internal" href="#conclusion" id="id27">Conclusion</a></p></li>
</ul>
</nav>
<section id="docker">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Docker</a><a class="headerlink" href="#docker" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://www.docker.com/">Docker</a> was my first choice. Colleagues
are using it a lot to do build stuff, and are happy with its
convenience. Convenience - e.g. gazillions of images to download from
<a class="reference external" href="https://hub.docker.com/">Docker Hub</a> - might be the primary reason
why Docker is so popular.</p>
<p>Installed docker, pulled <code class="docutils literal notranslate"><span class="pre">fedora:41</span></code> from <a class="reference external" href="https://hub.docker.com/">Docker Hub</a>. Read docs, managed to get a
shell. Further steps would have been to mount my home directory into
it, to solve my original problem - build Yocto.</p>
<p>While digging around I found the alarmistic article <a class="reference external" href="https://quantum5.ca/2025/03/18/docker-considered-harmful/">“Docker
considered harmful”</a> which
is really worth a read. I mean, it’s probably me - I am really
sceptical about any hype, and it takes very little (for example, an
article titled “Docker considered harmful” 😉) for me to run
away.</p>
</section>
<section id="systemd-nspawn">
<h3><a class="toc-backref" href="#id26" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">systemd-nspawn</span></code></a><a class="headerlink" href="#systemd-nspawn" title="Link to this heading">#</a></h3>
<p>Since <code class="docutils literal notranslate"><span class="pre">systemd</span></code> took place, everything just works. <code class="docutils literal notranslate"><span class="pre">systemd</span></code>
always used Linux <a class="reference external" href="https://man7.org/linux/man-pages/man7/cgroups.7.html">cgroups</a>
<a class="footnote-reference brackets" href="#cgroups-docker" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> and <a class="reference external" href="https://man7.org/linux/man-pages/man7/namespaces.7.html">namespaces</a> to run
services at different isolation levels. <code class="docutils literal notranslate"><span class="pre">systemd-nspawn</span></code> (<a class="reference external" href="https://www.freedesktop.org/software/systemd/man/latest/systemd-nspawn.html">here</a>)
is a logical step further. It is It has been created by the
<code class="docutils literal notranslate"><span class="pre">systemd</span></code> team to test <code class="docutils literal notranslate"><span class="pre">systemd</span></code> itself, and is comparable to
Docker in many ways.</p>
<p>After my Docker experience, I was still in a mood for
self-modernization. I decided to give <code class="docutils literal notranslate"><span class="pre">systemd-nspawn</span></code> a try, partly
because its documentation compares it with <code class="docutils literal notranslate"><span class="pre">chroot</span></code>, only on
steroids.</p>
<p>Long story short: network setup for nspawn containers works best when
the host system’s network is managed by <code class="docutils literal notranslate"><span class="pre">systemd-networkd</span></code>. My
machine runs GNOME, which works best together with GNOME’s
<code class="docutils literal notranslate"><span class="pre">NetworkManager</span></code>, which again is perfectly integrated with
<code class="docutils literal notranslate"><span class="pre">wpa_supplicant</span></code>. <code class="docutils literal notranslate"><span class="pre">systemd-networkd</span></code> has no idea what
<code class="docutils literal notranslate"><span class="pre">wpa_supplicant</span></code> is. Doing everything by hand is a cool learning
experience, but does not help me get the job (remember: Yocto) done.</p>
</section>
<section id="conclusion">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">Conclusion</a><a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h3>
<p>I’m sure I’d have been able to build bloody Yocto going the
containerization route. On the other hand, all I wanted was to have a
shell in an isolated environment, and from there access to my home
directory <em>outside</em> that environment.</p>
<p>If I went down that route though, I’d have to think a lot more.</p>
<ul class="simple">
<li><p>Learn about the containerization technology, especially:</p></li>
<li><p>How does the technology want me to configure access to my outside
home directory</p></li>
<li><p>If I access my outside home directory, how would that go together
with UID isolation?</p></li>
<li><p>How about network access? I don’t want <em>any</em> isolation at that
level. If you are building a cluster of microservices, each one
running in a different container, you’d probably want network
virtualization/isolation - I don’t, however.</p></li>
</ul>
<p><strong>But again</strong>: my only problem is that I want to build Yocto on Fedora
42 which is not supported by Yocto. I know what <code class="docutils literal notranslate"><span class="pre">chroot</span></code> is, I know
what a <em>bind mount</em> is, I know what Linux is - so I should be able to
solve my problem in a minimal and hype-less way.</p>
</section>
</section>
<section id="chroot-de-containerization-minimal-busybox-root-filesystem">
<span id="blog-chroot-decontainerized-simple"></span><h2><code class="docutils literal notranslate"><span class="pre">chroot</span></code>: De-Containerization (Minimal <code class="docutils literal notranslate"><span class="pre">busybox</span></code> Root Filesystem)<a class="headerlink" href="#chroot-de-containerization-minimal-busybox-root-filesystem" title="Link to this heading">#</a></h2>
<p>I’ll begin with a minimal <code class="docutils literal notranslate"><span class="pre">busybox</span></code> root filesystem. The likelihood
that this particular approach will let me build Yocto is relatively
low again, but it lets me present the fundamentals without confusing
you with distro specific things. If you already know enough you may
well jump ahead and read the section where I <a class="reference internal" href="#blog-chroot-short-fedora41"><span class="std std-ref">repeat the whole
thing with Fedora 41</span></a> instead of
<code class="docutils literal notranslate"><span class="pre">busybox</span></code>.</p>
<p><strong>Conventions</strong></p>
<p>I the remainder, I’ll not use <code class="docutils literal notranslate"><span class="pre">sudo</span></code> to execute commands as root.
Rather, I’ll use</p>
<ul class="simple">
<li><p>the hash sign (<code class="docutils literal notranslate"><span class="pre">#</span></code>) as prompt when the command is run as root</p></li>
<li><p>the dollar sign (<code class="docutils literal notranslate"><span class="pre">$</span></code>) when the command is run as normal user</p></li>
</ul>
<p>To help you distinguish commands that I run inside the jail from those
that are run on the host system, I try to annotate code blocks
accordingly (“Inside jail”, “Outside jail”).</p>
<nav class="contents local" id="id3">
<ul class="simple">
<li><p><a class="reference internal" href="#chroot-jail" id="id28"><code class="docutils literal notranslate"><span class="pre">chroot</span></code> Jail</a></p></li>
<li><p><a class="reference internal" href="#proc" id="id29"><code class="docutils literal notranslate"><span class="pre">proc</span></code></a></p></li>
<li><p><a class="reference internal" href="#devtmpfs-and-dev-shm" id="id30"><code class="docutils literal notranslate"><span class="pre">devtmpfs</span></code> (And <code class="docutils literal notranslate"><span class="pre">/dev/shm</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#bind-mounts" id="id31">Bind Mounts</a></p>
<ul>
<li><p><a class="reference internal" href="#home-directory" id="id32">Home Directory</a></p></li>
<li><p><a class="reference internal" href="#network-etc-resolv-conf" id="id33">Network/<code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#working-as-non-root-inside-a-jail-and-uid-non-isolation" id="id34">Working As Non <code class="docutils literal notranslate"><span class="pre">root</span></code> Inside A Jail (And UID Non-Isolation)</a></p>
<ul>
<li><p><a class="reference internal" href="#option-1-simply-use-numeric-ids-inside" id="id35">Option 1: Simply Use Numeric IDs <em>Inside</em></a></p></li>
<li><p><a class="reference internal" href="#option-2-create-user-record-inside" id="id36">Option 2: Create User Record <em>Inside</em></a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="chroot-jail">
<span id="blog-chroot-chroot-jail"></span><h3><a class="toc-backref" href="#id28" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">chroot</span></code> Jail</a><a class="headerlink" href="#chroot-jail" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">chroot</span></code> is a system call (<a class="reference external" href="https://man7.org/linux/man-pages/man2/chroot.2.html">documentation</a>) that changes
the root directory of the calling process to its single parameter
which has to be a directory. In effect, it redirects path traversal to
start from that directory. This is best explained using an example,
using a shell command <code class="docutils literal notranslate"><span class="pre">chroot</span></code> with the same name (<a class="reference external" href="https://man7.org/linux/man-pages/man1/chroot.1.html">documentation</a>).</p>
<p>Below is a functional (although rather pointless) root filesystem,
implemented using the neat <code class="docutils literal notranslate"><span class="pre">busybox</span></code> (<a class="reference external" href="https://github.com/brgl/busybox">Github</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/BusyBox">Wikipedia</a>).</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">Outside jail</span><a class="headerlink" href="#id7" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>tree<span class="w"> </span>~/Machines/Simple-Busybox
<span class="go">/home/jfasch/Machines/Simple-Busybox</span>
<span class="go">└── bin</span>
<span class="go">    ├── busybox</span>
<span class="go">    ├── ls -&gt; /bin/busybox</span>
<span class="go">    └── sh -&gt; /bin/busybox</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">chroot</span></code> command is used to execute a command <em>inside</em> the
“jail”. The root directory of that process, and all of its
descendants, is <em>the jail</em>,
<code class="docutils literal notranslate"><span class="pre">/home/jfasch/Machines/Simple-Busybox</span></code>. Here we enclose an instance
of <code class="docutils literal notranslate"><span class="pre">/bin/sh</span></code> (actually
<code class="docutils literal notranslate"><span class="pre">/home/jfasch/Machines/Simple-Busybox/bin/sh</span></code>) into the “container”
<code class="docutils literal notranslate"><span class="pre">/home/jfasch/Machines/Simple-Busybox</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">Outside jail</span><a class="headerlink" href="#id8" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>chroot<span class="w"> </span>~/Machines/Simple-Busybox<span class="w"> </span>/bin/sh
<span class="gp">#            </span><span class="c1"># &lt;-- inside jail</span>
<span class="gp"># </span><span class="nb">pwd</span><span class="w">        </span><span class="c1"># &lt;-- actually /home/jfasch/Machines/Simple-Busybox</span>
<span class="go">/</span>
<span class="gp"># </span>ls<span class="w">         </span><span class="c1"># &lt;-- busybox ls</span>
<span class="go">bin</span>
<span class="gp"># </span>ls<span class="w"> </span>/bin
<span class="go">busybox  ls       sh</span>
</pre></div>
</div>
</div>
</section>
<section id="proc">
<span id="blog-chroot-proc"></span><h3><a class="toc-backref" href="#id29" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">proc</span></code></a><a class="headerlink" href="#proc" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">proc</span></code> is a virtual filesystem which implements, among other things,
a view into the kernel’s process list. It is usually mounted in the
root filesystem under <code class="docutils literal notranslate"><span class="pre">/proc</span></code>, and is used by tools like <code class="docutils literal notranslate"><span class="pre">ps</span></code> and
<code class="docutils literal notranslate"><span class="pre">lsof</span></code> to retrieve the information they need. Busybox <code class="docutils literal notranslate"><span class="pre">ps</span></code>, as an
example, fails without a populated <code class="docutils literal notranslate"><span class="pre">/proc</span></code> <a class="footnote-reference brackets" href="#empty-is-not-fail" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>:</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">Inside jail</span><a class="headerlink" href="#id9" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>busybox<span class="w"> </span>ps
<span class="go">PID   USER     TIME  COMMAND</span>
</pre></div>
</div>
</div>
<p>To make <code class="docutils literal notranslate"><span class="pre">proc</span></code> available inside the jail, we create a mountpoint
<code class="docutils literal notranslate"><span class="pre">/proc</span></code> (inside), and mount a <code class="docutils literal notranslate"><span class="pre">proc</span></code> instance on it. On the host
(err: from outside the jail, as <code class="docutils literal notranslate"><span class="pre">root</span></code>):</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">Outside jail</span><a class="headerlink" href="#id10" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span><span class="nb">pwd</span>
<span class="go">/home/jfasch/Machines</span>
<span class="gp"># </span>mkdir<span class="w"> </span>Simple-Busybox/proc
<span class="gp"># </span>mount<span class="w"> </span>-t<span class="w"> </span>proc<span class="w"> </span>proc<span class="w"> </span>Simple-Busybox/proc
</pre></div>
</div>
</div>
<p>Retry <code class="docutils literal notranslate"><span class="pre">busybox</span> <span class="pre">ps</span></code> inside, and see a the full process list.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">Inside jail</span><a class="headerlink" href="#id11" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>busybox<span class="w"> </span>ps
<span class="go">PID   USER     TIME  COMMAND</span>
<span class="go">    1 0         0:12 /usr/lib/systemd/systemd --switched-root --system --deserialize=52 rhgb</span>
<span class="go">    2 0         0:00 [kthreadd]</span>
<span class="go">    3 0         0:00 [pool_workqueue_]</span>
<span class="go">    4 0         0:00 [kworker/R-rcu_g]</span>
<span class="go">...</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">chroot</span></code> has nothing to do with <em>isolation</em>: from <em>inside the
jail</em>, we see all processes that were started <em>outside the jail</em>
too.</p>
</div>
</section>
<section id="devtmpfs-and-dev-shm">
<span id="blog-chroot-devtmpfs"></span><h3><a class="toc-backref" href="#id30" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">devtmpfs</span></code> (And <code class="docutils literal notranslate"><span class="pre">/dev/shm</span></code>)</a><a class="headerlink" href="#devtmpfs-and-dev-shm" title="Link to this heading">#</a></h3>
<p>Another virtual filesystem, of type <code class="docutils literal notranslate"><span class="pre">devtmpfs</span></code>, is usually mounted
at <code class="docutils literal notranslate"><span class="pre">/dev/</span></code>. For our purposes, it provides special files like
<code class="docutils literal notranslate"><span class="pre">/dev/null</span></code> which are used occasionally in less trivial root
filesystems. (Our simple Busybox root doesn’t.) Make that available
much like we did with <code class="docutils literal notranslate"><span class="pre">/proc</span></code></p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">Outside jail</span><a class="headerlink" href="#id12" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mkdir<span class="w"> </span>Simple-Busybox/dev
<span class="gp"># </span>mount<span class="w"> </span>-t<span class="w"> </span>devtmpfs<span class="w"> </span>dev<span class="w"> </span>Simple-Busybox/dev
</pre></div>
</div>
</div>
<p>There is another filesystem type, <code class="docutils literal notranslate"><span class="pre">tmpfs</span></code>, which is a plain RAM
based filesystem (no persistence). An instance of it is usually
mounted at <code class="docutils literal notranslate"><span class="pre">/dev/shm</span></code>, to hold POSIX IPC artifacts like semaphores
and shared memory. Yocto uses POSIX IPC heavily; lets create it while
we are at it.</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">Outside jail</span><a class="headerlink" href="#id13" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mkdir<span class="w"> </span>Simple-Busybox/dev/shm
<span class="gp"># </span>mount<span class="w"> </span>-t<span class="w"> </span>tmpfs<span class="w"> </span>shm<span class="w"> </span>Simple-Busybox/dev/shm
</pre></div>
</div>
</div>
</section>
<section id="bind-mounts">
<h3><a class="toc-backref" href="#id31" role="doc-backlink">Bind Mounts</a><a class="headerlink" href="#bind-mounts" title="Link to this heading">#</a></h3>
<p>To access files outside the jail, one would have to navigate past the
root of the jail upwards in the hierarchy. This is not possible -
which is the entire point of <code class="docutils literal notranslate"><span class="pre">chroot</span></code>. Instead, <em>bind mounts</em> are
used to make <em>outside content</em> visible <em>inside</em>.</p>
<section id="home-directory">
<span id="blog-chroot-bind-home"></span><h4><a class="toc-backref" href="#id32" role="doc-backlink">Home Directory</a><a class="headerlink" href="#home-directory" title="Link to this heading">#</a></h4>
<p>To make my home directory visible inside the jail, we create a
mountpoint <code class="docutils literal notranslate"><span class="pre">/home/jfasch</span></code> <em>inside</em>, and mount the <em>outside</em>
<code class="docutils literal notranslate"><span class="pre">/home/jfasch</span></code> onto it.</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">Outside jail</span><a class="headerlink" href="#id14" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mkdir<span class="w"> </span>-p<span class="w"> </span>Simple-Busybox/home/jfasch
<span class="gp"># </span>chown<span class="w"> </span>jfasch:jfasch<span class="w"> </span>Simple-Busybox/home/jfasch
<span class="gp"># </span>mount<span class="w"> </span>--bind<span class="w"> </span>/home/jfasch<span class="w"> </span>Simple-Busybox/home/jfasch
</pre></div>
</div>
</div>
</section>
<section id="network-etc-resolv-conf">
<h4><a class="toc-backref" href="#id33" role="doc-backlink">Network/<code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code></a><a class="headerlink" href="#network-etc-resolv-conf" title="Link to this heading">#</a></h4>
<p>No isolation is cool - I can use the host network inside the jail
(simply because the concept “host” does not exist).</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">Inside jail</span><a class="headerlink" href="#id15" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>busybox<span class="w"> </span>ping<span class="w"> </span><span class="m">142</span>.251.39.36
<span class="go">PING 142.251.39.36 (142.251.39.36): 56 data bytes</span>
<span class="go">64 bytes from 142.251.39.36: seq=0 ttl=114 time=36.571 ms</span>
<span class="go">64 bytes from 142.251.39.36: seq=1 ttl=114 time=21.538 ms</span>
<span class="go">...</span>
</pre></div>
</div>
</div>
<p>One minor problem though that is easily solved: DNS names. When you
instead say <code class="docutils literal notranslate"><span class="pre">ping</span> <span class="pre">www.google.com</span></code>, the command fails because DNS
name resolution fails.</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">Inside jail</span><a class="headerlink" href="#id16" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>busybox<span class="w"> </span>ping<span class="w"> </span>www.google.com
<span class="go">ping: bad address &#39;www.google.com&#39;</span>
</pre></div>
</div>
</div>
<p>The so-called <em>resolver</em> is a bunch of routines inside the C library
that do DNS name resolution. The resolver is configured with a file
<code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> on the “host”. To make that file available inside
the jail, again a mountpoint needs to be created (yes, a file can also
serve as a mountpoint), and then <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> can be bind
mounted into the jail.</p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">Outside jail</span><a class="headerlink" href="#id17" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>touch<span class="w"> </span>Simple-Busybox/etc/resolv.conf
<span class="gp"># </span>mount<span class="w"> </span>--bind<span class="w"> </span>/etc/resolv.conf<span class="w"> </span>Simple-Busybox/etc/resolv.conf
</pre></div>
</div>
</div>
<p>Verify all is well,</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">Inside jail</span><a class="headerlink" href="#id18" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>busybox<span class="w"> </span>ping<span class="w"> </span>www.google.com
<span class="go">PING www.google.com (142.250.180.228): 56 data bytes</span>
<span class="go">64 bytes from 142.250.180.228: seq=0 ttl=114 time=24.807 ms</span>
<span class="go">64 bytes from 142.250.180.228: seq=1 ttl=114 time=28.564 ms</span>
<span class="go">...</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="working-as-non-root-inside-a-jail-and-uid-non-isolation">
<h3><a class="toc-backref" href="#id34" role="doc-backlink">Working As Non <code class="docutils literal notranslate"><span class="pre">root</span></code> Inside A Jail (And UID Non-Isolation)</a><a class="headerlink" href="#working-as-non-root-inside-a-jail-and-uid-non-isolation" title="Link to this heading">#</a></h3>
<p>Now, inside the jail, we see <code class="docutils literal notranslate"><span class="pre">/home/jfasch</span></code> exactly as it is there
on the outside. My outside UID/GID is 1000/1000, and this is what we
see inside.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">chroot</span></code> has nothing to do with <em>isolation</em></p>
</div>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">Inside jail</span><a class="headerlink" href="#id19" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ls<span class="w"> </span>-l<span class="w"> </span>/home/jfasch/
<span class="go">...</span>
<span class="go">drwxr-xr-x    1 1000     1000            68 Jul  1 19:43 Desktop</span>
<span class="go">drwxr-xr-x    1 1000     1000             0 Jun 12 13:01 Documents</span>
<span class="go">drwxr-xr-x    1 1000     1000          1130 Jul 20 17:04 Downloads</span>
<span class="go">drwxr-xr-x    1 1000     1000          1726 Jul 17 08:28 My-Projects</span>
<span class="go">...</span>
</pre></div>
</div>
</div>
<p>We’d now be prepared to</p>
<ul class="simple">
<li><p>Change into the jail</p></li>
<li><p>Work on the outside home directory from <em>inside</em> (for example to
build Yocto)</p></li>
</ul>
<p>Its just that I do not want to work in my home directory as
<code class="docutils literal notranslate"><span class="pre">root</span></code>. Two options exist.</p>
<section id="option-1-simply-use-numeric-ids-inside">
<h4><a class="toc-backref" href="#id35" role="doc-backlink">Option 1: Simply Use Numeric IDs <em>Inside</em></a><a class="headerlink" href="#option-1-simply-use-numeric-ids-inside" title="Link to this heading">#</a></h4>
<p>Simply specify my UID/GID to <code class="docutils literal notranslate"><span class="pre">chroot</span> <span class="pre">--userspec=</span></code>, and be myself <em>inside</em>, without
any further action. <em>Problem solved</em>: I am not <code class="docutils literal notranslate"><span class="pre">root</span></code> anymore (note
the <code class="docutils literal notranslate"><span class="pre">$</span></code> prompt from the inside shell), but otherwise there are no
names for me and my group - just numbers.</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">Outside jail</span><a class="headerlink" href="#id20" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>chroot<span class="w"> </span>--userspec<span class="o">=</span><span class="m">1000</span>:1000<span class="w"> </span>Simple<span class="se">\(</span>Busybox<span class="se">\)</span><span class="w"> </span>/bin/sh
<span class="gp">$         </span><span class="c1"># &lt;-- now inside, note the non-root prompt &quot;$&quot;</span>
<span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>/home/jfasch
<span class="go">...</span>
<span class="go">drwxr-xr-x    1 1000     1000            68 Jul  1 19:43 Desktop</span>
<span class="go">drwxr-xr-x    1 1000     1000             0 Jun 12 13:01 Documents</span>
<span class="go">drwxr-xr-x    1 1000     1000          1130 Jul 20 17:04 Downloads</span>
<span class="go">drwxr-xr-x    1 1000     1000          1726 Jul 17 08:28 My-Projects</span>
<span class="go">...</span>
</pre></div>
</div>
</div>
<p>This is fine for me once I automate the entire “chroot into jail and
build Yocto there” workflow - I’d not be intersted in any names then.</p>
</section>
<section id="option-2-create-user-record-inside">
<span id="blog-chroot-user-group"></span><h4><a class="toc-backref" href="#id36" role="doc-backlink">Option 2: Create User Record <em>Inside</em></a><a class="headerlink" href="#option-2-create-user-record-inside" title="Link to this heading">#</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Again, be aware that <em>there is no isolation in a chroot jail</em>. Any
UID/GID that is referenced by a user record <em>inside</em> is <em>exactly
the UID/GID from outside</em>.</p>
</div>
<p><em>For convenience only</em>, lets now create names <code class="docutils literal notranslate"><span class="pre">jfasch</span></code> <em>inside</em>, and
define a home directory that we can easily <code class="docutils literal notranslate"><span class="pre">chdir</span></code> to.</p>
<p>Currently, at this point, we are using our simple Busybox jail to
create user and group. A jail filled with a real distro is a little
different; see below jjj “wrap-up fedora 41 jail” for the “real
distro” case.</p>
<ul>
<li><p>Prepare empty user/group files (our simple root does not have those)</p>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">Outside jail</span><a class="headerlink" href="#id21" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mkdir<span class="w"> </span>Simple<span class="se">\(</span>Busybox<span class="se">\)</span>/etc
<span class="gp"># </span>touch<span class="w"> </span>Simple<span class="se">\(</span>Busybox<span class="se">\)</span>/etc/group
<span class="gp"># </span>touch<span class="w"> </span>Simple<span class="se">\(</span>Busybox<span class="se">\)</span>/etc/passwd
</pre></div>
</div>
</div>
</li>
<li><p>Use <em>inside</em> (Busybox) tools to create user and group. As I said,
Fedora and other distros are a little different (Busybox has
<code class="docutils literal notranslate"><span class="pre">addgroup</span></code>, Fedora has <code class="docutils literal notranslate"><span class="pre">groupadd</span></code>, for example).</p>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">Outside jail</span><a class="headerlink" href="#id22" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>chroot<span class="w"> </span>Simple<span class="se">\(</span>Busybox<span class="se">\)</span><span class="w"> </span>busybox<span class="w"> </span>addgroup<span class="w"> </span>-g<span class="w"> </span><span class="m">1000</span><span class="w"> </span>jfasch
<span class="gp"># </span>chroot<span class="w"> </span>Simple<span class="se">\(</span>Busybox<span class="se">\)</span><span class="w"> </span>busybox<span class="w"> </span>adduser<span class="w"> </span>-s<span class="w"> </span>/bin/sh<span class="w"> </span>-G<span class="w"> </span>jfasch<span class="w"> </span>-u<span class="w"> </span><span class="m">1000</span><span class="w"> </span>-D<span class="w"> </span>jfasch
</pre></div>
</div>
</div>
</li>
</ul>
<p>I can now go into jail in one step, and it would feel like
freedom. It’s still Busybox which is not quite usable for a Yocto
build. In the next step, let’s see how a jail can be setup from a real
distro.</p>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">Outside jail</span><a class="headerlink" href="#id23" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>chroot<span class="w"> </span>Simple<span class="se">\(</span>Busybox<span class="se">\)</span>/<span class="w"> </span>/bin/busybox<span class="w"> </span>su<span class="w"> </span>-<span class="w"> </span>jfasch
<span class="go">~ $           # &lt;-- indise jail</span>
<span class="go">~ $ cd ~/My-Projects/FH-ENDLESS/Yocto/</span>
<span class="go">~/My-Projects/FH-ENDLESS/Yocto $ ls -l</span>
<span class="go">total 12</span>
<span class="go">drwxr-xr-x    1 jfasch   jfasch       15972 Jul 28 21:58 DOWNLOAD</span>
<span class="go">drwxr-xr-x    1 jfasch   jfasch        1060 Jul 28 21:32 SSTATE</span>
<span class="go">drwxr-xr-x    1 jfasch   jfasch           8 Apr 10 09:46 build</span>
<span class="go">-rw-r--r--    1 jfasch   jfasch         373 Jan 20  2025 common-bblayers.conf</span>
<span class="go">-rw-r--r--    1 jfasch   jfasch         373 Jan 15  2025 common-local.conf</span>
<span class="go">drwxr-xr-x    1 jfasch   jfasch         122 Jan 20  2025 meta-endless</span>
<span class="go">drwxr-xr-x    1 jfasch   jfasch         472 Oct 22  2024 meta-raspberrypi</span>
<span class="go">drwxr-xr-x    1 jfasch   jfasch         548 Oct 22  2024 poky</span>
<span class="go">drwxr-xr-x    1 jfasch   jfasch          28 Nov 15  2024 qemuarm64</span>
<span class="go">drwxr-xr-x    1 jfasch   jfasch          92 Jul 28 21:22 qemux86-64</span>
<span class="go">drwxr-xr-x    1 jfasch   jfasch         120 Jul 29 09:09 raspberry3-build</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>
<section id="repeat-in-a-real-distro-jail-fedora-41">
<span id="blog-chroot-short-fedora41"></span><h2>Repeat, In A Real Distro Jail (Fedora 41)<a class="headerlink" href="#repeat-in-a-real-distro-jail-fedora-41" title="Link to this heading">#</a></h2>
<aside class="sidebar">
<p class="sidebar-title">See also</p>
<ul class="simple">
<li><p><a class="reference external" href="https://dnf5.readthedocs.io/en/latest/misc/installroot.7.html">dnf –installroot=</a></p></li>
<li><p><a class="reference external" href="https://wiki.debian.org/Debootstrap">debootstrap</a></p></li>
<li><p><a class="reference external" href="https://0pointer.net/blog/a-re-introduction-to-mkosi-a-tool-for-generating-os-images.html">A re-introduction to mkosi – A Tool for Generating OS Images</a></p></li>
</ul>
</aside>
<p>Busybox is small and simple, which is why I used it above to
illustrate all the pieces involved. Busybox is used in hardcore
Embedded Linux systems to achive a small footprint, but it is for sure
not capable to run a Yocto build <a class="footnote-reference brackets" href="#busybox-not-yocto-supported" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>.</p>
<p>What follows is an annotated shell-command-like transcript of what I
did to solve my very original problem: a Yocto build on
Yocto-unsupported Fedora 42. It has much of what I did above, only
more condensed.</p>
<section id="fedora-41-jail">
<h3>Fedora 41 Jail<a class="headerlink" href="#fedora-41-jail" title="Link to this heading">#</a></h3>
<p>Lets now setup a real distro’s root filesystem. Like the Busybox in
<a class="reference internal" href="#blog-chroot-chroot-jail"><span class="std std-ref">chroot Jail</span></a>, but bigger. All the mountpoints, like
<code class="docutils literal notranslate"><span class="pre">/proc</span></code>, are already there, for example.</p>
<p>We “parameterize” the root directory, if someone wants to make all
this into a script.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span><span class="nv">JAILDIR</span><span class="o">=</span>/home/jfasch/Machines/fedora-41
</pre></div>
</div>
<p>Fedora package list to install. This somehow gathered by trial and
error.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># minimal install</span>
<span class="nv">PACKAGES</span><span class="o">=</span><span class="s2">&quot;dnf fedora-release glibc glibc-langpack-en glibc-langpack-de gcc g++ cmake util-linux iputils&quot;</span>

<span class="c1"># for Yocto&#39;s bitbake itself</span>
<span class="nv">PACKAGES</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PACKAGES</span><span class="s2"> python3&quot;</span>
<span class="c1"># these had to be installed on the host, as bitbake complained</span>
<span class="nv">PACKAGES</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PACKAGES</span><span class="s2"> chrpath diffstat lz4 patch rpcgen&quot;</span>
<span class="c1"># these were discovered, on the host, as needed somewhere deep inside the build</span>
<span class="nv">PACKAGES</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PACKAGES</span><span class="s2"> perl-FindBin perl-STD&quot;</span>
<span class="c1"># these are needed on top of the minimal chroot install, also complained about by bitbake at some point</span>
<span class="nv">PACKAGES</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PACKAGES</span><span class="s2"> bunzip2 bzip2 cmp cpio diff file git hostname pzstd tar unzstd wget which zstd&quot;</span>
<span class="c1"># more perl crap needed</span>
<span class="nv">PACKAGES</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PACKAGES</span><span class="s2"> perl-Thread-Queue perl-File-Compare perl-open&quot;</span>
<span class="c1"># one packaging/wic error near the end of yocto build, saying that something couldn&#39;t be converted to &quot;codepage 850&quot;</span>
<span class="nv">PACKAGES</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PACKAGES</span><span class="s2"> glibc-gconv-extra&quot;</span>
</pre></div>
</div>
<p>Populate the root directory …</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>dnf<span class="w"> </span>-y<span class="w"> </span>--releasever<span class="o">=</span><span class="m">41</span><span class="w"> </span>--best<span class="w"> </span>--setopt<span class="o">=</span><span class="nv">install_weak_deps</span><span class="o">=</span>False<span class="w"> </span>--installroot<span class="o">=</span><span class="nv">$JAILDIR</span><span class="w"> </span>--use-host-config<span class="w"> </span>install<span class="w"> </span><span class="nv">$PACKAGES</span>
</pre></div>
</div>
</section>
<section id="create-environment">
<h3>Create Environment<a class="headerlink" href="#create-environment" title="Link to this heading">#</a></h3>
<p>Let’s now repeat the steps from above, one by one.</p>
<p>Mount <code class="docutils literal notranslate"><span class="pre">/proc</span></code> (see <a class="reference internal" href="#blog-chroot-proc"><span class="std std-ref">proc</span></a>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mount<span class="w"> </span>-t<span class="w"> </span>proc<span class="w"> </span>proc<span class="w"> </span><span class="nv">$JAILDIR</span>/proc/
</pre></div>
</div>
<p>Mount <code class="docutils literal notranslate"><span class="pre">devtmpfs</span></code> and <code class="docutils literal notranslate"><span class="pre">/dev/shm</span></code> (see <a class="reference internal" href="#blog-chroot-devtmpfs"><span class="std std-ref">devtmpfs (And /dev/shm)</span></a>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mount<span class="w"> </span>-t<span class="w"> </span>devtmpfs<span class="w"> </span>dev<span class="w"> </span><span class="nv">$JAILDIR</span>/dev/
<span class="gp"># </span>mount<span class="w"> </span>-t<span class="w"> </span>tmpfs<span class="w"> </span>shm<span class="w"> </span><span class="nv">$JAILDIR</span>/dev/shm
</pre></div>
</div>
<p>Mount my home directory (see <a class="reference internal" href="#blog-chroot-bind-home"><span class="std std-ref">Home Directory</span></a>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mkdir<span class="w"> </span><span class="nv">$JAILDIR</span>/home/jfasch
<span class="gp"># </span>chown<span class="w"> </span>jfasch:jfasch<span class="w"> </span><span class="nv">$JAILDIR</span>/home/jfasch
<span class="gp"># </span>mount<span class="w"> </span>--bind<span class="w"> </span>/home/jfasch<span class="w"> </span><span class="nv">$JAILDIR</span>/home/jfasch
</pre></div>
</div>
<p>Mount resolver config (see <a class="reference internal" href="#blog-chroot-bind-home"><span class="std std-ref">Home Directory</span></a>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>touch<span class="w"> </span><span class="nv">$JAILDIR</span>/etc/resolv.conf
<span class="gp"># </span>mount<span class="w"> </span>--bind<span class="w"> </span>/etc/resolv.conf<span class="w"> </span><span class="nv">$JAILDIR</span>/etc/resolv.conf
</pre></div>
</div>
<p>Give myself a name inside the jail (see
<a class="reference internal" href="#blog-chroot-user-group"><span class="std std-ref">Option 2: Create User Record Inside</span></a>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>chroot<span class="w"> </span><span class="nv">$JAILDIR</span><span class="w"> </span>/usr/sbin/groupadd<span class="w"> </span>-g<span class="w"> </span><span class="m">1000</span><span class="w"> </span>jfasch
<span class="gp"># </span>chroot<span class="w"> </span><span class="nv">$JAILDIR</span><span class="w"> </span>/usr/sbin/useradd<span class="w"> </span>--home-dir<span class="w"> </span>/home/jfasch<span class="w"> </span>--gid<span class="w"> </span>jfasch<span class="w"> </span>--no-create-home<span class="w"> </span>--shell<span class="w"> </span>/bin/bash<span class="w"> </span>jfasch
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>chroot<span class="w"> </span><span class="nv">$JAILDIR</span><span class="w"> </span>su<span class="w"> </span>-<span class="w"> </span>jfasch
<span class="gp">[jfasch@laptop ~]$</span>
</pre></div>
</div>
<p>Et voila: Fedora 41 <em>inside</em> Fedora 42!</p>
</section>
<section id="finally-build-yocto">
<h3>Finally: Build Yocto<a class="headerlink" href="#finally-build-yocto" title="Link to this heading">#</a></h3>
<p>Finally we are prepared to run a Yocto build in a jail the we have set
up for that purpose.</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">Inside jail</span><a class="headerlink" href="#id24" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[jfasch@laptop ~]$ </span><span class="nb">cd</span><span class="w"> </span>~/My-Projects/FH-ENDLESS/Yocto/
<span class="gp">[jfasch@laptop Yocto]$ </span>.<span class="w"> </span>poky/oe-init-build-env<span class="w"> </span>raspberry3-build/
<span class="gp">[jfasch@laptop raspberry3-build]$ </span>bitbake<span class="w"> </span>endless-image-fulldev
<span class="go">... CPU fan getting loud ...</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="id6">
<h2>Conclusion<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>Please don’t consider this article a flame against any container
technologies. Containers are cool when there are problems to be solved
bigger than building Yocto using a different distro than the one you
are just running. Need isolation, need a full (well, half) OS boot and
services started inside - this is what containers are there for.</p>
<p>Sure a full distro container can solve my trivial Yocto problem
too. In my opinion, though, this feels like using a sledgehammer to
crack a nut. If you feel the same, then this article is for you, and I
hope that the information was helpful. Send comments (<a class="reference internal" href="../about/myself/index.html"><span class="doc">here</span></a>) if you liked it and/or have suggestions!</p>
<p class="rubric">Footnotes</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="yocto-tried" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>I sure tried no matter what they say, but ran into
build errors over and over.</p>
</aside>
<aside class="footnote brackets" id="cgroups-docker" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p>Naturally, Docker also uses cgroups to implement
the isolation that it provides.</p>
</aside>
<aside class="footnote brackets" id="empty-is-not-fail" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">3</a><span class="fn-bracket">]</span></span>
<p>I would have expected <code class="docutils literal notranslate"><span class="pre">busybox</span> <span class="pre">ps</span></code> to fail
rather than succeeding with empty output,
though.</p>
</aside>
<aside class="footnote brackets" id="busybox-not-yocto-supported" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">4</a><span class="fn-bracket">]</span></span>
<p>Busybox is not among Yocto’s list of
supported distibutions</p>
</aside>
</aside>
</section>
</section>

<div class="section ablog__blog_comments">
     
<div class="section ablog__prev-next">
  <span class="ablog__prev">
     
    <a href="2022-09-23--cross-raspi.html">
      
      <i class="fa fa-arrow-circle-left"></i>
      
      <span>Building A Cross Toolchain For The Raspberry Pi, Using crosstool-ng</span>
    </a>
    
  </span>
  <span class="ablog__spacer">&nbsp;</span>
  <span class="ablog__next">
    
  </span>
</div>
  
</div>

                </article>
              
              
              
              
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#container-attempts">Container Attempts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#docker">Docker</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#systemd-nspawn"><code class="docutils literal notranslate"><span class="pre">systemd-nspawn</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chroot-de-containerization-minimal-busybox-root-filesystem"><code class="docutils literal notranslate"><span class="pre">chroot</span></code>: De-Containerization (Minimal <code class="docutils literal notranslate"><span class="pre">busybox</span></code> Root Filesystem)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#chroot-jail"><code class="docutils literal notranslate"><span class="pre">chroot</span></code> Jail</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#proc"><code class="docutils literal notranslate"><span class="pre">proc</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#devtmpfs-and-dev-shm"><code class="docutils literal notranslate"><span class="pre">devtmpfs</span></code> (And <code class="docutils literal notranslate"><span class="pre">/dev/shm</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bind-mounts">Bind Mounts</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#home-directory">Home Directory</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#network-etc-resolv-conf">Network/<code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#working-as-non-root-inside-a-jail-and-uid-non-isolation">Working As Non <code class="docutils literal notranslate"><span class="pre">root</span></code> Inside A Jail (And UID Non-Isolation)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-simply-use-numeric-ids-inside">Option 1: Simply Use Numeric IDs <em>Inside</em></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-create-user-record-inside">Option 2: Create User Record <em>Inside</em></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#repeat-in-a-real-distro-jail-fedora-41">Repeat, In A Real Distro Jail (Fedora 41)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fedora-41-jail">Fedora 41 Jail</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-environment">Create Environment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#finally-build-yocto">Finally: Build Yocto</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Conclusion</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2019-2025 (GPLv3), Jörg Faschingbauer.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__center">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/blog/2025-07-29--Whats-wrong-with-chroot.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>