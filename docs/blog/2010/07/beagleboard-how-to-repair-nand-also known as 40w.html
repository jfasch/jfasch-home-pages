

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Beagleboard: How to Repair NAND (also known as 40W) &mdash; Jörg Faschingbauer 0.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Jörg Faschingbauer
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../courses/index.html">Schulungen</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/010-linux-basics.html">Linux Basics: Eine Einführung Anhand von Beispielen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/020-sysprog-basics.html">Systemprogrammierung: Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/050-sysprog-network.html">Systemprogrammierung: Netzwerk</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/060-sysprog-multithreading.html">Systemprogrammierung: Multithreading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/070-sysprog-fortgeschrittenes.html">Systemprogrammierung: Virtuelles Memory, IPC, Shared Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/080-sysprog-embedded.html">Systemprogrammierung: Embedded/Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/200-raspi-hands-on.html">Eine Woche mit dem Raspberry Pi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/linux/700-kettner-lfs-descr.html">Linux from Scratch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/10-C.html">C: Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/12-C-Refresher.html">C: Auffrischung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/15-C-Advanced.html">C für Fortgeschrittene</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/20-CXX.html">C++: Eine Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/30-Python-Basics.html">Python Grundlagen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-languages/35-Python-Advanced.html">Python für Fortgeschrittene</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-misc/010-bash.html">Shell Scripting mit der Bourne Again Shell (Bash)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-misc/020-make.html">GNU-Make: Eine Einführung</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../courses/programming-misc/030-svn.html">Subversion: Eine Einführung</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../about/index.html">Über mich</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../about/cv-de.html">Ein formaleres Curriculum Vitae</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about/skills-de.html">Eine Liste meiner technischen Fähigkeiten</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about/projects-de.html">Eine Liste meiner bisherigen Projekte</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Blog Posts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../TODO.html">To Do</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Jörg Faschingbauer</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
      <li>Beagleboard: How to Repair NAND (also known as 40W)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/blog/2010/07/beagleboard-how-to-repair-nand-also known as 40w.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="beagleboard-how-to-repair-nand-also-known-as-40w">
<h1>Beagleboard: How to Repair NAND (also known as 40W)<a class="headerlink" href="#beagleboard-how-to-repair-nand-also-known-as-40w" title="Permalink to this headline">¶</a></h1>
<p>It happened again. Friends of mine have an alias,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">alias</span> <span class="nv">faschingbauer</span><span class="o">=</span><span class="s2">&quot;rm -rf ~&quot;</span>
</pre></div>
</div>
<p>in their <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> for a couple of years now, and now I created a
creative variation thereof.</p>
<p>I used to have my beagleboard running happily off an SD card, using a
root filesystem which I had updated natively from a <a class="reference external" href="http://mirrors.kernel.org/gentoo/releases/arm/autobuilds/current-stage3/armv4tl-softfloat-linux-gnueabi/">Gentoo ARM stage3</a>. This
is decadent, so I prepared a Busybox-only initramfs linked into the
kernel image (cross-built of course, as opposed to the stage3), with
the plans to use this as an alternative boot image residing in NAND
flash.</p>
<p>It happened to me that, during finding out the correct arguments of
U-Boot’s <code class="docutils literal notranslate"><span class="pre">nand</span> <span class="pre">erase</span></code> command, I hit the
return key early - expecting that a sole</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>nand erase
</pre></div>
</div>
<p>would give me further instructions. U-Boot took it literally though
and erased NAND, just like I told it to. A reboot showed the fatal
consequences. “40W” was the only thing I saw over the serial terminal
(115200/8N1 by the way).</p>
<p>Here in the remainder I write down how to recover from such a
fauxpas. The internet has a lot of explanations, but none of them is a
walk-through from the beginning to the end. You’ll have to do a couple
of things, and most of the instructions you’ll find don’t explain
much. This is not what I like, so I researched a bit and write the
annotated collected instructions down right here. You might find it
useful - I surely will once I’ll brick my beagle again.</p>
<div class="section" id="basics">
<h2>Basics<a class="headerlink" href="#basics" title="Permalink to this headline">¶</a></h2>
<p>The OMAP has a small boot ROM inside. This is the first of the chain
of boot loaders, and it’s where the CPU core jumps to when it’s done
with whatever CPU cores do when they are powered on). The boot ROM is
programmed to load a second stage boot loader (the “X-Loader” as it is
called) into the processor’s SRAM. X-Loader is then responsible for
loading another stage - U-Boot in the Linux case - into the external
DRAM. It’s the latter two stages - X-Loader and U-Boot - that I
faschingbauered away from NAND, and that I’ll recover now.</p>
<p>They key to all that is the ability of the boot ROM to boot from a
MMC/SD card when the user button is pressed during its operation. We
will prepare one such card, put the boot files on it, and write these
to NAND.</p>
</div>
<div class="section" id="getting-x-loader-and-u-boot">
<h2>Getting X-Loader and U-Boot<a class="headerlink" href="#getting-x-loader-and-u-boot" title="Permalink to this headline">¶</a></h2>
<p>The beagleboard guys wrote up a page with <a class="reference external" href="http://code.google.com/p/beagleboard/wiki/BeagleboardRevC3Validation">board validation
instructions</a>. This
is where I have most of the information from. There they give links to
the images that I want. Take care that you select the ones that match
your board revision; the files they use on that page are slightly
seasoned. I have a recent C4, and I found it valuable to have a recent
U-Boot version that enables power on the USB host controller. This was
a change they made from C3 to C4, for example - take care.</p>
<p>Anyway, <a class="reference external" href="http://www.angstrom-distribution.org/demo/beagleboard/">Angstrom</a> have the
most recent stuff. Download X-Loader and U-Boot from there, and
additionally another bootloader stage, <code class="docutils literal notranslate"><span class="pre">MLO</span></code>, which is used during
the MMC boot. The filenames change, just browse the directory a choose
something that sounds like <code class="docutils literal notranslate"><span class="pre">x-load.bin.ift</span></code>, <code class="docutils literal notranslate"><span class="pre">u-boot*</span></code>,
<code class="docutils literal notranslate"><span class="pre">MLO*</span></code>. Save them away for later use. I saved them as
<code class="docutils literal notranslate"><span class="pre">x-load.bin.ift</span></code> and <code class="docutils literal notranslate"><span class="pre">u-boot.bin</span></code>, and it’s these names that I
refer to later on.</p>
</div>
<div class="section" id="creating-a-bootable-mmc-sd-card">
<h2>Creating a Bootable MMC/SD card<a class="headerlink" href="#creating-a-bootable-mmc-sd-card" title="Permalink to this headline">¶</a></h2>
<p>For basic card configuration I refer you to <a class="reference external" href="http://processors.wiki.ti.com/index.php/MMC_Boot_Format">a TI maintained page</a> which is
very concise and to the point, and where there is nothing much left to
say. I followed the instruction using fdisk, and obvoiusly the card
can be read by the boot ROM. There are reports that FAT32 does not
work on some cards, and that selecting FAT16 instead helped. You might
want to try that out in case.</p>
<p>Once the card is ready and a FAT partition has been created, you mount
that partition and put the files on it as follows.</p>
<ul class="simple">
<li><p>First comes <code class="docutils literal notranslate"><span class="pre">MLO</span></code>, as file <code class="docutils literal notranslate"><span class="pre">MLO</span></code>, no matter what name you stored
it under on your disk. It is read by the boot ROM, and that one is
very particular that the file is found in the first sectors.</p></li>
<li><p>You store the U-Boot image as file <code class="docutils literal notranslate"><span class="pre">u-boot.bin</span></code>. <code class="docutils literal notranslate"><span class="pre">MLO</span></code> expects
it under that name during MMC boot. (If you intend to use a
different U-Boot image for NAND then you store that one under a
different name which you use further down when we write NAND.)</p></li>
<li><p>The X-Loader is not used during MMC boot, so you can choose any name
you like.</p></li>
</ul>
<p>Insert the card into the MMC/SD slot of the beagle, and boot. In case
you erased your NAND only partly and there is still something
meaningful in it, be sure to hold down the user button to force the
boot ROM to boot from the card.</p>
</div>
<div class="section" id="repairing-the-nand">
<h2>Repairing the NAND<a class="headerlink" href="#repairing-the-nand" title="Permalink to this headline">¶</a></h2>
<p>The following is taken from the <a class="reference external" href="http://beagleboard.googlecode.com/files/reset_revc_v3.scr">reset.scr</a> U-Boot
script referred to by the <a class="reference external" href="http://code.google.com/p/beagleboard/wiki/BeagleboardRevC3Validation">beagleboard validation instructions</a>. I
took care to annotate as much as possible in order to understand the
steps.</p>
<p>First off, we initialize MMC/SD.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>OMAP3 beagleboard.org <span class="c1"># mmc init</span>
mmc1 is available
</pre></div>
</div>
<p>To understand where the numbers in the remainder instructions come
from, open the kernel source file
<code class="docutils literal notranslate"><span class="pre">arch/arm/mach-omap2/board-omap3beagle.c</span></code>. I’ll refer to that file
in the remainder explanations. Near the top of the file you’ll notice
the partition table; you’ll find it insightful.</p>
</div>
<div class="section" id="writing-x-loader-to-nand">
<h2>Writing X-Loader to NAND<a class="headerlink" href="#writing-x-loader-to-nand" title="Permalink to this headline">¶</a></h2>
<p>First, erase the X-Loader partition. According to the partition table,
it starts at offset 0 (where the OMAP’s boot ROM expects it) and is
4*128K=0x80000 bytes long.</p>
<p>The boot ROM relies on hardware to manage error correction code (ECC),
as described in the <a class="reference external" href="http://download.micron.com/pdf/technotes/nand/tn2916.pdf">tech note</a>, so we
select it.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>OMAP3 beagleboard.org <span class="c1"># nandecc hw</span>
HW ECC selected

OMAP3 beagleboard.org <span class="c1"># nand erase 0 80000</span>
NAND erase: device <span class="m">0</span> offset 0x0, size 0x80000
Erasing at 0x60000 -- <span class="m">100</span>% complete.
OK
</pre></div>
</div>
<p>According to the <a class="reference external" href="http://download.micron.com/pdf/technotes/nand/tn2916.pdf">tech note</a> again,
the OMAP’s boot ROM takes care of bad blocks (unlikely because an
intermediate bootloader isn’t written to flash that often, but
nevertheless it sounds like a good idea). It checks the first four
blocks of the X-Loader partition for a valid image, so we write the
image into these four blocks. Again, the erase block size is
determined by looking in <code class="docutils literal notranslate"><span class="pre">board-omap3beagle.c</span></code> - 128K = 0x20000.</p>
<p>Read the image into memory, and write it out 4 times, in the first
four erase blocks of the partition.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>OMAP3 beagleboard.org <span class="c1"># fatload mmc 0 80200000 x-load.bin.ift</span>
reading x-load.bin.ift
<span class="m">20392</span> bytes <span class="nb">read</span>

OMAP3 beagleboard.org <span class="c1"># nand write 80200000 0 20000</span>
NAND write: device <span class="m">0</span> offset 0x0, size 0x20000
<span class="m">131072</span> bytes written: OK

OMAP3 beagleboard.org <span class="c1"># nand write 80200000 20000 20000</span>
NAND write: device <span class="m">0</span> offset 0x20000, size 0x20000
<span class="m">131072</span> bytes written: OK

OMAP3 beagleboard.org <span class="c1"># nand write 80200000 40000 20000</span>
NAND write: device <span class="m">0</span> offset 0x40000, size 0x20000
<span class="m">131072</span> bytes written: OK

OMAP3 beagleboard.org <span class="c1"># nand write 80200000 60000 20000</span>
NAND write: device <span class="m">0</span> offset 0x60000, size 0x20000
<span class="m">131072</span> bytes written: OK
</pre></div>
</div>
</div>
<div class="section" id="writing-u-boot-to-nand">
<h2>Writing U-Boot to NAND<a class="headerlink" href="#writing-u-boot-to-nand" title="Permalink to this headline">¶</a></h2>
<p>Can’t find which ECC incarnation the X-Loader uses, software seems to
be the choice (sounds like the do-nothing-and-cross-fingers approach).</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>OMAP3 beagleboard.org <span class="c1"># nandecc sw</span>
SW ECC selected
</pre></div>
</div>
<p>According to the kernel sources, U-Boot’s partition starts at offset
0x80000 and is 15*128K=0x1e0000 bytes long.</p>
<p>Erase NAND, load U-Boot from card, write it to the partition.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>OMAP3 beagleboard.org <span class="c1"># nand erase 80000 1e0000</span>
NAND erase: device <span class="m">0</span> offset 0x80000, size 0x1e0000
Erasing at 0x240000 -- <span class="m">100</span>% complete.
OK

OMAP3 beagleboard.org <span class="c1"># fatload mmc 0 80200000 u-boot.bin</span>
reading u-boot.bin
<span class="m">275928</span> bytes <span class="nb">read</span>

OMAP3 beagleboard.org <span class="c1"># nand write 80200000 80000 1e0000</span>
NAND write: device <span class="m">0</span> offset 0x80000, size 0x1e0000
<span class="m">1966080</span> bytes written: OK
</pre></div>
</div>
<p>That’s it. You are now able to boot without the card, up to the U-Boot
prompt.</p>
<p>Take care when you flash the kernel. In case you don’t know the
correct <code class="docutils literal notranslate"><span class="pre">nand</span> <span class="pre">erase</span></code> parameters, write</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>OMAP3 beagleboard.org <span class="c1"># help nand</span>
</pre></div>
</div>
<p>instead of <code class="docutils literal notranslate"><span class="pre">nand</span> <span class="pre">erase</span></code>. I suggest you type</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>OMAP3 beagleboard.org <span class="c1"># nand erase 280000 400000</span>
</pre></div>
</div>
<p>just like the kernel source says for the kernel partition.</p>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  Next: 
  <a href="../../2011/01/porting-to-linux-there-s-always-a-better-way.html">
    Porting to Linux (There’s Always A Better Way)
    
  </a>
  
  </span>
</div>

  
  
  </div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Jörg Faschingbauer

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>