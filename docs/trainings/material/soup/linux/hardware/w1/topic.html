
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content="The Linux PWM Userspace Interface" name="description" />
<meta content="linux, onewire, w1, DS18B20, DS2482, raspberry pi, raspi, userspace, hwmon, sysfs" name="keywords" />

    <title>Linux and OneWire (using DS18B20 Temperature Sensor as Slave) &#8212; Jörg Faschingbauer</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/css/lightbox.min.css?v=6e7d0de0" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/pointer.css?v=c97663ff" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/custom.css?v=128c0548" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script src="../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/js/lightbox-plus-jquery.min.js?v=f0ca4bb6"></script>
    <script src="../../../../../../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js?v=12818e64"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'trainings/material/soup/linux/hardware/w1/topic';</script>
    <link rel="canonical" href="https://www.faschingbauer.me/trainings/material/soup/linux/hardware/w1/topic.html" />
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" />
    <link rel="next" title="Linux and I2C (using LM73 Temperature Sensor as Slave)" href="../i2c/topic.html" />
    <link rel="prev" title="Hardware, Kernel" href="../can/40-harware.html" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" /> 
<link
  rel="alternate"
  type="application/atom+xml"
  href="../../../../../../blog/index/atom.xml"
  title="Jörg Faschingbauer"
/>
  
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../../../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../../../../../_static/logo.png" class="logo__image only-light" alt="Jörg Faschingbauer - Home"/>
    <img src="../../../../../../_static/logo.png" class="logo__image only-dark pst-js-only" alt="Jörg Faschingbauer - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../../../../../index.html">
    Training Courses
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../../about/index.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../../blog/postlist.html">
    Blog
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../../../../../index.html">
    Training Courses
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../../about/index.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../../blog/postlist.html">
    Blog
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../../repertoire/index.html">Course Descriptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../info.html">Pricing, Organizational</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../log/index.html">Log Of Past Courses</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../../../index.html">Complete Slide Material</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active has-children"><a class="reference internal" href="../../index.html">Linux: Introduction, Userland/Kernel Programming, Hardware/Embedded</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../basics/index.html">Linux Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sysprog/index.html">Linux Systems Programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ssh/index.html">SSH: Secure Shell</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../toolchain/index.html">Toolchain, And Cross Development</a></li>
<li class="toctree-l3 current active has-children"><a class="reference internal" href="../index.html">Linux Hardware Interfaces</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../can/index.html">CAN Bus With Linux And Python</a></li>
<li class="toctree-l4 current active"><a class="current reference internal" href="#">Linux and OneWire (using DS18B20 Temperature Sensor as Slave)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../i2c/topic.html">Linux and I2C (using LM73 Temperature Sensor as Slave)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pwm/topic.html">PWM Userspace Interface (using PCA9685)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../brushless-motor/topic.html">Controlling a Brushless Motor With Raspberry Pi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../libgpiod/index.html"><code class="docutils literal notranslate"><span class="pre">libgpiod</span></code></a></li>
</ul>
</details></li>
<li class="toctree-l3"><a class="reference internal" href="../../kernel/index.html">Linux Kernel Driver Development</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../drafts/index.html">Drafts</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../../python/index.html">Python Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../c/index.html">C Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cxx/index.html">C++ Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../misc/index.html">Build Tools, Unit Testing, Design, And More</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../../../index.html" class="nav-link">Training Courses</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../../index.html" class="nav-link">Complete Slide Material</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Linux: Introduction, Userland/Kernel Programming, Hardware/Embedded</a></li>
    
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Linux Hardware Interfaces</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Linux and OneWire (using DS18B20 Temperature Sensor as Slave)</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                   <section id="linux-and-onewire-using-ds18b20-temperature-sensor-as-slave">
<h1>Linux and OneWire (using DS18B20 Temperature Sensor as Slave)<a class="headerlink" href="#linux-and-onewire-using-ds18b20-temperature-sensor-as-slave" title="Link to this heading">#</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id12">Overview</a></p></li>
<li><p><a class="reference internal" href="#master-device-alterative-1-w1-gpio-onewire-master-in-software" id="id13">Master Device, Alterative 1: <code class="docutils literal notranslate"><span class="pre">w1-gpio</span></code> - OneWire Master in Software</a></p>
<ul>
<li><p><a class="reference internal" href="#wiring-attach-onewire-device-to-gpio-pin" id="id14">Wiring: Attach OneWire Device to GPIO Pin</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#master-device-alterative-2-ds2482-i2c-onewire-master-in-hardware" id="id15">Master Device, Alterative 2: DS2482 - I2C OneWire Master in Hardware</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id16">Overview</a></p></li>
<li><p><a class="reference internal" href="#wiring-attach-ds2482-800-via-i2c" id="id17">Wiring: Attach DS2482-800 via I2C</a></p></li>
<li><p><a class="reference internal" href="#configure-software" id="id18">Configure Software</a></p>
<ul>
<li><p><a class="reference internal" href="#enable-i2c-and-check-bootloader-config-boot-config-txt" id="id19">Enable I2C, and Check (Bootloader config, <code class="docutils literal notranslate"><span class="pre">/boot/config.txt)</span></code></a></p></li>
<li><p><a class="reference internal" href="#verify-that-our-device-is-there-i2cdetect" id="id20">Verify That Our Device Is There (<code class="docutils literal notranslate"><span class="pre">i2cdetect)</span></code></a></p></li>
<li><p><a class="reference internal" href="#announce-hotplug-ds2482-to-linux" id="id21">Announce (“Hotplug”) DS2482 to Linux</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#wiring-attach-onewire-device-to-ds2482-800" id="id22">Wiring: Attach OneWire Device to DS2482-800</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#over-engineering-beauty" id="id23">Over-Engineering? Beauty?</a></p>
<ul>
<li><p><a class="reference internal" href="#hardware-bringup" id="id24">Hardware Bringup</a></p></li>
<li><p><a class="reference internal" href="#device-usage" id="id25">Device Usage</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#slave-device-ds18b20-temperature-sensor" id="id26">Slave Device: DS18B20 Temperature Sensor</a></p>
<ul>
<li><p><a class="reference internal" href="#using-the-device" id="id27">Using the Device</a></p>
<ul>
<li><p><a class="reference internal" href="#as-a-generic-onewire-device" id="id28">As a Generic OneWire Device</a></p></li>
<li><p><a class="reference internal" href="#as-a-hardware-monitoring-hwmon-device" id="id29">As a Hardware Monitoring (<code class="docutils literal notranslate"><span class="pre">hwmon</span></code>) Device</a></p></li>
<li><p><a class="reference internal" href="#lm-sensors" id="id30"><code class="docutils literal notranslate"><span class="pre">lm-sensors</span></code></a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#onewire-caveats" id="id31">OneWire Caveats</a></p>
<ul>
<li><p><a class="reference internal" href="#bus-topology" id="id32">Bus Topology</a></p></li>
<li><p><a class="reference internal" href="#error-symptoms" id="id33">Error Symptoms</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#links" id="id34">Links</a></p></li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Overview</a><a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>This article shows how you use Linux to communicate with <a class="reference external" href="https://en.wikipedia.org/wiki/1-Wire">OneWire</a> devices. Cornerstones are:</p>
<ul class="simple">
<li><p>Master, Alternative 1: <code class="docutils literal notranslate"><span class="pre">w1-gpio</span></code> - bus master in software (unstable at
times)</p></li>
<li><p>Master, Alternative 2: <a class="reference external" href="https://www.maximintegrated.com/en/products/interface/controllers-expanders/DS2482-800.html">DS2482</a> -
bus master in hardware, attached to the CPU via I2C</p></li>
<li><p>Slave <a class="reference external" href="https://www.maximintegrated.com/en/products/DS18B20">DS18B20</a> OneWire
temperature sensor as a slave device.</p></li>
<li><p>Rasperry Pi because everything’s easy there. This article’s
principles stand unmodified for other platforms that run Linux (more
handwork might be needed though - Pi’s <code class="docutils literal notranslate"><span class="pre">/boot/config.txt</span></code> is
really cool, for example).</p></li>
</ul>
<p>A <a class="reference external" href="https://en.wikipedia.org/wiki/1-Wire">OneWire</a> device has three
wires attached to it: data, ground, and power. Data and ground are
mandatory, obviously. Power is optional; if omitted, the device is
said to be operated in <em>parasitic mode</em>.</p>
</section>
<section id="master-device-alterative-1-w1-gpio-onewire-master-in-software">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Master Device, Alterative 1: <code class="docutils literal notranslate"><span class="pre">w1-gpio</span></code> - OneWire Master in Software</a><a class="headerlink" href="#master-device-alterative-1-w1-gpio-onewire-master-in-software" title="Link to this heading">#</a></h2>
<p>Lacking a hardware OneWire master (the Raspi does not have one
built-in), we use a software implementation of the OneWire protocol -
the <code class="docutils literal notranslate"><span class="pre">w1-gpio</span></code> kernel driver. You configure one GPIO to act as the
data line, and the kernel driver is then used to <a class="reference external" href="https://en.wikipedia.org/wiki/Bit_banging">bitbang</a> the OneWire protocol in
and out of the CPU.</p>
<p>Configuration is easy: say you want to use GPIO 21 as data line. In
<code class="docutils literal notranslate"><span class="pre">/boot/config.txt</span></code> you write,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dtoverlay=w1-gpio,gpiopin=21</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Reboot the Pi, and the kernel will load the driver and configure
the GPIO accordingly.</p>
</div>
<section id="wiring-attach-onewire-device-to-gpio-pin">
<span id="bitbang-device"></span><h3><a class="toc-backref" href="#id14" role="doc-backlink">Wiring: Attach OneWire Device to GPIO Pin</a><a class="headerlink" href="#wiring-attach-onewire-device-to-gpio-pin" title="Link to this heading">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Though not exactly necessary 😉, it makes sense to halt and
power off the Pi before connecting the sensor.</p>
</div>
<div class="pst-scrollable-table-container"><table class="table table-left">
<thead>
<tr class="row-odd"><th class="head"><p>Professional Diagram</p></th>
<th class="head"><p>Decadent Pi Addon</p></th>
<th class="head"><p>Raspi Pinout</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><img alt="../../../../../../_images/wiring.png" src="../../../../../../_images/wiring.png" />
</td>
<td><img alt="../../../../../../_images/wiring-photo.jpg" src="../../../../../../_images/wiring-photo.jpg" />
</td>
<td><a class="reference internal image-reference" href="../../../../../../_images/raspi-pinout.png"><img alt="../../../../../../_images/raspi-pinout.png" src="../../../../../../_images/raspi-pinout.png" style="width: 619.0px; height: 356.0px;" />
</a>
</td>
</tr>
</tbody>
</table>
</div>
<p>When done, reboot and see the device appear in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/bus/w1/devices/
<span class="go">total 0</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:58 28-01144fe43baa -&gt; ../../../devices/w1_bus_master8/28-01144fe43baa</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:58 w1_bus_master1 -&gt; ../../../devices/w1_bus_master1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Especially in breadboard setups, the bitbanging master appears to
become unstable. Devices are not recognized at all, or appear as
random garbage. Here’s one exceptionally amazing crap that I once
encountered - <em>one</em> device appearing as <em>two bogus</em> devices,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/bus/w1/devices
<span class="go">total 0</span>
<span class="go">drwxr-xr-x 2 root root 0 Oct 25 17:56 .</span>
<span class="go">drwxr-xr-x 4 root root 0 Oct 25 17:56 ..</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 08:02 00-400000000000 -&gt; ../../../devices/w1_bus_master1/00-400000000000</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 08:02 00-800000000000 -&gt; ../../../devices/w1_bus_master1/00-800000000000</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 25 17:56 w1_bus_master1 -&gt; ../../../devices/w1_bus_master1</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="#error-symptoms"><span class="std std-ref">below</span></a> for more about OneWire errors.</p>
</div>
</section>
</section>
<section id="master-device-alterative-2-ds2482-i2c-onewire-master-in-hardware">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">Master Device, Alterative 2: DS2482 - I2C OneWire Master in Hardware</a><a class="headerlink" href="#master-device-alterative-2-ds2482-i2c-onewire-master-in-hardware" title="Link to this heading">#</a></h2>
<aside class="sidebar">
<p class="sidebar-title">DS2482-800: 8-Channel 1-Wire Master</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.maximintegrated.com/en/products/interface/controllers-expanders/DS2482-800.html">Product page</a></p></li>
<li><p><a class="reference external" href="https://datasheets.maximintegrated.com/en/ds/DS2482-800.pdf">Datasheet (PDF)</a></p></li>
</ul>
</aside>
<section id="id1">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Overview</a><a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The <a class="reference external" href="https://www.maximintegrated.com/en/products/interface/controllers-expanders/DS2482-800.html">DS2482</a>
is an I2C device - <em>an I2C slave device</em> - that acts as a OneWire
<em>master</em>. It implements the OneWire protocol <em>in hardware</em>, and
receives commands from the CPU on behalf of a dedicated driver.</p></li>
<li><p>Being an I2C device, we configure it just like any other I2C
device. See <a class="reference internal" href="../i2c/topic.html"><span class="doc">Linux and I2C (using LM73 Temperature Sensor as Slave)</span></a> for how I2C devices are configured
on Linux.</p></li>
<li><p>Once DS2482 is configured, we can attach our OneWire device(s) to
it.</p></li>
</ul>
</section>
<section id="wiring-attach-ds2482-800-via-i2c">
<span id="configure-i2c-address"></span><h3><a class="toc-backref" href="#id17" role="doc-backlink">Wiring: Attach DS2482-800 via I2C</a><a class="headerlink" href="#wiring-attach-ds2482-800-via-i2c" title="Link to this heading">#</a></h3>
<p>The DS2482-800 is an I2C device just like any other I2C device, so we
attach it just like any other. Here’s the pinout, together with the
Raspberry header for convenience:</p>
<div class="pst-scrollable-table-container"><table class="table table-left">
<thead>
<tr class="row-odd"><th class="head"><p>DS2482-800 pinout</p></th>
<th class="head"><p>Raspberry 40-pin header pinout</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><img alt="../../../../../../_images/DS2482-800-pinout.png" src="../../../../../../_images/DS2482-800-pinout.png" />
</td>
<td><img alt="../../../../../../_images/raspi-pinout.png" src="../../../../../../_images/raspi-pinout.png" />
</td>
</tr>
</tbody>
</table>
</div>
<p>Connect pins as follows:</p>
<div class="pst-scrollable-table-container"><table class="table table-left">
<thead>
<tr class="row-odd"><th class="head"><p>DS2482-800</p></th>
<th class="head"><p>Raspberry</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">AD0</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">GND</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">AD1</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">GND</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">AD2</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">GND</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SDA</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">GPIO</span> <span class="pre">2</span> <span class="pre">(SDA)</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SCL</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">GPIO</span> <span class="pre">3</span> <span class="pre">(SCL)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">VCC</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">3V3</span> <span class="pre">power</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">GND</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Ground</span></code></p></td>
</tr>
</tbody>
</table>
</div>
<p>You may vary the assignment of the <code class="docutils literal notranslate"><span class="pre">AD*</span></code> address selection
pins. Here, we choose to wire them to ground (0) - according to the
diagram below this gives address <code class="docutils literal notranslate"><span class="pre">0x18</span></code>, or <code class="docutils literal notranslate"><span class="pre">0b0011000</span></code>.</p>
<img alt="../../../../../../_images/DS2482-800-address.png" src="../../../../../../_images/DS2482-800-address.png" />
</section>
<section id="configure-software">
<h3><a class="toc-backref" href="#id18" role="doc-backlink">Configure Software</a><a class="headerlink" href="#configure-software" title="Link to this heading">#</a></h3>
<p>Next, we configure software. Please read <a class="reference internal" href="../i2c/topic.html"><span class="doc">Linux and I2C (using LM73 Temperature Sensor as Slave)</span></a> for
details; here we just reproduce shortly what is explained there.</p>
<section id="enable-i2c-and-check-bootloader-config-boot-config-txt">
<span id="w1-i2c-raspi-bootloader"></span><h4><a class="toc-backref" href="#id19" role="doc-backlink">Enable I2C, and Check (Bootloader config, <code class="docutils literal notranslate"><span class="pre">/boot/config.txt)</span></code></a><a class="headerlink" href="#enable-i2c-and-check-bootloader-config-boot-config-txt" title="Link to this heading">#</a></h4>
<p>In <code class="docutils literal notranslate"><span class="pre">/boot/config.txt</span></code>, add the following line.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>dtparam=i2c_arm=on
</pre></div>
</div>
<p>Reboot and verify that all is well.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">I2C platform driver loaded?</span><a class="headerlink" href="#id5" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>lsmod<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>i2c
<span class="go">i2c_bcm2835            16384  0</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">I2C bus #1 visible in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code></span><a class="headerlink" href="#id6" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/bus/i2c/devices/i2c-1
<span class="go">lrwxrwxrwx 1 root root 0 Oct  4 12:43 /sys/bus/i2c/devices/i2c-1 -&gt; ../../../devices/platform/soc/fe804000.i2c/i2c-1</span>
</pre></div>
</div>
</div>
</section>
<section id="verify-that-our-device-is-there-i2cdetect">
<span id="w1-i2c-raspi-i2cdetect"></span><h4><a class="toc-backref" href="#id20" role="doc-backlink">Verify That Our Device Is There (<code class="docutils literal notranslate"><span class="pre">i2cdetect)</span></code></a><a class="headerlink" href="#verify-that-our-device-is-there-i2cdetect" title="Link to this heading">#</a></h4>
<aside class="sidebar">
<p><strong>Documentation</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://linux.die.net/man/8/i2cdetect">man -s 8 i2cdetect</a></p></li>
<li><p><a class="reference external" href="https://man7.org/linux/man-pages/man5/modules-load.d.5.html">man -s 5 modules-load.d</a></p></li>
</ul>
</aside>
<p>This is done using the <code class="docutils literal notranslate"><span class="pre">i2cdetect</span></code> tool which accesses the I2C bus
from userspace; it needs <code class="docutils literal notranslate"><span class="pre">/dev/i2c-1</span></code> to probe I2C bus #1. Load the
<code class="docutils literal notranslate"><span class="pre">i2c-dev</span></code> driver which provides <code class="docutils literal notranslate"><span class="pre">/dev/i2c-N</span></code> for each bus #N that
is found on the system.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">i2c-dev</span></code> exposes bus to userspace</span><a class="headerlink" href="#id7" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>modprobe<span class="w"> </span>i2c-dev
<span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>/dev/i2c-1
<span class="go">crw-rw---- 1 root i2c 89, 1 Sep 29 14:27 /dev/i2c-1</span>
</pre></div>
</div>
</div>
<p>You probably want to load <code class="docutils literal notranslate"><span class="pre">i2c-dev</span></code> automatically, at boot time. In
this case, add the following line either to <code class="docutils literal notranslate"><span class="pre">/etc/modules</span></code> directly,
or to a new config file, say, <code class="docutils literal notranslate"><span class="pre">/etc/modules-load.d/i2c.conf</span></code> :</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">Add to <code class="docutils literal notranslate"><span class="pre">/etc/modules</span></code></span><a class="headerlink" href="#id8" title="Link to this code">#</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>i2c-dev
</pre></div>
</div>
</div>
<p>The device should now be there at the <a class="reference internal" href="#configure-i2c-address"><span class="std std-ref">configured address</span></a> (<code class="docutils literal notranslate"><span class="pre">0x18</span></code> in our case),</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">i2c-detect</span></code> scans bus</span><a class="headerlink" href="#id9" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>i2cdetect<span class="w"> </span>-y<span class="w"> </span><span class="m">1</span>
<span class="go">     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f</span>
<span class="go">00:          -- -- -- -- -- -- -- -- -- -- -- -- --</span>
<span class="go">10: -- -- -- -- -- -- -- -- 18 -- -- -- -- -- -- --</span>
<span class="go">20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
<span class="go">30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
<span class="go">40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
<span class="go">50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
<span class="go">60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
<span class="go">70: -- -- -- -- -- -- -- --</span>
</pre></div>
</div>
</div>
</section>
<section id="announce-hotplug-ds2482-to-linux">
<h4><a class="toc-backref" href="#id21" role="doc-backlink">Announce (“Hotplug”) DS2482 to Linux</a><a class="headerlink" href="#announce-hotplug-ds2482-to-linux" title="Link to this heading">#</a></h4>
<p>Finally, tell Linux about the new device at address <code class="docutils literal notranslate"><span class="pre">0x18</span></code>. This
will load the responsible driver - it is that driver that is
responsible to communicate with the OneWire devices on the new buses
(the DS2482-800 bring eight buses).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>-i
<span class="gp"># </span><span class="nb">echo</span><span class="w"> </span>ds2482<span class="w"> </span>0x18<span class="w"> </span>&gt;<span class="w"> </span>/sys/bus/i2c/devices/i2c-1/new_device
<span class="gp"># </span><span class="nb">exit</span>
</pre></div>
</div>
<p>You probably want to do this automatically during boot. Download the
following file into <code class="docutils literal notranslate"><span class="pre">/usr/local/lib/systemd/system/</span></code> (create that
directory if it does not exist),</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../../../../_downloads/1079b40b40dc146db96b877a06a872ed/ds2482.service"><code class="xref download docutils literal notranslate"><span class="pre">ds2482.service</span></code></a></span><a class="headerlink" href="#id10" title="Link to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">DS2482</span><span class="o">-</span><span class="mi">800</span><span class="o">@</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x18</span><span class="p">)</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;echo ds2482 0x18 &gt; /sys/bus/i2c/devices/i2c-1/new_device&#39;</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>See if driver is loaded,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>lsmod<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>ds2482
<span class="go">ds2482                 16384  0</span>
<span class="go">wire                   36864  2 ds2482</span>
</pre></div>
</div>
<p>Eight buses there in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code>,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/bus/w1/devices/
<span class="go">total 0</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:52 w1_bus_master1 -&gt; ../../../devices/w1_bus_master1</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:52 w1_bus_master2 -&gt; ../../../devices/w1_bus_master2</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:52 w1_bus_master3 -&gt; ../../../devices/w1_bus_master3</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:52 w1_bus_master4 -&gt; ../../../devices/w1_bus_master4</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:52 w1_bus_master5 -&gt; ../../../devices/w1_bus_master5</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:52 w1_bus_master6 -&gt; ../../../devices/w1_bus_master6</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:52 w1_bus_master7 -&gt; ../../../devices/w1_bus_master7</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:52 w1_bus_master8 -&gt; ../../../devices/w1_bus_master8</span>
</pre></div>
</div>
</section>
</section>
<section id="wiring-attach-onewire-device-to-ds2482-800">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">Wiring: Attach OneWire Device to DS2482-800</a><a class="headerlink" href="#wiring-attach-onewire-device-to-ds2482-800" title="Link to this heading">#</a></h3>
<p>Finally, in analogy to <a class="reference internal" href="#bitbang-device"><span class="std std-ref">wiring a device to the bitbanging master</span></a>, we now wire our OneWire device to DS2482. Connect
the device’s data line to any of DS2482-800’s <code class="docutils literal notranslate"><span class="pre">IO*</span></code> pins, and supply
power and ground.</p>
<div class="pst-scrollable-table-container"><table class="table table-left">
<thead>
<tr class="row-odd"><th class="head"><p>OneWire device</p></th>
<th class="head"><p>DS2482-800</p></th>
<th class="head"><p>Raspberry</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Data</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IO*</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>VCC</p></td>
<td></td>
<td><p>3V3</p></td>
</tr>
<tr class="row-even"><td><p>Ground</p></td>
<td></td>
<td><p>Ground</p></td>
</tr>
</tbody>
</table>
</div>
<p>Reboot, and see the device appear in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/bus/w1/devices/
<span class="go">total 0</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:58 28-01144fe43baa -&gt; ../../../devices/w1_bus_master8/28-01144fe43baa</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:58 w1_bus_master1 -&gt; ../../../devices/w1_bus_master1</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:58 w1_bus_master2 -&gt; ../../../devices/w1_bus_master2</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:58 w1_bus_master3 -&gt; ../../../devices/w1_bus_master3</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:58 w1_bus_master4 -&gt; ../../../devices/w1_bus_master4</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:58 w1_bus_master5 -&gt; ../../../devices/w1_bus_master5</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:58 w1_bus_master6 -&gt; ../../../devices/w1_bus_master6</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:58 w1_bus_master7 -&gt; ../../../devices/w1_bus_master7</span>
<span class="go">lrwxrwxrwx 1 root root 0 Oct 26 09:58 w1_bus_master8 -&gt; ../../../devices/w1_bus_master8</span>
</pre></div>
</div>
</section>
</section>
<section id="over-engineering-beauty">
<h2><a class="toc-backref" href="#id23" role="doc-backlink">Over-Engineering? Beauty?</a><a class="headerlink" href="#over-engineering-beauty" title="Link to this heading">#</a></h2>
<p>What happened so far sounds complicated, and it is.</p>
<section id="hardware-bringup">
<h3><a class="toc-backref" href="#id24" role="doc-backlink">Hardware Bringup</a><a class="headerlink" href="#hardware-bringup" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>All the wiring</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">w1-gpio</span></code> configuration in <code class="docutils literal notranslate"><span class="pre">/boot/config.txt</span></code></p></li>
<li><p>I2C configuration in <code class="docutils literal notranslate"><span class="pre">/boot/config.txt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">ds2482</span> <span class="pre">0x18</span> <span class="pre">&gt;</span> <span class="pre">/sys/bus/i2c/devices/i2c-1/new_device</span></code> to load a driver</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lsmod</span></code></p></li>
<li><p>All the files in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code></p></li>
</ul>
<p>All in all, this is hardware bringup. Using a DS2482, for example,
requires</p>
<ul class="simple">
<li><p>a running I2C bus</p></li>
<li><p>code that can communicate with DS2482</p></li>
<li><p>code that can interpret DS2482’s OneWire talk</p></li>
</ul>
<p>In traditional embedded platforms, running traditional embedded
operating systems, one would have to write code to configure the
system in such a way.</p>
<p>Linux has <em>abstractions</em>. My favorite abstraction is <em>“Everything is a
file”</em>, and that is used heavily here. No matter what hardware
platform, in Linux I2C slaves are added by writing `` ds2482 0x18``
into <code class="docutils literal notranslate"><span class="pre">/sys/bus/i2c/devices/i2c-&lt;busno&gt;/new_device</span></code>, and <em>existing
code</em> is loaded in the form of a kernel module (a “driver”).</p>
<p>In Linux, OneWire devices are represented as directories
(<code class="docutils literal notranslate"><span class="pre">/sys/bus/w1/devices/28-01144fe43baa</span></code>), no matter if you use a
software/bitbanging master or if the master is implemented in hardware
<a class="footnote-reference brackets" href="#w1-cpu" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.</p>
<p>This is exactly the separation of concerns that Linux
enforces. Hardware bringup is the responsibility of the <em>kernel</em> (and
the bootloader, for that matter).</p>
</section>
<section id="device-usage">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Device Usage</a><a class="headerlink" href="#device-usage" title="Link to this heading">#</a></h3>
<p>Once the hardware is configured to this point (the kernel has booted,
drivers are loaded), the devices can be used <em>without any knowledge of
the underlying hardware</em>.</p>
<p>The Linux OneWire interface makes heavy use of the file abtraction,
which is good because everything that someone who wants to read
temperatures from OneWire sensors, for example, has to know is how to
read a file, and which.</p>
<p>See the <a class="reference external" href="https://www.kernel.org/doc/html/latest/w1/w1-generic.html">Kernel OneWire documentation</a> for
details of the OneWire interface.</p>
<p>What follows is a walk-through of how to deal with a specific OneWire
device, the DS18B20 temperature sensor. View it as a placeholder for
any other such device.</p>
</section>
</section>
<section id="slave-device-ds18b20-temperature-sensor">
<h2>Slave Device: <a class="reference external" href="https://www.maximintegrated.com/en/products/DS18B20">DS18B20</a> Temperature Sensor<a class="headerlink" href="#slave-device-ds18b20-temperature-sensor" title="Link to this heading">#</a></h2>
<div class="pst-scrollable-table-container"><table class="table table-left">
<tbody>
<tr class="row-odd"><td><p>The <a class="reference external" href="https://www.maximintegrated.com/en/products/DS18B20">DS18B20</a>
OneWire temperature sensor is a popular device. You can find
parts that come prepackaged in a metal case; these are still
affordable, and really easy to deploy.</p></td>
<td><figure class="align-left">
<img alt="DS18B20 (packaged)" src="../../../../../../_images/ds18b20-packaged.jpg" />
</figure>
</td>
</tr>
</tbody>
</table>
</div>
<section id="using-the-device">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">Using the Device</a><a class="headerlink" href="#using-the-device" title="Link to this heading">#</a></h3>
<p>In most if not all cases, Linux presents hardware as a set of regular
files in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code>. Read on for how.</p>
<section id="as-a-generic-onewire-device">
<h4><a class="toc-backref" href="#id28" role="doc-backlink">As a Generic OneWire Device</a><a class="headerlink" href="#as-a-generic-onewire-device" title="Link to this heading">#</a></h4>
<p>OneWire masters automatically enumerate their buses, by definition -
so our device should show up automatically in a dedicated directory
<code class="docutils literal notranslate"><span class="pre">/sys/bus/w1/devices/&lt;manufacturer&gt;-&lt;device-address&gt;</span></code>. (If all is
well; see below for caveats.)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/bus/w1/devices/28-01144fe43baa/
<span class="go">total 0</span>
<span class="go">-rw-r--r-- 1 root root 4096 Sep 22 12:19 alarms</span>
<span class="go">-rw-r--r-- 1 root root 4096 Sep 22 12:19 conv_time</span>
<span class="go">lrwxrwxrwx 1 root root    0 Sep 22 12:19 driver -&gt; ../../../bus/w1/drivers/w1_slave_driver</span>
<span class="go">--w------- 1 root root 4096 Sep 22 12:19 eeprom</span>
<span class="go">-r--r--r-- 1 root root 4096 Sep 22 12:19 ext_power</span>
<span class="go">-rw-r--r-- 1 root root 4096 Sep 22 12:19 features</span>
<span class="go">drwxr-xr-x 3 root root    0 Sep 22 12:16 hwmon</span>
<span class="go">-r--r--r-- 1 root root 4096 Sep 22 12:19 id</span>
<span class="go">-r--r--r-- 1 root root 4096 Sep 22 12:19 name</span>
<span class="go">drwxr-xr-x 2 root root    0 Sep 22 12:19 power</span>
<span class="go">-rw-r--r-- 1 root root 4096 Sep 22 12:19 resolution</span>
<span class="go">lrwxrwxrwx 1 root root    0 Sep 22 12:16 subsystem -&gt; ../../../bus/w1</span>
<span class="go">-r--r--r-- 1 root root 4096 Sep 22 12:19 temperature</span>
<span class="go">-rw-r--r-- 1 root root 4096 Sep 22 12:16 uevent</span>
<span class="go">-rw-r--r-- 1 root root 4096 Sep 22 12:19 w1_slave</span>
</pre></div>
</div>
<p>A file that is common to all OneWire devices (not only temperature
sensors) is <code class="docutils literal notranslate"><span class="pre">w1_slave</span></code>, which already contains all we need: the
temperature in milli-celsius (22750).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>/sys/bus/w1/devices/28-01144fe43baa/w1_slave
<span class="go">6c 01 4b 46 7f ff 0c 10 2b : crc=2b YES</span>
<span class="go">6c 01 4b 46 7f ff 0c 10 2b t=22750</span>
</pre></div>
</div>
</section>
<section id="as-a-hardware-monitoring-hwmon-device">
<h4><a class="toc-backref" href="#id29" role="doc-backlink">As a Hardware Monitoring (<code class="docutils literal notranslate"><span class="pre">hwmon</span></code>) Device</a><a class="headerlink" href="#as-a-hardware-monitoring-hwmon-device" title="Link to this heading">#</a></h4>
<p>A different aspect to our sensor, DS18B20, is that it is a temperature
sensor - independent of which hardware it is. There is an entire
framework inside the kernel, <code class="docutils literal notranslate"><span class="pre">hwmon</span></code>, to cover such devices - no
matter if they are OneWire or I2C (or …)  devices, or if they are
reachable via a CPU internal bus.</p>
<p>As such (a temperature sensor), the device appears under an
alternative location in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code>,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/class/hwmon/hwmon1/
<span class="go">total 0</span>
<span class="go">lrwxrwxrwx 1 root root    0 Sep 22 14:44 device -&gt; ../../../28-01144fe43baa</span>
<span class="go">-r--r--r-- 1 root root 4096 Sep 22 14:44 name</span>
<span class="go">drwxr-xr-x 2 root root    0 Sep 22 14:44 power</span>
<span class="go">lrwxrwxrwx 1 root root    0 Sep 22 14:44 subsystem -&gt; ../../../../../class/hwmon</span>
<span class="go">-r--r--r-- 1 root root 4096 Sep 22 14:44 temp1_input</span>
<span class="go">-rw-r--r-- 1 root root 4096 Sep 22 12:16 uevent</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">temp1_input</span></code> is what contains information for us (again, the
temperature in milli-celsius):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>/sys/class/hwmon/hwmon1/temp1_input
<span class="go">22750</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li><p><strong>Question</strong>: how do I know that it’s my sensor in <code class="docutils literal notranslate"><span class="pre">hwmon1</span></code>?
<code class="docutils literal notranslate"><span class="pre">hwmon1</span></code> seems like a randomly/sequentially chosen name, and I
assume the order is not always the same across boots.</p></li>
<li><p><strong>Answer</strong>: correct. But the address of the sensor (that is how
you identify your devices in the end) is globally unique. You can
use that to find the correct <code class="docutils literal notranslate"><span class="pre">/sys/class/hwmon/</span></code> subdirectory.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/class/hwmon/hwmon1/device
<span class="go">lrwxrwxrwx 1 root root 0 Sep 22 14:44 /sys/class/hwmon/hwmon1/device -&gt; ../../../28-01144fe43baa</span>
</pre></div>
</div>
</li>
</ul>
</div>
</section>
<section id="lm-sensors">
<h4><a class="toc-backref" href="#id30" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">lm-sensors</span></code></a><a class="headerlink" href="#lm-sensors" title="Link to this heading">#</a></h4>
<p>It is the <code class="docutils literal notranslate"><span class="pre">hwmon</span></code> hardware-independent sensor interface that the
userspace <code class="docutils literal notranslate"><span class="pre">lm-sensors</span></code> framework builds upon. (<a class="reference external" href="https://github.com/lm-sensors/lm-sensors">Github</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Lm_sensors">Wikipedia</a>.)</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">Installation (on the Raspi)</span><a class="headerlink" href="#id11" title="Link to this code">#</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>lm-sensors
</pre></div>
</div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sensors
<span class="go">rpi_volt-isa-0000</span>
<span class="go">Adapter: ISA adapter</span>
<span class="go">in0:              N/A</span>

<span class="go">cpu_thermal-virtual-0</span>
<span class="go">Adapter: Virtual device</span>
<span class="go">temp1:        +50.1°C</span>

<span class="go">w1_slave_temp-virtual-0</span>
<span class="go">Adapter: Virtual device</span>
<span class="go">temp1:        +21.4°C</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="onewire-caveats">
<h2><a class="toc-backref" href="#id31" role="doc-backlink">OneWire Caveats</a><a class="headerlink" href="#onewire-caveats" title="Link to this heading">#</a></h2>
<section id="bus-topology">
<h3><a class="toc-backref" href="#id32" role="doc-backlink">Bus Topology</a><a class="headerlink" href="#bus-topology" title="Link to this heading">#</a></h3>
<p>For stability, a OneWire setup should not exhibit a star
topology. Rather, it is best to have one long main line, with only
very short branches off of it where the sensors are attached.</p>
<p>Maxim Integrated has a tutorial, <a class="reference external" href="https://www.maximintegrated.com/en/app-notes/index.mvp/id/148">Guidelines for Reliable Long Line
1-Wire Networks</a>. There
they define the terms <em>radious</em> and <em>weight</em>; it is definitely worth
reading.</p>
</section>
<section id="error-symptoms">
<span id="id3"></span><h3><a class="toc-backref" href="#id33" role="doc-backlink">Error Symptoms</a><a class="headerlink" href="#error-symptoms" title="Link to this heading">#</a></h3>
<ul>
<li><p><strong>Devices disappear</strong>, and are replaced by ones that are named like
<code class="docutils literal notranslate"><span class="pre">00-0c4000000000</span></code>. Here, <code class="docutils literal notranslate"><span class="pre">00</span></code> is the family which is completely
bogus; for example, 28 (hex) would be the expected family. (I
believe 0x28 stands for “Dallas”).</p></li>
<li><p><strong>Reading fails a CRC check</strong>,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>/sys/bus/w1/devices/28-02131d9920aa/w1_slave
<span class="go">20 01 4b 46 7f ff 0c 10 5d : crc=5d NO</span>
<span class="go">20 01 4b 46 7f ff 0c 10 5d t=18000</span>
</pre></div>
</div>
</li>
<li><p><strong>Reading gives me a temperature of 0 degrees.</strong></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>/sys/bus/w1/devices/28-011432f138f9/w1_slave
<span class="go">00 00 00 00 00 00 00 00 00 : crc=00 YES</span>
<span class="go">00 00 00 00 00 00 00 00 00 t=0</span>
</pre></div>
</div>
<p>This is the worst thermometer error you can encounter because it
does not declare himself as such. One can imagine what sorts of
heating control misbehavior a room temperature of zero degrees would
cause.</p>
</li>
</ul>
<p>In my experience <a class="footnote-reference brackets" href="#not-a-hw-guy" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>, the bitbanging driver is only good
for the most trivial setups. As soon as you have a larger
installation, you’ll see errors of the above sort over and over.</p>
<p>Over time, I was able to reduce the instabilities by cutting the
initial star topology down to what I describe above. Still, there were
some glitches from time to time. I blame those on the bitbanging in
software. OneWire is a slow and easy protocol, but there are still
timing constraints that might not be met in some cases.</p>
<p>Sure, I could have tried the Linux realtime options to get better
response and timing guarantees. On the other hand, heating control is
something that is exactly the opposite of realtime. If a pump is
turned on a minute too late, still nothing burns down - this is not a
nuclear power plant.</p>
<p>So no: no realtime wanted. Especially because it would have been just
another tryout.</p>
</section>
</section>
<section id="links">
<h2><a class="toc-backref" href="#id34" role="doc-backlink">Links</a><a class="headerlink" href="#links" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/1-Wire">OneWire (WikiPedia)</a></p></li>
<li><p><a class="reference external" href="https://www.maximintegrated.com/en/app-notes/index.mvp/id/148">Guidelines for Reliable Long Line 1-Wire Networks</a></p></li>
<li><p><a class="reference external" href="https://www.kernel.org/doc/html/latest/w1/w1-generic.html">Kernel OneWire Documentation</a></p></li>
<li><p><a class="reference external" href="https://www.maximintegrated.com/en/products/DS18B20">DS18B20 Temperature Sensor</a></p></li>
<li><p><a class="reference external" href="https://www.maximintegrated.com/en/products/interface/controllers-expanders/DS2482-800.html">DS2482-800 I2C 8-Channel OneWire Master</a></p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Bit_banging">Bitbanging</a></p></li>
<li><p><a class="reference external" href="https://github.com/lm-sensors/lm-sensors">lm-sensors on Github</a></p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Lm_sensors">lm-sensors on Wikipedia</a></p></li>
</ul>
<p class="rubric">Footnotes</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="not-a-hw-guy" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">1</a><span class="fn-bracket">]</span></span>
<p>I am not a hardware expert.</p>
</aside>
<aside class="footnote brackets" id="w1-cpu" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p>The Raspberry CPU has no OneWire master built-in, but
there are SoC’s out there which have. Linux support for
these CPUs means that someone has implemented a driver
for that master, just like there is a driver for the
external DS2482 add-on.</p>
</aside>
</aside>
</section>
</section>

<div class="section ablog__blog_comments">
   
</div>

                </article>
              
              
              
              
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#master-device-alterative-1-w1-gpio-onewire-master-in-software">Master Device, Alterative 1: <code class="docutils literal notranslate"><span class="pre">w1-gpio</span></code> - OneWire Master in Software</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wiring-attach-onewire-device-to-gpio-pin">Wiring: Attach OneWire Device to GPIO Pin</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#master-device-alterative-2-ds2482-i2c-onewire-master-in-hardware">Master Device, Alterative 2: DS2482 - I2C OneWire Master in Hardware</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Overview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wiring-attach-ds2482-800-via-i2c">Wiring: Attach DS2482-800 via I2C</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-software">Configure Software</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#enable-i2c-and-check-bootloader-config-boot-config-txt">Enable I2C, and Check (Bootloader config, <code class="docutils literal notranslate"><span class="pre">/boot/config.txt)</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-that-our-device-is-there-i2cdetect">Verify That Our Device Is There (<code class="docutils literal notranslate"><span class="pre">i2cdetect)</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#announce-hotplug-ds2482-to-linux">Announce (“Hotplug”) DS2482 to Linux</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wiring-attach-onewire-device-to-ds2482-800">Wiring: Attach OneWire Device to DS2482-800</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#over-engineering-beauty">Over-Engineering? Beauty?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hardware-bringup">Hardware Bringup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#device-usage">Device Usage</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#slave-device-ds18b20-temperature-sensor">Slave Device: DS18B20 Temperature Sensor</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-device">Using the Device</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#as-a-generic-onewire-device">As a Generic OneWire Device</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#as-a-hardware-monitoring-hwmon-device">As a Hardware Monitoring (<code class="docutils literal notranslate"><span class="pre">hwmon</span></code>) Device</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lm-sensors"><code class="docutils literal notranslate"><span class="pre">lm-sensors</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#onewire-caveats">OneWire Caveats</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bus-topology">Bus Topology</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#error-symptoms">Error Symptoms</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#links">Links</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2019-2025 (GPLv3), Jörg Faschingbauer.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__center">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <div class="tocsection sourcelink">
    <a href="../../../../../../_sources/trainings/material/soup/linux/hardware/w1/topic.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>