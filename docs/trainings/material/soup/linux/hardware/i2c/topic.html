
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta content="I2C (using LM73)" name="description" />
<meta content="linux, inter intergrated circuit, i2c, sensors, lm-sensors, lm73, raspberry pi, raspi, userspace, hwmon, sysfs" name="keywords" />

    <title>Linux and I2C (using LM73 Temperature Sensor as Slave) &#8212; Jörg Faschingbauer</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/jf-alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/css/lightbox.css" />
    <script data-url_root="../../../../../../" id="documentation_options" src="../../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../../_static/jquery.js"></script>
    <script src="../../../../../../_static/underscore.js"></script>
    <script src="../../../../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/js/lightbox-plus-jquery.min.js"></script>
    <script src="../../../../../../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js"></script>
    <link rel="canonical" href="https://www.faschingbauer.me/trainings/material/soup/linux/hardware/i2c/topic.html" />
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" />
    <link rel="next" title="PWM Userspace Interface (using PCA9685)" href="../pwm/topic.html" />
    <link rel="prev" title="Linux and OneWire (using DS18B20 Temperature Sensor as Slave)" href="../w1/topic.html" /> 
   
  <link rel="stylesheet" href="../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />
 
<link
  rel="alternate"
  type="application/atom+xml"
  href="../../../../../../blog/atom.xml"
  title="Jörg Faschingbauer"
/>
 
<link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet" />

<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../../../../index.html">
    <img class="logo" src="../../../../../../_static/logo.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Linux und Open Source</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Schulungen</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../../index.html">Kursangebot</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../index.html">Unterlagen &amp; Download</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../../index.html">Topics</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../python/group.html">Python Programming: From Absolute Beginner to Advanced Productivity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../c/group.html">The C Programming Language</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cxx-todo/index.html">C++: TODO List</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cxx/group.html">C++: Miscellaneous Live-Hacking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cxx03/group.html">C++ 03</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cxx11/group.html">C++ 11</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../group.html">Linux</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../../permissions/group.html">Permissions</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="../group.html">Linux Hardware Interfaces</a><ul class="current">
<li class="toctree-l5"><a class="reference internal" href="../w1/topic.html">Linux and OneWire (using DS18B20 Temperature Sensor as Slave)</a></li>
<li class="toctree-l5 current"><a class="current reference internal" href="#">Linux and I2C (using LM73 Temperature Sensor as Slave)</a></li>
<li class="toctree-l5"><a class="reference internal" href="../pwm/topic.html">PWM Userspace Interface (using PCA9685)</a></li>
<li class="toctree-l5"><a class="reference internal" href="../brushless-motor/topic.html">Controlling a Brushless Motor With Raspberry Pi</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../drafts/group.html">Drafts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../sysprog/group.html">Systems Programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../unittest/group.html">Unit Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../kernel/index.html">Linux Driver Development</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../devenv/group.html">Linux: Development Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../graph.html">Generated Topic Graph</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../org.html">Organisatorisches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../codex.html">Datenschutz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../log/index.html">Bisher Gehaltene</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../about/myself/index.html">Über Mich</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../about/site/index.html">About This Site</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Blog</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../blog/index.html">Posts</a></li>
</ul>


        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
             <section id="linux-and-i2c-using-lm73-temperature-sensor-as-slave">
<h1>Linux and I2C (using LM73 Temperature Sensor as Slave)<a class="headerlink" href="#linux-and-i2c-using-lm73-temperature-sensor-as-slave" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id10">Overview</a></p></li>
<li><p><a class="reference internal" href="#configuring-i2c-master" id="id11">Configuring I2C Master</a></p>
<ul>
<li><p><a class="reference internal" href="#enable-i2c-load-bcm2835-platform-driver" id="id12">Enable I2C, Load BCM2835 Platform Driver</a></p></li>
<li><p><a class="reference internal" href="#enable-userspace-i2c" id="id13">Enable Userspace I2C</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#slave-device-lm73" id="id14">Slave Device: LM73</a></p>
<ul>
<li><p><a class="reference internal" href="#optional-address-selection" id="id15">Optional: Address Selection</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#connecting-lm73-to-raspberry-pi" id="id16">Connecting LM73 to Raspberry Pi</a></p></li>
<li><p><a class="reference internal" href="#i2c-tools-i2cdetect-diagnostics-detecting-devices" id="id17"><code class="docutils literal notranslate"><span class="pre">i2c-tools</span></code>/<code class="docutils literal notranslate"><span class="pre">i2cdetect</span></code>: Diagnostics, Detecting Devices</a></p></li>
<li><p><a class="reference internal" href="#using-the-device-talking-i2c-from-userspace" id="id18">Using the Device: Talking I2C from Userspace</a></p></li>
<li><p><a class="reference internal" href="#using-the-device-hwmon-hardware-monitoring" id="id19">Using the Device: <code class="docutils literal notranslate"><span class="pre">hwmon</span></code> - Hardware Monitoring</a></p>
<ul>
<li><p><a class="reference internal" href="#building-the-kernel-enabling-lm73" id="id20">Building the Kernel, Enabling LM73</a></p></li>
<li><p><a class="reference internal" href="#loading-the-driver" id="id21">Loading the Driver</a></p></li>
<li><p><a class="reference internal" href="#hardware-monitoring-hwmon-devices" id="id22">Hardware Monitoring (<code class="docutils literal notranslate"><span class="pre">hwmon</span></code>) Devices</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="overview">
<h2><a class="toc-backref" href="#id10">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This article shows how you use Linux to communicate with <a class="reference external" href="https://en.wikipedia.org/wiki/I%C2%B2C">I2C</a> devices. We use …</p>
<ul class="simple">
<li><p>Rasperry Pi because everything’s easy there. This article’s
principles hold unmodified for other devices that run Linux (more
handwork might be needed though).</p></li>
<li><p>The <em>Hardware Monitoring</em> interface in <code class="docutils literal notranslate"><span class="pre">/sys/class/hwmon</span></code></p></li>
<li><p>The <a class="reference external" href="https://www.ti.com/product/LM73">Texas Instruments LM73</a>
temperature sensor.</p></li>
</ul>
</section>
<section id="configuring-i2c-master">
<h2><a class="toc-backref" href="#id11">Configuring I2C Master</a><a class="headerlink" href="#configuring-i2c-master" title="Permalink to this headline">¶</a></h2>
<p>The Raspberry has two I2C host controllers (“masters”) built-in. One
of those, <code class="docutils literal notranslate"><span class="pre">i2c-0</span></code>, is dedicated to display and touch handling and is
of no relevance here.</p>
<p>The other, <code class="docutils literal notranslate"><span class="pre">i2c-1</span></code>, is for maker’s use. This is what this section is
about.</p>
<section id="enable-i2c-load-bcm2835-platform-driver">
<h3><a class="toc-backref" href="#id12">Enable I2C, Load BCM2835 Platform Driver</a><a class="headerlink" href="#enable-i2c-load-bcm2835-platform-driver" title="Permalink to this headline">¶</a></h3>
<aside class="sidebar">
<p class="sidebar-title">Raspberry Pi GPIO header pinout</p>
<img alt="../../../../../../_images/raspi-pinout.png" src="../../../../../../_images/raspi-pinout.png" />
</aside>
<p>By default, on <em>Raspberry Pi OS</em> everything’s off. To turn something
on, you configure the bootloader to turn it on. The bootloader will
then pass the relevant information to the kernel which will react
accordingly - load the appropriate drivers, for example.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">/boot/config.txt</span></code> insert the following line <a class="footnote-reference brackets" href="#config-uncomment" id="id1">1</a>
…</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>dtparam=i2c_arm=on
</pre></div>
</div>
<p>The effect of enabling I2C is that</p>
<ul class="simple">
<li><p>pins <em>GPIO2</em> and <em>GPIO3</em> are not GPIO pins anymore, but rather their
alternative configurations as <em>data</em> and <em>clock</em>, respectively, are
enabled. See the pinout diagram.</p></li>
<li><p>the platform I2C driver is loaded.</p></li>
</ul>
<p><strong>Reboot</strong>, and check:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">I2C platform driver</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>lsmod <span class="p">|</span>grep i2c
<span class="go">i2c_bcm2835            16384  0</span>
</pre></div>
</div>
</div>
<p>We can see a userspace representation of the bus in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code>,</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">I2C bus #1 visible in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code></span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls -l /sys/bus/i2c/devices/i2c-1
<span class="go">lrwxrwxrwx 1 root root 0 Oct  4 12:43 /sys/bus/i2c/devices/i2c-1 -&gt; ../../../devices/platform/soc/fe804000.i2c/i2c-1</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">raspi-config</span></code> tool to do the same in a more
comfortable manner. Here in this article, we do <em>not</em> use any of
those decadent tools. These are Raspberry specific and not
available on any other Linux device <a class="footnote-reference brackets" href="#config-txt-decadent-enough" id="id2">2</a>.</p>
<p>See <a class="reference external" href="https://www.raspberrypi.org/documentation/computers/configuration.html">here</a>
for decadent documentation of <code class="docutils literal notranslate"><span class="pre">raspi-config</span></code>.</p>
</div>
</section>
<section id="enable-userspace-i2c">
<h3><a class="toc-backref" href="#id13">Enable Userspace I2C</a><a class="headerlink" href="#enable-userspace-i2c" title="Permalink to this headline">¶</a></h3>
<p>We will be using a <a class="reference external" href="https://www.ti.com/product/LM73">LM73</a>
temperature sensor, for which a kernel driver exists. This means it is
not strictly necessary to enable the I2C userspace interface - it is
helpful though if you want to do diagnostics such as scanning an I2C
bus for available devices.</p>
<p>Load the driver, <code class="docutils literal notranslate"><span class="pre">i2c_dev</span></code>, manually first to see what is going
on. This will create a <em>character device</em> <code class="docutils literal notranslate"><span class="pre">/dev/i2c-1</span></code> which
represents the I2C bus #1.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>modprobe i2c-dev
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls -l /dev/i2c-1
<span class="go">crw-rw---- 1 root i2c 89, 1 Sep 29 14:27 /dev/i2c-1</span>
</pre></div>
</div>
<p>We do not want to load <code class="docutils literal notranslate"><span class="pre">i2c-dev</span></code> manually everytime the Raspberry
has booted, so we write the module name in <code class="docutils literal notranslate"><span class="pre">/etc/modules</span></code>,</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">/etc/modules</span></code></span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>i2c-dev
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The same is accomplished by creating a dedicated file, say
<code class="docutils literal notranslate"><span class="pre">/etc/modules-load.d/i2c</span></code>, with <code class="docutils literal notranslate"><span class="pre">i2c-dev</span></code> in it.</p>
</div>
<p><strong>Reboot</strong>, and check if <code class="docutils literal notranslate"><span class="pre">/etc/i2c-1</span></code> is still there. We will later
see how to detect devices on it using the <code class="docutils literal notranslate"><span class="pre">i2cdetect</span></code> <a class="reference external" href="https://linux.die.net/man/8/i2cdetect">tool</a>.</p>
</section>
</section>
<section id="slave-device-lm73">
<h2><a class="toc-backref" href="#id14">Slave Device: LM73</a><a class="headerlink" href="#slave-device-lm73" title="Permalink to this headline">¶</a></h2>
<aside class="sidebar">
<p class="sidebar-title">Datasheet etc.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.ti.com/product/LM73">LM73 at Texas Instruments</a></p></li>
<li><p><a class="reference download internal" download="" href="../../../../../../_downloads/f90d6d8d22f7ee8b75303d5e14de0cfe/Thermometer_LM73.pdf"><code class="xref download docutils literal notranslate"><span class="pre">Datasheet</span></code></a></p></li>
</ul>
</aside>
<p>LM73 comes in a SOT-23 package which means that it is rather
small. Power can be supplied in a range between 2.7V and 5.5V. This is
practical since the Pi’s I2C operating voltage is 3.3V; we use the
3.3V rail to power the chip.</p>
<p>During a larger project, I had to write a larger software package and,
among other tasks like PCI communication, talk to LM73. This is where
I decided to isolate the chip for easy testing, and came up with a PCB
to carry only the LM73 and a capacitor.</p>
<img alt="../../../../../../_images/breakout.jpg" src="../../../../../../_images/breakout.jpg" />
<p>The breakout board has a 10-pin IDC header with the following pin
assignments:</p>
<table class="docutils align-left">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><table class="docutils align-left">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>IDC</p></th>
<th class="head"><p>LM73</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>6</p></td>
<td><p>2 (GND)</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>3 (VDD)</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>6 (SMBDAT)</p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>4 (SMBCLK)</p></td>
</tr>
</tbody>
</table>
</td>
<td><img alt="../../../../../../_images/2x5-IDC-Pin-Numbering.png" src="../../../../../../_images/2x5-IDC-Pin-Numbering.png" />
</td>
<td><img alt="../../../../../../_images/lm73-pinout.png" src="../../../../../../_images/lm73-pinout.png" />
</td>
</tr>
</tbody>
</table>
<section id="optional-address-selection">
<h3><a class="toc-backref" href="#id15">Optional: Address Selection</a><a class="headerlink" href="#optional-address-selection" title="Permalink to this headline">¶</a></h3>
<p>The LM73 lets you choose between three different addresses, via pin 1.</p>
<table class="docutils align-left">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Left unconnected (floating)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x48</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Connected to GND</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x49</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Connected to VDD</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x4A</span></code></p></td>
</tr>
</tbody>
</table>
<p>The breakout board takes this into account: a 3 pin header lets you
connect pins with a jumper.</p>
</section>
</section>
<section id="connecting-lm73-to-raspberry-pi">
<h2><a class="toc-backref" href="#id16">Connecting LM73 to Raspberry Pi</a><a class="headerlink" href="#connecting-lm73-to-raspberry-pi" title="Permalink to this headline">¶</a></h2>
<p>Given the above IDC header pinout, we can now connect to the Raspberry
Pi as follows:</p>
<table class="docutils align-left">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Raspberry Pi Header</p></th>
<th class="head"><p>IDC/LM73</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1 (3V3)</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>6 (GND)</p></td>
<td><p>6 (GND)</p></td>
</tr>
<tr class="row-even"><td><p>3 (SDA)</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-odd"><td><p>5 (SCL)</p></td>
<td><p>5</p></td>
</tr>
</tbody>
</table>
</section>
<section id="i2c-tools-i2cdetect-diagnostics-detecting-devices">
<h2><a class="toc-backref" href="#id17"><code class="docutils literal notranslate"><span class="pre">i2c-tools</span></code>/<code class="docutils literal notranslate"><span class="pre">i2cdetect</span></code>: Diagnostics, Detecting Devices</a><a class="headerlink" href="#i2c-tools-i2cdetect-diagnostics-detecting-devices" title="Permalink to this headline">¶</a></h2>
<p>Now we use the <code class="docutils literal notranslate"><span class="pre">i2cdetect</span></code> program from the <code class="docutils literal notranslate"><span class="pre">i2c-tools</span></code> <a class="reference external" href="https://i2c.wiki.kernel.org/index.php/I2C_Tools">package</a> to check if
everything’s connected correctly. I omitted the address jumper, so
LM73 pin 1 is left floating - the chip should appear on address
<code class="docutils literal notranslate"><span class="pre">0x48</span></code>.</p>
<p>Install the <code class="docutils literal notranslate"><span class="pre">i2c-tools</span></code> package,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt install i2c-tools
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">i2c-tools</span></code> brings a set of low-level programs to manipulate I2C
device registers. <code class="docutils literal notranslate"><span class="pre">i2cdetect</span></code> is a tool to “probe” a bus for
devices. Lets proble I2C bus 1 (i.e. <code class="docutils literal notranslate"><span class="pre">/dev/i2c-1</span></code>),</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>i2cdetect -y <span class="m">1</span>
<span class="go">     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f</span>
<span class="go">00:          -- -- -- -- -- -- -- -- -- -- -- -- --</span>
<span class="go">10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
<span class="go">20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
<span class="go">30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
<span class="go">40: -- -- -- -- -- -- -- -- 48 -- -- -- -- -- -- --</span>
<span class="go">50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
<span class="go">60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
<span class="go">70: -- -- -- -- -- -- -- --</span>
</pre></div>
</div>
<p>Voila, everything there - one device at address <code class="docutils literal notranslate"><span class="pre">0x48</span></code>.</p>
</section>
<section id="using-the-device-talking-i2c-from-userspace">
<h2><a class="toc-backref" href="#id18">Using the Device: Talking I2C from Userspace</a><a class="headerlink" href="#using-the-device-talking-i2c-from-userspace" title="Permalink to this headline">¶</a></h2>
<p>Reading the <a class="reference download internal" download="" href="../../../../../../_downloads/f90d6d8d22f7ee8b75303d5e14de0cfe/Thermometer_LM73.pdf"><code class="xref download docutils literal notranslate"><span class="pre">datasheet</span></code></a> thoroughly
<a class="footnote-reference brackets" href="#datasheet-authors-mad" id="id3">4</a>, one can implement the device’s protocol in
userspace. On the <em>bus</em> device <code class="docutils literal notranslate"><span class="pre">/dev/i2c-1</span></code>, you kind of <em>connect</em>
to the device’s address (<code class="docutils literal notranslate"><span class="pre">0x48</span></code>), and send bytes back and forth.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text"><a class="reference download internal" download="" href="../../../../../../_downloads/d35a163815f8cbf651e544f2e54d6e3e/LM73.py"><code class="xref download docutils literal notranslate"><span class="pre">LM73.py</span></code></a></span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">fcntl</span><span class="o">,</span> <span class="nn">struct</span>

<span class="n">I2C_SLAVE</span> <span class="o">=</span> <span class="mh">0x0703</span> <span class="c1"># from &lt;linux/i2c-dev.h&gt;</span>

<span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/dev/i2c-1&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
<span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">I2C_SLAVE</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">msb_lsb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">msb</span><span class="p">,</span> <span class="n">lsb</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;BB&#39;</span><span class="p">,</span> <span class="n">msb_lsb</span><span class="p">)</span>
<span class="nb">print</span> <span class="nb">float</span><span class="p">((</span><span class="n">msb</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">lsb</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">))</span> <span class="o">/</span> <span class="mi">65535</span> <span class="o">/</span> <span class="mi">128</span>

</pre></div>
</div>
</div>
<p>Implementing the device’s protocol in userspace is always possible for
I2C devices. See <a class="reference external" href="https://www.kernel.org/doc/html/latest/i2c/dev-interface.html">the kernel documentation</a> for
detailed information - we are scratching only the surface here.</p>
<p>But this is rarely necessary because most devices are supported by
Linux out of the box, and LM73 is no exception.</p>
</section>
<section id="using-the-device-hwmon-hardware-monitoring">
<h2><a class="toc-backref" href="#id19">Using the Device: <code class="docutils literal notranslate"><span class="pre">hwmon</span></code> - Hardware Monitoring</a><a class="headerlink" href="#using-the-device-hwmon-hardware-monitoring" title="Permalink to this headline">¶</a></h2>
<p>The Linux kernel comes with <a class="reference external" href="https://github.com/torvalds/linux/blob/master/drivers/hwmon/lm73.c">a driver for LM73</a>
(<a class="reference external" href="https://www.kernel.org/doc/html/latest/hwmon/lm73.html">documentation</a>). Sadly,
Raspberry Pi OS does not package that driver, so you have to build
your own kernel for this.</p>
<section id="building-the-kernel-enabling-lm73">
<h3><a class="toc-backref" href="#id20">Building the Kernel, Enabling LM73</a><a class="headerlink" href="#building-the-kernel-enabling-lm73" title="Permalink to this headline">¶</a></h3>
<p>This is relatively easy; follow the <a class="reference external" href="https://www.raspberrypi.org/documentation/computers/linux_kernel.html#building">kernel build documentation</a>. In
short:</p>
<p>Install prerequisites (as root),</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt install git bc bison flex libssl-dev make libncurses-dev
</pre></div>
</div>
<p>Clone the kernel,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git clone https://github.com/raspberrypi/linux
<span class="gp">$ </span>git branch
<span class="go">* rpi-5.10.y</span>
</pre></div>
</div>
<p>Massage the configuration,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> linux
<span class="gp">$ </span>make bcm2711_defconfig
<span class="gp">$ </span>make menuconfig
</pre></div>
</div>
<p>Apply your changes in the following places:</p>
<ul class="simple">
<li><p><em>General Setup / Local version - append to kernel release</em>: add
something to differentiate your kernel from the prebuilt kernel. My
choice is <code class="docutils literal notranslate"><span class="pre">-v7l-jfasch</span></code>.</p></li>
<li><p><em>Device Drivers / Hardware Monitoring support / National
Semiconductor LM73</em>: build as module (”<code class="docutils literal notranslate"><span class="pre">M</span></code>”)</p></li>
</ul>
<p>Next, build the kernel. Time for coffee,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make -j4 zImage modules dtbs
</pre></div>
</div>
<p>Install the kernel, and reboot (as root),</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>make modules_install
<span class="gp"># </span>cp arch/arm/boot/dts/*.dtb /boot/
<span class="gp"># </span>cp arch/arm/boot/dts/overlays/*.dtb* /boot/overlays/
<span class="gp"># </span>cp arch/arm/boot/dts/overlays/README /boot/overlays/
<span class="gp"># </span>cp arch/arm/boot/zImage /boot/kernel7l.img
<span class="gp"># </span>reboot
</pre></div>
</div>
</section>
<section id="loading-the-driver">
<h3><a class="toc-backref" href="#id21">Loading the Driver</a><a class="headerlink" href="#loading-the-driver" title="Permalink to this headline">¶</a></h3>
<p>I2C is a simple protocol. PCI, at the other end of the protocol
complexity scale, supports automatic device identification via
<em>vendor</em> and <em>device</em> IDs, so device drivers can be automatically
loaded - <em>hotplugged</em>.</p>
<p>With I2C, we don’t have such luck: <em>we</em> know what type of device sits
on each address, and <em>we</em> have to supply that information to the
kernel - triggering a kind of a “fake hotplug”. Knowing that the
driver name is <code class="docutils literal notranslate"><span class="pre">lm73</span></code>, and the chip is on address <code class="docutils literal notranslate"><span class="pre">0x48</span></code>, as
<em>root</em> <a class="footnote-reference brackets" href="#why-root-for-hotplug" id="id4">3</a> do the following,</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">Announce LM73 on address <code class="docutils literal notranslate"><span class="pre">0x48</span></code></span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span><span class="nb">echo</span> lm73 0x48 &gt; /sys/bus/i2c/devices/i2c-1/new_device
</pre></div>
</div>
</div>
<p>Check that the driver has been loaded. (If you haven’t compiled the
kernel, or made any other mistake during the installation of it, then
the driver simply isn’t there and will silently <em>not</em> be loaded.)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>lsmod <span class="p">|</span> grep lm73
<span class="go">lm73                   16384  0</span>
</pre></div>
</div>
<p>Device up and running. Consequentially, the new device is represented
as a directory in <code class="docutils literal notranslate"><span class="pre">sysfs</span></code>,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls -l /sys/bus/i2c/devices/1-0048/
<span class="go">total 0</span>
<span class="go">-r--r--r-- 1 root root 4096 Oct  4 12:54 modalias</span>
<span class="go">-r--r--r-- 1 root root 4096 Oct  4 12:54 name</span>
<span class="go">drwxr-xr-x 2 root root    0 Oct  4 12:54 power</span>
<span class="go">lrwxrwxrwx 1 root root    0 Oct  4 12:54 subsystem -&gt; ../../../../../../bus/i2c</span>
<span class="go">-rw-r--r-- 1 root root 4096 Oct  4 12:53 uevent</span>
</pre></div>
</div>
</section>
<section id="hardware-monitoring-hwmon-devices">
<h3><a class="toc-backref" href="#id22">Hardware Monitoring (<code class="docutils literal notranslate"><span class="pre">hwmon</span></code>) Devices</a><a class="headerlink" href="#hardware-monitoring-hwmon-devices" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">/sys/bus/i2c/devices/1-0048/</span></code> represents the device as a generic
I2C device. A different aspect of LM73 is that it is a temperature
sensor. There is an entire framework inside the kernel, <code class="docutils literal notranslate"><span class="pre">hwmon</span></code>, to
cover such devices - no matter if they are Onewire or I2C (or …)
devices, or if they are reachable via a CPU internal bus.</p>
<p>As such - <em>a temperature sensor</em> - the device appears under an
alternative location under <code class="docutils literal notranslate"><span class="pre">/sysfs/class/hwmon/</span></code>, among other.</p>
<p>Prior to loading the driver, on the Raspberry there are two such
<code class="docutils literal notranslate"><span class="pre">hwmon</span></code> devices preinstalled; these apparently represent temperature
sensors that are built-in to the CPU, and which are enabled as part of
Linux’s Raspberry board support.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls -l /sys/class/hwmon/
<span class="go">total 0</span>
<span class="go">lrwxrwxrwx 1 root root 0 Nov 12 07:14 hwmon0 -&gt; ../../devices/virtual/thermal/thermal_zone0/hwmon0</span>
<span class="go">lrwxrwxrwx 1 root root 0 Nov 12 07:14 hwmon1 -&gt; ../../devices/platform/soc/soc:firmware/raspberrypi-hwmon/hwmon/hwmon1</span>
</pre></div>
</div>
<p>After we load the driver (remember, the <code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">lm73</span> <span class="pre">0x48</span> <span class="pre">&gt;</span> <span class="pre">...</span></code>
above), another symlink appears in <code class="docutils literal notranslate"><span class="pre">/sys/class/hwmon/</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls -l /sys/class/hwmon/
<span class="go">total 0</span>
<span class="go">lrwxrwxrwx 1 root root 0 Nov 12 07:14 hwmon0 -&gt; ../../devices/virtual/thermal/thermal_zone0/hwmon0</span>
<span class="go">lrwxrwxrwx 1 root root 0 Nov 12 07:14 hwmon1 -&gt; ../../devices/platform/soc/soc:firmware/raspberrypi-hwmon/hwmon/hwmon1</span>
<span class="go">lrwxrwxrwx 1 root root 0 Nov 12 07:36 hwmon2 -&gt; ../../devices/platform/soc/fe804000.i2c/i2c-1/1-0048/hwmon/hwmon2</span>

<span class="go">All these ``/sys/class/hwmon/hwmon*`` symlinks refer to directories</span>
<span class="go">in a different location in ``sysfs`` where the fun stuff is. Lets</span>
<span class="go">look at our sensor,</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls -l /sys/class/hwmon/hwmon2/
<span class="go">total 0</span>
<span class="go">lrwxrwxrwx 1 root root    0 Oct  5 08:57 device -&gt; ../../../1-0048</span>
<span class="go">-r--r--r-- 1 root root 4096 Oct  5 08:57 name</span>
<span class="go">drwxr-xr-x 2 root root    0 Oct  5 08:57 power</span>
<span class="go">lrwxrwxrwx 1 root root    0 Oct  5 08:57 subsystem -&gt; ../../../../../../../../class/hwmon</span>
<span class="go">-r--r--r-- 1 root root 4096 Oct  5 08:57 temp1_input</span>
<span class="go">-rw-r--r-- 1 root root 4096 Oct  5 08:57 temp1_max</span>
<span class="go">-r--r--r-- 1 root root 4096 Oct  5 08:57 temp1_max_alarm</span>
<span class="go">-rw-r--r-- 1 root root 4096 Oct  5 08:57 temp1_min</span>
<span class="go">-r--r--r-- 1 root root 4096 Oct  5 08:57 temp1_min_alarm</span>
<span class="go">-rw-r--r-- 1 root root 4096 Oct  5 08:56 uevent</span>
<span class="go">-rw-r--r-- 1 root root 4096 Oct  5 08:57 update_interval</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">temp1_input</span></code> is what contains information for us (the temperature
in milli-celsius):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat /sys/class/hwmon/hwmon2/temp1_input
<span class="go">22000</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li><p><strong>Question</strong>: how do I know that it’s my sensor in <code class="docutils literal notranslate"><span class="pre">hwmon2</span></code>?
<code class="docutils literal notranslate"><span class="pre">hwmon2</span></code> seems like a randomly/sequentially chosen name, and I
assume the order is not always the same across boots.</p></li>
<li><p><strong>Answer</strong>: correct. You can identify your sensor, though, by
looking at the <code class="docutils literal notranslate"><span class="pre">device</span></code> symlink,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls -l /sys/class/hwmon/hwmon2/device
<span class="go">lrwxrwxrwx 1 root root 0 Oct  5 08:57 /sys/class/hwmon/hwmon2/device -&gt; ../../../1-0048</span>
</pre></div>
</div>
<p>Apparently, the nomenclature is <code class="docutils literal notranslate"><span class="pre">&lt;bus&gt;-&lt;address&gt;</span></code>.</p>
</li>
</ul>
</div>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="config-uncomment"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>The line is already there, you only have to
uncomment it.</p>
</dd>
<dt class="label" id="config-txt-decadent-enough"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>The functionality that the Raspberry
bootloader (via <code class="docutils literal notranslate"><span class="pre">/boot/config.txt</span></code>)
brings is already decadent enough.</p>
</dd>
<dt class="label" id="why-root-for-hotplug"><span class="brackets"><a class="fn-backref" href="#id4">3</a></span></dt>
<dd><p>While members of group <code class="docutils literal notranslate"><span class="pre">i2c</span></code> are
permitted to <em>talk</em> to I2C devices, adding
devices is considered an administrative
task.</p>
</dd>
<dt class="label" id="datasheet-authors-mad"><span class="brackets"><a class="fn-backref" href="#id3">4</a></span></dt>
<dd><p>Beware, data sheet authors have a strange
kind of humor!</p>
</dd>
</dl>
</section>
</section>
</section>

<div class="section">
   
</div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2019-2021 (GPLv3), Jörg Faschingbauer.
      
      |
      <a href="../../../../../../_sources/trainings/material/soup/linux/hardware/i2c/topic.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>